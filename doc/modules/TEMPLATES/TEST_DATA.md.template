# <Module>模块测试数据规格

> **用途**: 定义模块的测试数据需求、Fixtures和Mock规则
> **维护者**: <维护者姓名>
> **创建时间**: <YYYY-MM-DD>
> **最后更新**: <YYYY-MM-DD>

---

## 概述

### 测试数据需求

**数据量级**:
- 最小集（minimal）: 用于单元测试，<10条记录
- 标准集（standard）: 用于集成测试，10-100条记录
- 完整集（full）: 用于性能测试，>1000条记录

**数据来源**:
- Fixtures（手工维护的精确数据）
- Mock（自动生成的随机数据）

---

## Fixtures定义

### 1. Fixtures概览

| 场景名称 | 文件路径 | 数据表 | 记录数 | 用途 |
|---------|---------|--------|--------|------|
| minimal | fixtures/minimal.sql | <table1> | 3 | 单元测试 |
|         |                      | <table2> | 2 | |
| standard | fixtures/standard.sql | <table1> | 50 | 集成测试 |
|          |                       | <table2> | 30 | |

### 2. Fixtures详细定义

#### 场景1: minimal（最小集）

**用途**: 单元测试、快速验证

**数据表**: `<table1>`
```yaml
records:
  - id: "test-001"
    name: "Test User 1"
    status: "active"
    created_at: "2024-01-01T00:00:00Z"
  
  - id: "test-002"
    name: "Test User 2"
    status: "inactive"
    created_at: "2024-01-02T00:00:00Z"
```

**数据表**: `<table2>`
```yaml
records:
  - id: "item-001"
    user_id: "test-001"
    title: "Sample Item"
    price: 99.99
```

**依赖关系**:
- `<table2>.user_id` → `<table1>.id`

**加载顺序**:
1. `<table1>`（先加载父表）
2. `<table2>`（后加载子表）

---

#### 场景2: standard（标准集）

**用途**: 集成测试、API测试

**数据分布**:
- `<table1>`: 50条记录
  - 40条 status="active"
  - 10条 status="inactive"
  - created_at: 过去30天内均匀分布
  
- `<table2>`: 30条记录
  - 每个user平均0.6条item
  - price: 10.00 到 1000.00之间

**数据特征**:
- 包含边界值测试数据
- 包含异常数据（空值、特殊字符）
- 时间分布接近真实场景

---

### 3. Fixtures文件结构

```
modules/<entity>/fixtures/
├── minimal.sql           # 最小集（SQL格式）
├── standard.sql          # 标准集（SQL格式）
├── full.sql              # 完整集（SQL格式，可选）
└── README.md             # Fixtures使用说明
```

### 4. Fixtures维护规范

**何时更新**:
- [ ] 添加新表时
- [ ] 修改表结构时
- [ ] 发现测试数据不足时

**更新流程**:
1. 修改Fixtures定义（本文档）
2. 更新对应的.sql文件
3. 运行`make load_fixture MODULE=<entity> FIXTURE=minimal`测试加载
4. 运行相关测试验证数据正确性
5. 提交变更

**注意事项**:
- Fixtures数据应该是确定的、可重复的
- 避免硬编码时间戳（使用相对时间）
- 保持数据量适中（单元测试<10条）

---

## Mock数据生成规则

### 1. Mock概览

Mock数据用于性能测试、压力测试、本地开发环境填充。

**生成方式**: 使用`scripts/mock_generator.py`自动生成

**生命周期**: 临时数据，测试后清理

### 2. Mock规则定义

#### 表: `<table1>`

```yaml
table: <table1>
count: 1000  # 生成1000条记录

columns:
  id:
    type: uuid
    generator: uuid4
  
  name:
    type: string
    generator: faker.name
    locale: zh_CN
  
  email:
    type: string
    generator: faker.email
    unique: true
  
  status:
    type: enum
    values: ["active", "inactive", "suspended"]
    distribution:
      active: 0.7
      inactive: 0.2
      suspended: 0.1
  
  created_at:
    type: timestamp
    generator: faker.date_time_between
    start_date: "-30d"
    end_date: "now"
```

#### 表: `<table2>`

```yaml
table: <table2>
count: 5000  # 生成5000条记录

columns:
  id:
    type: uuid
    generator: uuid4
  
  user_id:
    type: uuid
    generator: random_choice
    choices_from:
      table: <table1>
      column: id
  
  title:
    type: string
    generator: faker.sentence
    min_words: 3
    max_words: 10
  
  price:
    type: decimal
    generator: faker.pydecimal
    left_digits: 4
    right_digits: 2
    min_value: 10.00
    max_value: 9999.99
  
  created_at:
    type: timestamp
    generator: faker.date_time_between
    start_date: "-90d"
    end_date: "now"
```

### 3. Mock数据分布

**时间分布**:
- 创建时间: 最近90天
- 更新时间: 创建时间之后

**状态分布**:
- 70% active（活跃）
- 20% inactive（不活跃）
- 10% suspended（暂停）

**关系分布**:
- 每个user平均5条items
- 符合幂律分布（少数用户有大量items）

### 4. Mock生成命令

```bash
# 生成Mock数据
make generate_mock MODULE=<entity> COUNT=1000

# 清理Mock数据
make cleanup_mock MODULE=<entity>

# 查看Mock数据统计
make mock_stats MODULE=<entity>
```

---

## 测试场景映射

### 单元测试（Unit Tests）

**数据需求**: Fixtures - minimal
**加载方式**: 测试前加载，测试后清理
**数据量**: <10条记录
**目的**: 验证业务逻辑正确性

```python
# tests/<entity>/test_service.py
@pytest.fixture
def minimal_data(db):
    """加载最小Fixtures"""
    load_fixture("minimal")
    yield
    cleanup_fixture()
```

---

### 集成测试（Integration Tests）

**数据需求**: Fixtures - standard
**加载方式**: 测试类级别加载一次
**数据量**: 10-100条记录
**目的**: 验证模块间交互

```python
# tests/<entity>/test_integration.py
@pytest.fixture(scope="class")
def standard_data(db):
    """加载标准Fixtures"""
    load_fixture("standard")
    yield
    cleanup_fixture()
```

---

### 性能测试（Performance Tests）

**数据需求**: Mock - 大规模生成
**加载方式**: 测试前生成，测试后清理
**数据量**: >1000条记录
**目的**: 验证性能和扩展性

```bash
# 生成10000条测试数据
make generate_mock MODULE=<entity> TABLE=<table1> COUNT=10000

# 运行性能测试
pytest tests/<entity>/test_performance.py

# 清理
make cleanup_mock MODULE=<entity>
```

---

## 数据生命周期管理

### Fixtures生命周期

```
创建 → 版本控制 → 加载到测试DB → 测试运行 → 清理 → （保留Fixtures文件）
```

**特点**:
- Fixtures文件持久存储在repo中
- 测试数据临时存在于测试数据库
- 每次测试前重新加载

### Mock生命周期

```
定义规则 → 运行时生成 → 加载到测试DB → 测试运行 → 清理 → （不保留）
```

**特点**:
- Mock规则持久存储（本文档）
- Mock数据不存储，按需生成
- 测试后完全清理

---

## 环境配置

### 开发环境（dev）

**数据策略**: Fixtures - standard
**目的**: 本地开发、手工测试
**加载**: 一次性加载，手动刷新

```bash
make load_fixture MODULE=<entity> FIXTURE=standard ENV=dev
```

### 测试环境（test）

**数据策略**: 
- 单元测试: Fixtures - minimal
- 集成测试: Fixtures - standard
- 性能测试: Mock生成

**目的**: 自动化测试
**加载**: 每次测试前自动加载/清理

### 演示环境（demo）

**数据策略**: Fixtures - full 或 Mock生成
**目的**: 产品演示、培训
**加载**: 按需加载，定期刷新

```bash
make load_fixture MODULE=<entity> FIXTURE=full ENV=demo
```

---

## 依赖关系

### 上游依赖

本模块的测试数据依赖以下模块的Fixtures：

- `<upstream_module1>`: 需要其minimal fixtures
- `<upstream_module2>`: 需要其standard fixtures

**加载顺序**:
1. 先加载上游模块Fixtures
2. 再加载本模块Fixtures

### 下游影响

以下模块依赖本模块的测试数据：

- `<downstream_module1>`
- `<downstream_module2>`

**注意**: 修改本模块Fixtures时，需验证下游模块测试是否受影响

---

## 常见问题

### Q1: Fixtures和Mock如何选择？

**使用Fixtures**:
- 数据量小（<100条）
- 需要精确控制数据内容
- 单元测试、集成测试
- 需要可重复的测试结果

**使用Mock**:
- 数据量大（>1000条）
- 不关心具体数据内容
- 性能测试、压力测试
- 快速生成大量数据

### Q2: 如何更新Fixtures？

1. 修改本文档的Fixtures定义
2. 更新对应的.sql文件
3. 运行`make load_fixture`测试
4. 运行测试验证
5. 提交变更

### Q3: Mock数据会影响真实数据吗？

不会。Mock数据只生成到测试数据库，与生产数据库完全隔离。

### Q4: 测试后数据如何清理？

- 单元测试: pytest fixture自动清理
- 集成测试: teardown自动清理
- Mock数据: `make cleanup_mock`命令清理

---

## 相关文档

- **数据库规范**: /db/engines/postgres/docs/DB_SPEC.yaml
- **表结构定义**: /db/engines/postgres/schemas/tables/<table>.yaml
- **模块契约**: doc/CONTRACT.md
- **测试计划**: doc/TEST_PLAN.md

---

## 版本历史

- <YYYY-MM-DD>: v1.0 初始创建
- <YYYY-MM-DD>: 添加<table>的Mock规则
- <YYYY-MM-DD>: 更新standard fixtures

---

**维护责任**: 模块开发者
**审核责任**: 测试负责人
**更新频率**: 表结构变更时更新

