# 模块类型IO契约规范
# 版本: 1.0
# 用途: 定义每种模块类型的统一IO契约，确保同类型模块可替换
# 维护: 添加新类型时更新此文件

version: '1.0'
description: 模块类型的IO契约和关系定义

# 类型契约定义
type_contracts:
  # 类型1: Assign（分配型）
  - id: 1_Assign
    name: 分配型模块
    level_range: [1, 2]
    description: 为实体分配属性、执行单一职责的基础模块
    
    # 统一IO契约（所有此类型模块必须遵守）
    io_contract:
      inputs:
        - name: entity_id
          type: string
          required: true
          description: 实体唯一标识
          schema_ref: schemas/common/entity_id.yaml
          
        - name: action
          type: string
          required: true
          enum: [create, read, update, delete, list]
          description: 操作类型
          
        - name: payload
          type: object
          required: false
          description: 操作数据（create/update时需要）
          schema_ref: schemas/common/payload.yaml
      
      outputs:
        - name: result
          type: object
          required: true
          description: 操作结果
          schema_ref: schemas/common/result.yaml
          fields:
            - status: string  # success/error
            - data: object    # 实体数据
            - message: string # 说明信息
        
        - name: metadata
          type: object
          required: false
          description: 元数据
          fields:
            - timestamp: datetime
            - duration_ms: integer
    
    # 典型实例
    instances:
      - 1_user
      - 1_order
      - 1_product
    
    # 数据流向（此类型通常输出到哪些类型）
    typical_downstream:
      - 2_Select    # 输出给Select模块进行查询
      - 3_SelectMethod  # 输出给编排模块
      - 4_Aggregator    # 输出给聚合模块
    
    # 通常接收哪些类型的输入
    typical_upstream: []  # 基础模块，无上游
  
  # 类型2: Select（选择型）
  - id: 2_Select
    name: 选择型模块
    level_range: [1, 2]
    description: 从数据集中筛选/查询符合条件的数据
    
    io_contract:
      inputs:
        - name: query
          type: object
          required: true
          description: 查询条件
          schema_ref: schemas/common/query.yaml
          fields:
            - filters: object   # 筛选条件
            - sort: object      # 排序规则
            - pagination: object  # 分页参数
            
        - name: data_source
          type: string
          required: true
          description: 数据源标识
          
      outputs:
        - name: results
          type: array
          required: true
          description: 查询结果集
          schema_ref: schemas/common/results.yaml
          
        - name: total_count
          type: integer
          required: true
          description: 总记录数
    
    instances:
      - 2_user_query
      - 2_data_filter
      - 2_search
    
    typical_downstream:
      - 3_SelectMethod
      - 4_Aggregator
    
    typical_upstream:
      - 1_Assign  # 从Assign模块获取数据
  
  # 类型3: SelectMethod（方法选择型）
  - id: 3_SelectMethod
    name: 方法选择型模块
    level_range: [2, 3]
    description: 根据条件选择并执行不同的方法/策略
    
    io_contract:
      inputs:
        - name: context
          type: object
          required: true
          description: 上下文信息（用于决策）
          schema_ref: schemas/common/context.yaml
          
        - name: options
          type: array
          required: true
          description: 可选方法列表
          
      outputs:
        - name: selected_method
          type: string
          required: true
          description: 选中的方法ID
          
        - name: execution_result
          type: object
          required: false
          description: 执行结果（如直接执行）
          schema_ref: schemas/common/execution_result.yaml
    
    instances:
      - 3_payment_method
      - 3_shipping_method
      - 3_pricing_strategy
    
    typical_downstream:
      - 4_Aggregator
    
    typical_upstream:
      - 1_Assign
      - 2_Select
  
  # 类型4: Aggregator（聚合型）
  - id: 4_Aggregator
    name: 聚合型模块
    level_range: [3, 4]
    description: 聚合多个模块的输出，生成综合结果
    
    io_contract:
      inputs:
        - name: module_outputs
          type: array
          required: true
          description: 多个模块的输出数组
          schema_ref: schemas/common/multi_output.yaml
          item_schema:
            module_id: string
            output: object
            
      outputs:
        - name: aggregated_data
          type: object
          required: true
          description: 聚合后的数据
          schema_ref: schemas/common/aggregated.yaml
    
    instances:
      - 4_dashboard_aggregator
      - 4_report_aggregator
      - 4_business_overview
    
    typical_downstream: []  # 顶层模块，无下游
    
    typical_upstream:
      - 1_Assign
      - 2_Select
      - 3_SelectMethod

# 类型关系图
type_relations:
  description: 定义类型间的包含关系和数据流向
  
  # 层级关系
  hierarchy:
    Level_1:
      types: [1_Assign, 2_Select]
      description: 基础业务模块（叶子节点）
      downstream_levels: [2, 3, 4]
      
    Level_2:
      types: [1_Assign, 2_Select, 3_SelectMethod]
      description: 组合模块
      downstream_levels: [3, 4]
      
    Level_3:
      types: [3_SelectMethod, 4_Aggregator]
      description: 编排模块
      downstream_levels: [4]
      
    Level_4:
      types: [4_Aggregator]
      description: 聚合模块
      downstream_levels: []
  
  # 数据流向（类型A → 类型B）
  data_flows:
    - from: 1_Assign
      to: [2_Select, 3_SelectMethod, 4_Aggregator]
      description: 基础数据流向查询/编排/聚合
      
    - from: 2_Select
      to: [3_SelectMethod, 4_Aggregator]
      description: 查询结果流向编排/聚合
      
    - from: 3_SelectMethod
      to: [4_Aggregator]
      description: 方法执行结果流向聚合
  
  # 包含关系（可选，用于子类型）
  contains:
    # 示例：如果有细分类型
    # 1_Assign:
    #   subtypes:
    #     - 1_Assign_User: 用户管理
    #     - 1_Assign_Order: 订单管理
    #     - 1_Assign_Product: 产品管理
    []

# 替换规则
substitution_rules:
  description: 定义同类型模块的可替换性规则
  
  rules:
    - rule: same_type_substitution
      description: 同类型模块必须遵守相同的IO契约
      validation:
        - inputs_match: true  # 输入参数必须匹配
        - outputs_match: true  # 输出格式必须匹配
        - schema_compatible: true  # Schema必须兼容
      
    - rule: level_compatibility
      description: 同类型不同Level的模块替换规则
      conditions:
        - Level相同时可以直接替换
        - Level不同时需要评估依赖链
      
    - rule: contract_versioning
      description: IO契约版本管理
      guidelines:
        - 新增可选字段：兼容（minor版本）
        - 修改必需字段：不兼容（major版本）
        - 删除字段：不兼容（major版本）

# 验证规则
validation:
  # 注册新模块实例时的校验
  on_register:
    - check: type_exists
      description: 模块类型必须在type_contracts中定义
      
    - check: io_contract_match
      description: 模块的IO必须符合类型契约
      
    - check: level_in_range
      description: 模块的Level必须在类型允许的范围内
      
    - check: dependency_valid
      description: 依赖关系必须符合层级规则

# 使用说明
usage:
  create_new_type:
    description: 创建新的模块类型
    steps:
      - 在type_contracts中添加新类型定义
      - 定义IO契约（inputs/outputs）
      - 更新type_relations中的数据流向
      - 在MODULE_TYPES.md中添加文档说明
      - 运行make registry_check验证
      
  create_new_instance:
    description: 创建新的模块实例
    steps:
      - 选择合适的类型（参考MODULE_TYPES.md）
      - 确保IO遵守类型契约
      - 在agent.md中引用contracts路径
      - 在registry.yaml中注册
      - 运行make agent_lint验证

# 维护说明
maintenance:
  update_frequency: 添加新类型或修改契约时
  validation_command: make type_contract_check  # 已实现
  validation_script: scripts/type_contract_check.py
  related_files:
    - doc/modules/MODULE_TYPES.md  # 文档说明
    - doc/orchestration/registry.yaml  # 实例注册
    - schemas/  # Schema定义文件
    - scripts/type_contract_check.py  # 校验脚本

