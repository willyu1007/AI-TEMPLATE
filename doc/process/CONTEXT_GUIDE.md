# 模块上下文管理规范（AI优化版）

> **读者**: AI/智能编排系统  
> **用途**: 指导模块级上下文记录和恢复  
> **原则**: 轻量化、路由优先、记录错误、避免重复

---

## 1. 核心原则

### 1.1 轻量化优先
- ❌ 不创建冗余文档
- ❌ 不复制doc/已有内容  
- ✅ 仅记录关键决策和错误经验
- ✅ 使用路由而非长文档

### 1.2 路由优先
- ✅ 在agent.md中明确路由到.context/
- ✅ 目的明确：何时读、读什么
- ✅ 链路准确：路径清晰、文件存在

### 1.3 记录错误
- ✅ 记录走过的弯路
- ✅ 记录犯过的错误
- ✅ 记录为什么不采用某方案
- ✅ 避免AI重蹈覆辙

---

## 2. .context/精简结构

### 2.1 推荐结构（3个核心文件）

```
modules/<entity>/.context/
├── overview.md          # 必需：模块背景（<200行）
├── decisions.md         # 必需：设计决策+错误记录（持续追加）
└── prd.md              # 可选：原始需求（如有）
```

**说明**:
- 仅3个文件，最多200+200+?行
- 不需要requirements/和sessions/子目录（过度设计）
- decisions.md同时记录正确决策和错误经验

---

### 2.2 各文件用途

#### overview.md（必需，<200行）
**内容**:
1. 背景（2-3句话）
2. 目标（3-5个要点）
3. 关键约束（3-5个要点）

**禁止**:
- ❌ 长篇叙述
- ❌ 重复doc/CONTRACT.md的内容
- ❌ 详细的实现细节

---

#### decisions.md（必需，持续追加）
**内容**:
1. 正确决策（ADR格式）
2. **错误经验**（⭐ 重点）
3. 被否决的方案及原因

**格式**:
```markdown
## ADR-001: [决策标题]
**状态**: ✅采纳 / ❌否决 / ⚠️踩坑
**日期**: 2025-11-08

[如是踩坑，详细说明错误和教训]
```

---

#### prd.md（可选）
**何时创建**: 仅当有完整的外部PRD时

**内容**: 复制或链接到原始PRD

**禁止**: ❌ 自己编写PRD（应在plan.md中）

---

## 3. 在agent.md中的路由配置

### 3.1 推荐路由方式

在模块级agent.md的YAML Front Matter中：

```yaml
context_routes:
  on_demand:
    - topic: "模块背景和决策"
      paths:
        - .context/overview.md
        - .context/decisions.md
      when: "上下文丢失或需要了解模块历史时"
```

**说明**:
- 使用on_demand而非always_read
- 明确何时读取
- 路径清晰

---

### 3.2 在Markdown中简要说明

在模块级agent.md的Markdown部分（非YAML）：

```markdown
## 上下文恢复

**快速恢复**: `.context/overview.md` + `plan.md`  
**完整恢复**: 上述 + `.context/decisions.md`（含错误记录）

**详细规范**: `doc/process/CONTEXT_GUIDE.md`
```

---

## 4. 文档写入规范

### 4.1 何时写入

**必须写入**:
- ✅ 模块初始化：创建overview.md
- ✅ 重大决策：更新decisions.md
- ✅ **踩坑后**：在decisions.md中记录错误 ⭐

**不需要写入**:
- ❌ 日常开发（已有CHANGELOG.md）
- ❌ Bug修复（已有BUGS.md）
- ❌ 代码重构（已有CHANGELOG.md）

---

### 4.2 写什么内容

#### overview.md模板（<200行）

```markdown
# <模块名>概览

## 背景（2-3句话）
解决什么问题。

## 目标（3-5个要点）
1. 目标1
2. 目标2

## 关键约束（3-5个要点）
1. 约束1
2. 约束2
```

**禁止**:
- ❌ 超过200行
- ❌ 重复README.md内容
- ❌ 详细的技术细节

---

#### decisions.md模板（持续追加）

```markdown
# 设计决策与错误记录

## 正确决策

### ADR-001: [决策标题]
**状态**: ✅ 已采纳  
**日期**: 2025-11-08  
**决策**: [简述]  
**原因**: [简述]

---

## 错误经验（⭐ 重点）

### ERROR-001: [错误标题]
**状态**: ⚠️ 踩坑  
**日期**: 2025-11-08  
**错误**: [做了什么错误的事]  
**后果**: [导致什么问题]  
**教训**: [应该怎么做]  
**修复**: [如何修复的]

**避免**: AI不要再犯此错误

---

### REJECTED-001: [被否决方案]
**状态**: ❌ 已否决  
**方案**: [简述]  
**原因**: [为什么不行]
```

---

## 5. 清理规则

### 5.1 清理触发

- 每季度清理一次
- 文件数>5个时清理

### 5.2 清理标准

**删除**:
- 超过6个月的临时记录
- 无效的链接和信息

**保留**:
- overview.md（始终保留）
- decisions.md（始终保留，但可归档旧条目）
- 错误记录（⭐ 永久保留）

---

## 6. 路由规范

### 6.1 路由配置示例

```yaml
# 模块级agent.md

context_routes:
  on_demand:
    - topic: "模块背景"
      paths: [".context/overview.md"]
      when: "首次接触模块或长时间中断"
    
    - topic: "设计决策和错误经验"
      paths: [".context/decisions.md"]
      when: "需要了解技术选型或避免重复错误"
    
    - topic: "原始需求"
      paths: [".context/prd.md"]
      when: "需要查看完整PRD时"
```

---

## 7. 错误记录规范（⭐ 重点）

### 7.1 为什么记录错误

**目的**: AI避免重蹈覆辙

**价值**:
- 节省时间（不重复犯错）
- 积累经验（错误即知识）
- 提供上下文（为什么这样做）

---

### 7.2 错误记录格式

```markdown
### ERROR-001: [简短标题，<50字]

**日期**: 2025-11-08  
**错误**: 做了什么错误的事（1-2句话）  
**后果**: 导致什么问题（1-2句话）  
**教训**: 应该怎么做（1-2句话）  
**修复**: 如何修复的（1-2句话）

**AI注意**: [给AI的明确警告，1句话]
```

**示例**:
```markdown
### ERROR-001: 直接删除旧字段导致数据丢失

**日期**: 2025-11-08  
**错误**: 迁移时直接DROP COLUMN，未做数据备份  
**后果**: 用户历史数据丢失，无法恢复  
**教训**: 应先创建备份表或导出数据  
**修复**: 从备份恢复（幸好有）

**AI注意**: 删除字段前必须先备份数据！
```

---

## 8. 与doc/的明确区分

| 维度 | doc/ | .context/ |
|------|------|-----------|
| 用途 | 技术文档 | 背景和历史 |
| 内容 | 怎么用（How） | 为什么（Why） |
| 路由 | ✅ on_demand频繁 | ⏳ on_demand偶尔 |
| 更新 | 按需更新 | 持续追加 |

---

## 9. 集成到MODULE_INIT_GUIDE

### 9.1 Phase 8简化

**目标**: 创建3个核心文件

**步骤**:
1. 创建.context/目录
2. 生成overview.md模板（<200行）
3. 生成decisions.md模板（空）
4. 在agent.md中配置路由
5. （可选）复制PRD为prd.md

**时间**: 5-10分钟

---

### 9.2 AI引导对话（精简）

```
AI: 创建上下文恢复机制。

Q1: 模块背景？（2-3句话）
Q2: 核心目标？（3-5个要点）
Q3: 关键约束？（3-5个要点）
Q4: 是否有原始PRD？（有→复制，无→跳过）

创建：
  ✓ .context/overview.md
  ✓ .context/decisions.md
  ✓ agent.md路由配置

完成！
```

---

## 10. 最佳实践

### DO ✅
- ✅ 保持精简（<200行/文件）
- ✅ 使用路由（不要写太多内容在agent.md）
- ✅ 记录错误（⭐ 重要）
- ✅ 定期清理

### DON'T ❌
- ❌ 创建过多子目录
- ❌ 重复doc/内容
- ❌ 长篇叙述
- ❌ 忘记记录错误

---

## 11. 错误记录清单（模块级）

**记录这些错误**:
- 数据库设计错误（字段类型、索引）
- API设计错误（接口不合理）
- 依赖选择错误（库不合适）
- 性能问题（未优化导致问题）
- 安全漏洞（权限、注入等）

**格式**: 统一使用ERROR-XXX编号

---

## 12. 快速参考

**创建**: 
```bash
mkdir .context/
echo "## 背景\n..." > .context/overview.md
echo "# 设计决策\n..." > .context/decisions.md
```

**路由**: 在agent.md的context_routes.on_demand中配置

**写入**: 重大决策后、踩坑后

**清理**: 每季度

---

**规范版本**: v1.0  
**最后更新**: 2025-11-08
