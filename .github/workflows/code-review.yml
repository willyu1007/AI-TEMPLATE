name: Code Review - ä»£ç å®¡æŸ¥

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ============================================
  # Repo ç²’åº¦å®¡æŸ¥ï¼ˆæ¶æ„çº§ï¼‰
  # ============================================
  repo-level-review:
    name: Repo çº§å®¡æŸ¥ï¼ˆæ¶æ„ï¼‰
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²ç”¨äºå¯¹æ¯”
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: å®‰è£…ä¾èµ–
        run: pip install -r requirements.txt
      
      - name: æ¶æ„ä¸€è‡´æ€§ - DAG æ ¡éªŒ
        run: make dag_check
      
      - name: ç³»ç»Ÿè¾¹ç•Œ - å¥‘çº¦å…¼å®¹æ€§
        run: make contract_compat_check
        continue-on-error: true
      
      - name: æ•°æ®åº“ - è¿ç§»è„šæœ¬æ£€æŸ¥
        run: make migrate_check
      
      - name: é…ç½® - Schema æ ¡éªŒ
        run: make runtime_config_check
      
      - name: æ–‡æ¡£å®Œæ•´æ€§
        run: make consistency_check

  # ============================================
  # æ¨¡å—ç²’åº¦å®¡æŸ¥ï¼ˆæ¨¡å—çº§ï¼‰
  # ============================================
  module-level-review:
    name: æ¨¡å—çº§å®¡æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: æ¨¡å—æ–‡æ¡£é½å…¨æ€§
        run: make consistency_check
      
      - name: æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥
        run: |
          if [ -d "tests" ] && [ "$(ls -A tests)" ]; then
            pytest tests/ --cov=modules --cov-fail-under=70 --cov-report=term-missing
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æµ‹è¯•æ–‡ä»¶"
          fi
      
      - name: ä¾èµ–æ£€æŸ¥
        run: |
          python scripts/deps_manager.py || true

  # ============================================
  # åŠŸèƒ½ç²’åº¦å®¡æŸ¥ï¼ˆä»£ç çº§ï¼‰
  # ============================================
  code-level-review:
    name: ä»£ç çº§å®¡æŸ¥ï¼ˆåŠŸèƒ½ï¼‰
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: å®‰è£…ä»£ç è´¨é‡å·¥å…·
        run: |
          pip install pylint mypy bandit radon
      
      - name: ä»£ç é£æ ¼æ£€æŸ¥ï¼ˆPylintï¼‰
        run: |
          pylint modules/ --exit-zero --output-format=text | tee pylint-report.txt
      
      - name: ç±»å‹æ£€æŸ¥ï¼ˆMypyï¼‰
        run: |
          mypy modules/ --ignore-missing-imports || true
      
      - name: å®‰å…¨æ‰«æï¼ˆBanditï¼‰
        run: |
          bandit -r modules/ -f json -o bandit-report.json
          bandit -r modules/ || true
      
      - name: ä»£ç å¤æ‚åº¦åˆ†æï¼ˆRadonï¼‰
        run: |
          echo "=== åœˆå¤æ‚åº¦ ==="
          radon cc modules/ -a -nb
          echo ""
          echo "=== å¯ç»´æŠ¤æ€§æŒ‡æ•° ==="
          radon mi modules/ -nb
      
      - name: ä¸Šä¼ åˆ†ææŠ¥å‘Š
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: code-quality-reports
          path: |
            pylint-report.txt
            bandit-report.json

  # ============================================
  # PR è¯„è®ºæ‘˜è¦
  # ============================================
  pr-summary:
    name: PR è¯„è®ºæ‘˜è¦
    needs: [repo-level-review, module-level-review, code-level-review]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: ç”Ÿæˆ PR æ‘˜è¦
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const comment = `
            ## ğŸ¤– è‡ªåŠ¨åŒ–ä»£ç å®¡æŸ¥æ‘˜è¦
            
            ### âœ… æ£€æŸ¥çŠ¶æ€
            - Repo çº§å®¡æŸ¥ï¼š${{ needs.repo-level-review.result }}
            - æ¨¡å—çº§å®¡æŸ¥ï¼š${{ needs.module-level-review.result }}
            - ä»£ç çº§å®¡æŸ¥ï¼š${{ needs.code-level-review.result }}
            
            ### ğŸ“Š å®¡æŸ¥ç²’åº¦
            æ ¹æ® \`agent.md\` Â§11 ä»£ç å®¡æŸ¥æµç¨‹ï¼š
            - ğŸ—ï¸ **Repo çº§**ï¼šæ¶æ„ä¸€è‡´æ€§ã€å¥‘çº¦å…¼å®¹ã€æ•°æ®åº“è¿ç§»
            - ğŸ“¦ **æ¨¡å—çº§**ï¼šæ–‡æ¡£é½å…¨ã€æµ‹è¯•è¦†ç›–ã€ä¾èµ–ç®¡ç†
            - âš™ï¸ **ä»£ç çº§**ï¼šæ¥å£è®¾è®¡ã€ä»£ç è´¨é‡ã€å®‰å…¨æ€§èƒ½
            
            ### ğŸ’¡ ä¸‹ä¸€æ­¥
            1. æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šï¼š[Actions é¡µé¢](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. ä¿®å¤ä»»ä½•å¤±è´¥çš„æ£€æŸ¥
            3. ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
            4. è¯·æ±‚äººå·¥å®¡æŸ¥
            
            ---
            _è‡ªåŠ¨ç”Ÿæˆ by Agent Repo CI_
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

# ============================================
# ç¯å¢ƒå˜é‡é…ç½®
# ============================================
env:
  # Python
  PYTHONUNBUFFERED: 1
  
  # æµ‹è¯•ç¯å¢ƒ
  APP_ENV: test
  
  # è¦†ç›–ç‡è¦æ±‚
  MIN_COVERAGE: 70

