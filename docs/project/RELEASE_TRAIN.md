# 发布列车 [模板]

> 定义项目的发布节奏、流程和策略

## 目标
建立规律的发布节奏，确保质量和可预测性，降低发布风险。

## 适用场景
- 生产环境发布
- 版本管理
- 紧急修复（Hot Fix）

## 使用说明
1. 根据团队实际情况调整发布节奏
2. 明确各环节的时间节点和责任人
3. 定期复盘和优化流程
4. 与 DoR/DoD 保持一致

---

## 发布节奏

### 主版本发布（Major Release）
- **频率**：每 6-12 个月
- **包含**：重大功能、架构升级、破坏性变更
- **审批**：需要技术委员会批准

### 次版本发布（Minor Release）
- **频率**：每 2-4 周
- **包含**：新功能、功能增强
- **审批**：技术负责人批准

### 补丁发布（Patch Release）
- **频率**：按需（Bug 修复）
- **包含**：Bug 修复、安全补丁
- **审批**：快速通道（15分钟内）

---

## 发布列车时间表

### 标准列车（每两周一班）
```
周一     周二     周三     周四     周五
------------------------------------ Week 1
开发     开发     开发     代码冻结  QA测试
Feature  Feature  Feature  
开发     开发     开发

------------------------------------ Week 2
QA测试   QA测试   预发布   发布     监控
回归     回归     staging  PROD     观察
测试     测试     验证     部署     修复
```

### 快速列车（Hot Fix）
```
发现Bug → 修复 → 测试 → 发布
 (0h)    (2h)   (1h)   (1h)
         
总时长：4 小时内
```

---

## 发布流程

### 1. 代码冻结（Code Freeze）
**时间**：每周四 18:00

**动作**：
```bash
# 1. 创建 release 分支
git checkout -b release/v1.2.0

# 2. 锁定版本号
vim package.json  # 或其他版本文件
git commit -m "chore: bump version to 1.2.0"

# 3. 运行完整检查
make dev_check
make rollback_check PREV_REF=v1.1.0

# 4. 生成 CHANGELOG
# 合并自上次发布以来的所有 CHANGELOG
```

**禁止**：
- ❌ 新功能合入
- ❌ 非紧急重构
- ✅ 仅允许：Bug 修复、文档更新

---

### 2. QA 测试（周四-周五）
**测试环境**：Staging

**测试清单**：
```markdown
- [ ] 冒烟测试（核心功能）
- [ ] 回归测试（已有功能）
- [ ] 性能测试（关键路径）
- [ ] 安全测试（OWASP Top 10）
- [ ] 兼容性测试（浏览器/设备）
- [ ] 用户验收测试（UAT）
```

**Bug 处理**：
- **Critical**：立即修复，重新测试
- **High**：本次发布前修复
- **Medium/Low**：记录到下个版本

---

### 3. 预发布（周三）
**部署到 Staging**：
```bash
# 1. 部署
./deploy.sh staging release/v1.2.0

# 2. 验证
curl https://staging.example.com/health
make smoke_test ENV=staging

# 3. 数据迁移演练
psql -h staging-db -f migrations/XXX_up.sql

# 4. 回滚演练
psql -h staging-db -f migrations/XXX_down.sql
```

**Staging 验证清单**：
```markdown
- [ ] 应用启动正常
- [ ] 数据库迁移成功
- [ ] 核心 API 可访问
- [ ] 前端页面正常
- [ ] 定时任务运行正常
- [ ] 监控指标正常
```

---

### 4. 生产发布（周四）
**时间窗口**：周四 10:00-12:00（低流量时段）

**发布步骤**：
```bash
# 1. 发布公告
# 发送邮件/公告通知用户

# 2. 备份数据
./backup.sh production

# 3. 执行数据库迁移
psql -h prod-db -f migrations/XXX_up.sql

# 4. 部署应用（灰度发布）
./deploy.sh production release/v1.2.0 --canary=10%
# 等待 10 分钟观察
./deploy.sh production release/v1.2.0 --canary=50%
# 等待 10 分钟观察
./deploy.sh production release/v1.2.0 --canary=100%

# 5. 验证
make smoke_test ENV=production
curl https://api.example.com/health

# 6. 监控
# 观察 Grafana 仪表板 30 分钟
```

**回滚决策点**：
- 错误率 > 1%：立即回滚
- P95 延迟 > 2x 基线：立即回滚
- 5xx 错误持续 5 分钟：立即回滚

---

### 5. 发布后监控（周四-周五）
**监控时长**：发布后 48 小时

**监控指标**：
```yaml
应用指标：
  - 错误率
  - 响应时间（P50/P95/P99）
  - QPS
  - 5xx/4xx 错误数

业务指标：
  - 关键功能使用量
  - 用户活跃度
  - 转化率

基础设施：
  - CPU/内存使用率
  - 数据库连接数
  - 缓存命中率
```

**告警响应**：
- P0（紧急）：15 分钟内响应
- P1（高）：1 小时内响应
- P2（中）：4 小时内响应

---

## 回滚流程

### 触发条件
- 严重 Bug 影响核心功能
- 错误率异常升高
- 性能严重下降
- 数据安全问题

### 回滚步骤
```bash
# 1. 决策（技术负责人批准）
# 评估：影响范围、回滚风险

# 2. 数据库回滚
psql -h prod-db -f migrations/XXX_down.sql

# 3. 应用回滚
./deploy.sh production v1.1.0  # 上一个稳定版本

# 4. 验证
make smoke_test ENV=production

# 5. 通知
# 发送回滚通知

# 6. 复盘
# 创建事故报告
```

**回滚时间目标**：
- 决策：15 分钟
- 执行：30 分钟
- 验证：15 分钟
- **总计**：1 小时内完成

---

## 版本管理

### 版本号规范（Semver）
```
格式：MAJOR.MINOR.PATCH

示例：
- 1.0.0 → 1.0.1  (Bug 修复)
- 1.0.1 → 1.1.0  (新功能)
- 1.1.0 → 2.0.0  (破坏性变更)
```

### 分支策略
```
main (protected)     # 生产环境
  ↑
release/v1.2.0       # 发布分支（冻结）
  ↑
develop (protected)  # 开发主分支
  ↑
feature/*            # 功能分支
hotfix/*             # 紧急修复分支
```

### Tag 管理
```bash
# 发布时打 tag
git tag -a v1.2.0 -m "Release version 1.2.0"
git push origin v1.2.0

# Tag 命名规范
v1.2.0          # 正式版本
v1.2.0-rc.1     # Release Candidate
v1.2.0-beta.1   # Beta 版本
v1.2.0-alpha.1  # Alpha 版本
```

---

## 发布清单

### 发布前检查
```markdown
- [ ] 所有测试通过（make dev_check）
- [ ] 代码审查完成
- [ ] CHANGELOG 已更新
- [ ] 版本号已更新
- [ ] 数据库迁移脚本已准备
- [ ] 回滚脚本已验证
- [ ] Staging 环境验证通过
- [ ] 监控告警已配置
- [ ] 备份已完成
- [ ] 发布公告已准备
```

### 发布后验证
```markdown
- [ ] 应用启动正常
- [ ] 健康检查通过
- [ ] 核心功能可用
- [ ] 监控指标正常
- [ ] 无异常告警
- [ ] 用户反馈正常
```

---

## 紧急情况处理

### 生产环境事故
**流程**：
1. **识别**：监控告警或用户报告
2. **评估**：影响范围、严重程度
3. **决策**：修复 or 回滚
4. **执行**：快速通道（Hot Fix）
5. **验证**：功能恢复确认
6. **复盘**：事后分析和改进

### 事故等级
| 等级 | 影响 | 响应时间 | 处理策略 |
|------|------|---------|---------|
| P0 | 系统不可用 | 15分钟 | 立即回滚 |
| P1 | 核心功能受损 | 1小时 | Hot Fix or 回滚 |
| P2 | 部分功能异常 | 4小时 | 计划修复 |
| P3 | 轻微影响 | 1天 | 下个版本修复 |

---

## 发布沟通

### 内部沟通
- **发布计划**：提前 1 周通知团队
- **代码冻结**：提前 1 天通知
- **发布窗口**：提前 1 天最终确认

### 外部沟通
- **功能预告**：提前 1 周发布博客/公告
- **维护通知**：提前 24 小时通知用户
- **发布说明**：发布当天发布 Release Notes

---

## 变更记录

| 日期 | 版本 | 变更说明 | 作者 |
|------|------|---------|------|
| 2025-11-04 | 1.0 | 初始版本 | [姓名] |

---

**填写指导**：
1. 根据团队实际情况调整发布节奏
2. 定义清晰的回滚决策标准
3. 明确各个角色的职责
4. 定期复盘和优化流程
5. 保持灵活性，根据项目阶段调整

**相关文档**：
- `agent.md` §10.5 - PR 规则
- `docs/process/DoR_DoD.md` - 完成定义
- `modules/*/RUNBOOK.md` - 各模块运维手册
