# 架构决策记录

## 目标
记录项目中的重大架构决策，包括决策背景、考虑的方案、最终选择及其理由，便于团队理解设计思路和未来维护。

## 适用场景
- 选择技术栈（数据库、框架、工具链）
- 定义系统架构模式（微服务、单体、事件驱动等）
- 制定关键设计原则（数据一致性、性能优化策略等）
- 引入新的依赖或工具
- 修改核心接口或数据结构

## 前置条件
- 决策已确定并实施
- 相关文档已更新

---

## ADR 格式规范

### 文件命名
```
docs/adr/
├── README.md              # 本文件
├── template.md            # ADR 模板
├── 001-use-postgresql.md
├── 002-adopt-dag-architecture.md
└── 003-use-semver-versioning.md
```

**命名规则**：
- 使用三位数字编号：`001`, `002`, `003`...
- 使用小写字母和连字符：`use-postgresql.md`
- 保持简短和描述性

---

## ADR 模板

### 标准模板
```markdown
# ADR-001: [决策标题]

## 状态
[提议 | 已采纳 | 已弃用 | 已替代]

## 上下文
[描述决策的背景和问题]

## 决策
[说明最终选择的方案]

## 考虑的方案

### 方案 A: [方案名称]
**优点**：
- 优点1
- 优点2

**缺点**：
- 缺点1
- 缺点2

### 方案 B: [方案名称]
**优点**：
- 优点1

**缺点**：
- 缺点1

## 决策理由
[说明为什么选择此方案，考虑因素包括：成本、风险、团队技能、维护性等]

## 后果

### 正面影响
- 影响1
- 影响2

### 负面影响
- 影响1
- 影响2

### 需要关注
- 需要定期评估的点

## 相关决策
- ADR-XXX: [相关决策标题]

## 更新记录
- YYYY-MM-DD: 初始创建
- YYYY-MM-DD: 更新状态为"已替代"
```

---

## ADR 示例

### ADR-001: 使用 PostgreSQL 作为主数据库

```markdown
# ADR-001: 使用 PostgreSQL 作为主数据库

## 状态
已采纳

## 上下文
项目需要选择主数据库，需要支持：
- 复杂查询和关联
- 事务一致性
- JSON 数据存储
- 全文搜索
- 高可用性

## 决策
使用 PostgreSQL 14+ 作为主数据库。

## 考虑的方案

### 方案 A: PostgreSQL
**优点**：
- 功能强大，支持复杂查询
- ACID 事务保证
- JSONB 支持
- 成熟稳定，社区活跃
- 支持全文搜索（tsvector）

**缺点**：
- 水平扩展相对复杂
- 需要专业运维知识

### 方案 B: MySQL
**优点**：
- 使用广泛，文档丰富
- 运维简单

**缺点**：
- JSON 支持较弱
- 复杂查询性能一般
- 全文搜索功能有限

### 方案 C: MongoDB
**优点**：
- 水平扩展容易
- JSON 原生支持

**缺点**：
- 事务支持较弱（虽然 4.0+ 支持）
- 复杂查询性能一般
- 数据一致性保证较弱

## 决策理由
1. **功能需求**：需要 JSON 存储和全文搜索，PostgreSQL 的 JSONB 和 tsvector 完全满足
2. **数据一致性**：业务对数据一致性要求高，PostgreSQL 的 ACID 保证更可靠
3. **团队技能**：团队对 PostgreSQL 更熟悉
4. **未来扩展**：PostgreSQL 的扩展性（如 PostGIS）为未来需求预留空间

## 后果

### 正面影响
- 支持复杂业务查询，减少应用层逻辑
- JSONB 提供灵活的 schema 扩展
- 全文搜索功能满足搜索需求

### 负面影响
- 需要专业的数据库运维知识
- 水平扩展需要额外方案（如分库分表或 Citus）

### 需要关注
- 定期评估数据库性能
- 监控连接池和查询性能
- 评估是否需要引入读写分离

## 相关决策
- ADR-002: 采用 DAG 架构
- ADR-003: 使用 Semver 版本控制

## 更新记录
- 2025-11-05: 初始创建
```

---

## ADR 管理流程

### 创建新 ADR

1. **确定需要记录**
   ```bash
   # 判断标准：
   # - 影响多个模块
   # - 影响系统架构
   # - 引入新的技术栈
   # - 修改核心接口
   ```

2. **创建 ADR 文件**
   ```bash
   # 获取下一个编号
   ls docs/adr/*.md | wc -l
   
   # 创建文件
   cp docs/adr/template.md docs/adr/XXX-decision-title.md
   ```

3. **填写内容**
   - 使用模板格式
   - 详细记录考虑的方案
   - 说明决策理由

4. **提交 PR**
   ```bash
   # PR 标题：docs(adr): 添加 ADR-XXX 决策记录
   # 包含在相关功能 PR 中，或单独提交
   ```

---

## 验证步骤

### 文档完整性检查
```bash
# 1. 检查所有 ADR 格式正确
python scripts/check_adr_format.py

# 2. 检查编号连续性
ls docs/adr/*.md | sort -V
```

---

## 维护指南

### 更新 ADR 状态

当决策发生变化时：

1. **更新状态**
   ```markdown
   ## 状态
   已替代（被 ADR-XXX 替代）
   ```

2. **添加替代说明**
   ```markdown
   ## 替代说明
   本决策已被 ADR-XXX 替代，原因：[说明]
   ```

3. **保留历史**
   - 不要删除旧 ADR
   - 在相关新 ADR 中引用旧决策

---

## 相关文档
- 系统边界：`docs/project/SYSTEM_BOUNDARY.md`
- 技术规范：`docs/process/CONVENTIONS.md`
- 架构指南：`agent.md` §4

