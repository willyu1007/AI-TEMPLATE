#!/usr/bin/env bash
set -euo pipefail

echo "ğŸ” å¼€å§‹å®Œæ•´éªŒè¯æµç¨‹..."
echo ""

FAILED=0

# [1/7] å¥‘çº¦å­˜åœ¨æ€§ä¸ JSON æ ¡éªŒ
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "[1/7] å¥‘çº¦å­˜åœ¨æ€§ä¸ JSON æ ¡éªŒ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if test -f tools/codegen/contract.json; then
    echo "âœ“ å¥‘çº¦æ–‡ä»¶å­˜åœ¨"
    if python - <<'PY'
import json, sys
try:
    json.load(open('tools/codegen/contract.json'))
    print("âœ“ contract.json è§£ææˆåŠŸ")
except Exception as e:
    print(f"âŒ contract.json è§£æå¤±è´¥: {e}")
    sys.exit(1)
PY
    then
        echo "âœ“ å¥‘çº¦ JSON æ ¡éªŒé€šè¿‡"
    else
        FAILED=1
    fi
else
    echo "âŒ å¥‘çº¦æ–‡ä»¶ä¸å­˜åœ¨"
    FAILED=1
fi
echo ""

# [2/7] DAG æ ¡éªŒ
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "[2/7] DAG æ ¡éªŒ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if python scripts/dag_check.py; then
    echo ""
else
    FAILED=1
    echo ""
fi

# [3/7] å¥‘çº¦å…¼å®¹æ€§æ£€æŸ¥
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "[3/7] å¥‘çº¦å…¼å®¹æ€§æ£€æŸ¥"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if python scripts/contract_compat_check.py; then
    echo ""
else
    FAILED=1
    echo ""
fi

# [4/7] è¿è¡Œæ—¶é…ç½®æ ¡éªŒ
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "[4/7] è¿è¡Œæ—¶é…ç½®æ ¡éªŒ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if python scripts/runtime_config_check.py; then
    echo ""
else
    FAILED=1
    echo ""
fi

# [5/7] è¿ç§»è„šæœ¬æ£€æŸ¥
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "[5/7] è¿ç§»è„šæœ¬æ£€æŸ¥"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if python scripts/migrate_check.py; then
    echo ""
else
    FAILED=1
    echo ""
fi

# [6/7] ä¸€è‡´æ€§æ£€æŸ¥
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "[6/7] ä¸€è‡´æ€§æ£€æŸ¥"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if python scripts/consistency_check.py; then
    echo ""
else
    FAILED=1
    echo ""
fi

# [7/7] DB è§„èŒƒå­˜åœ¨
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "[7/7] DB è§„èŒƒå­˜åœ¨æ€§"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if test -f docs/db/DB_SPEC.yaml; then
    echo "âœ“ DB_SPEC.yaml å­˜åœ¨"
else
    echo "âŒ DB_SPEC.yaml ä¸å­˜åœ¨"
    FAILED=1
fi
echo ""

# æ€»ç»“
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ $FAILED -eq 0 ]; then
    echo "âœ… æ‰€æœ‰éªŒè¯é€šè¿‡"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    exit 0
else
    echo "âŒ éªŒè¯å¤±è´¥"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    exit 1
fi
