# AI工作流模式：模块创建
# 此文件为AI优化文档，轻量化设计（约250行）
# 人类完整参考：../examples/module-creation-example.md

pattern_id: "module-creation"
version: "1.0"
name: "模块创建标准工作流"
description: "从需求到上线的完整模块开发流程"
complexity: "medium"          # low|medium|high
estimated_time: "2-4 hours"
ai_optimized: true           # AI文档标记
category: "development"       # development|maintenance|optimization|debugging

# 前置条件（简洁）
prerequisites:
  - "已有清晰的模块需求（功能边界、数据流向）"
  - "已确定模块类型（参考MODULE_TYPES.md）"
  - "了解项目结构和开发规范"

# 工作流步骤（AI执行）
workflow:
  - step: 1
    name: "需求分析与规划"
    description: "分析需求，生成plan.md"
    estimated_time: "30-45分钟"
    
    ai_prompt_template: |
      我需要创建{module_type}类型的模块：{module_name}
      需求：{requirements}
      请帮我：
      1. 分析模块职责和边界
      2. 确定依赖关系（upstream/downstream）
      3. 设计数据流（inputs/outputs）
      4. 生成plan.md（包含目标、技术栈、阶段）
    
    triggers:
      - "module-development"
    
    documents_to_load:
      - path: /doc/modules/MODULE_INIT_GUIDE.md
        priority: critical
        type: main
      - path: /doc/modules/resources/init-planning.md
        priority: high
        type: resource
      - path: /doc/modules/MODULE_TYPES.md
        priority: high
      - path: /doc/modules/MODULE_TYPE_CONTRACTS.yaml
        priority: medium
    
    expected_output:
      - "modules/{module_name}/plan.md"
      - "明确的模块边界和依赖关系"
    
    validation:
      - "plan.md包含目标、技术栈、实施阶段"
      - "明确输入输出和数据流向"
      - "无模糊或矛盾表述"
    
    common_issues:
      - issue: "模块职责不清，边界模糊"
        solution: "参考MODULE_TYPES.md决策树，明确模块分类"
      - issue: "依赖关系复杂，层级不清"
        solution: "绘制依赖图，检查是否有循环依赖"
      - issue: "数据流设计不合理"
        solution: "参考MODULE_TYPE_CONTRACTS.yaml中的IO契约示例"

  - step: 2
    name: "目录结构创建"
    description: "创建标准模块目录和必需文件"
    estimated_time: "15-20分钟"
    
    ai_prompt_template: |
      基于plan.md，为{module_name}模块创建目录结构
      模块类型：{module_type}
      是否需要HTTP接口：{has_api}
      是否需要前端组件：{has_frontend}
    
    documents_to_load:
      - path: /doc/modules/resources/init-directory.md
        priority: critical
      - path: /doc/modules/example/README.md
        priority: high
    
    expected_output:
      - "modules/{module_name}/core/"
      - "modules/{module_name}/api/ (如需要)"
      - "modules/{module_name}/frontend/ (如需要)"
      - "modules/{module_name}/models/ (如需要)"
      - "modules/{module_name}/README.md"
    
    validation:
      - "core/目录必须存在"
      - "api/和frontend/根据需要创建"
      - "README.md包含'目录结构'章节"
    
    common_issues:
      - issue: "不确定是否需要api/目录"
        solution: "问自己：该模块是否对外提供HTTP接口？如只是内部函数调用，不需要"
      - issue: "不确定是否需要frontend/目录"
        solution: "问自己：该模块是否有特定的前端页面/组件？如是通用组件，放app/frontend/"

  - step: 3
    name: "模块文档创建"
    description: "创建agent.md和doc/子目录6个文档"
    estimated_time: "30-40分钟"
    
    ai_prompt_template: |
      为{module_name}模块创建完整文档结构
      参考plan.md内容
    
    documents_to_load:
      - path: /doc/modules/resources/init-documents.md
        priority: critical
      - path: /doc/modules/TEMPLATES/
        priority: high
      - path: /doc/modules/example/agent.md
        priority: medium
    
    expected_output:
      - "modules/{module_name}/agent.md (YAML Front Matter完整)"
      - "modules/{module_name}/doc/CONTRACT.md"
      - "modules/{module_name}/doc/CHANGELOG.md"
      - "modules/{module_name}/doc/RUNBOOK.md"
      - "modules/{module_name}/doc/BUGS.md"
      - "modules/{module_name}/doc/PROGRESS.md"
      - "modules/{module_name}/doc/TEST_PLAN.md"
    
    validation:
      - "agent.md通过make agent_lint"
      - "CONTRACT.md明确API和前端组件说明"
      - "所有文档使用模板结构"
    
    common_issues:
      - issue: "agent.md YAML Front Matter格式错误"
        solution: "参考schemas/agent.schema.yaml和example/agent.md"
      - issue: "CONTRACT.md内容不清晰"
        solution: "分别说明API接口、前端组件、数据模型，提供请求/响应示例"

  - step: 4
    name: "模块注册"
    description: "更新registry.yaml和MODULE_INSTANCES.md"
    estimated_time: "10-15分钟"
    
    ai_prompt_template: |
      将{module_name}模块注册到系统
      模块类型：{module_type}
      依赖模块：{dependencies}
    
    documents_to_load:
      - path: /doc/modules/resources/init-registration.md
        priority: critical
      - path: /doc/orchestration/registry.yaml
        priority: high
    
    expected_output:
      - "doc/orchestration/registry.yaml (新增module_instances条目)"
      - "doc/modules/MODULE_INSTANCES.md (自动生成)"
    
    validation:
      - "make registry_check通过"
      - "make module_doc_gen成功生成MODULE_INSTANCES.md"
      - "新模块出现在MODULE_INSTANCES.md中"
    
    common_issues:
      - issue: "registry.yaml格式错误"
        solution: "参考已有模块格式，确保YAML缩进正确"
      - issue: "依赖关系配置错误"
        solution: "运行make dag_check验证无循环依赖"

  - step: 5
    name: "代码实现与测试"
    description: "实现核心逻辑，编写单元测试"
    estimated_time: "1-2小时"
    
    ai_prompt_template: |
      基于CONTRACT.md实现{module_name}模块
      技术栈：{tech_stack}
      确保：
      1. 遵循AI_CODING_GUIDE.md规范
      2. 测试覆盖率≥75%
      3. 无Linter错误
    
    documents_to_load:
      - path: /doc/process/AI_CODING_GUIDE.md
        priority: critical
      - path: /doc/process/testing.md
        priority: high
      - path: /doc/modules/example/core/
        priority: medium
    
    expected_output:
      - "modules/{module_name}/core/*.py|.ts|.go (核心实现)"
      - "tests/{module_name}/*.py|.ts|.go (单元测试)"
      - "测试覆盖率报告"
    
    validation:
      - "make test通过 (如有测试)"
      - "代码覆盖率≥75%"
      - "无Linter错误"
    
    common_issues:
      - issue: "不知道如何组织代码结构"
        solution: "参考doc/modules/example/core/示例"
      - issue: "测试覆盖率不足"
        solution: "关注边界条件、错误处理、异步逻辑"

  - step: 6
    name: "数据库变更（如需要）"
    description: "创建表YAML和迁移脚本"
    estimated_time: "20-30分钟"
    
    ai_prompt_template: |
      {module_name}模块需要数据库表：{tables}
      请创建：
      1. 表结构YAML
      2. 迁移脚本（up/down）
      3. 更新TEST_DATA.md
    
    triggers:
      - "database-operations"
    
    documents_to_load:
      - path: /doc/process/DB_CHANGE_GUIDE.md
        priority: critical
      - path: /doc/process/resources/db-create-table.md
        priority: high
    
    expected_output:
      - "db/engines/postgres/schemas/tables/{table}.yaml"
      - "db/engines/postgres/migrations/{NNN}_{module}_{action}_up.sql"
      - "db/engines/postgres/migrations/{NNN}_{module}_{action}_down.sql"
    
    validation:
      - "make db_lint通过"
      - "迁移脚本成对存在"
      - "表YAML格式正确"
    
    common_issues:
      - issue: "不确定表结构设计"
        solution: "参考db/engines/postgres/schemas/tables/runs.yaml示例"
      - issue: "迁移脚本编写错误"
        solution: "确保down脚本能完全回滚up脚本的变更"

  - step: 7
    name: "测试数据准备"
    description: "定义TEST_DATA.md和Fixtures"
    estimated_time: "20-30分钟"
    
    ai_prompt_template: |
      为{module_name}模块准备测试数据
      场景：{test_scenarios}
    
    documents_to_load:
      - path: /doc/modules/resources/init-testdata.md
        priority: critical
      - path: /doc/process/TEST_DATA_STRATEGY.md
        priority: high
      - path: /doc/process/MOCK_RULES_GUIDE.md
        priority: medium
    
    expected_output:
      - "modules/{module_name}/doc/TEST_DATA.md"
      - "modules/{module_name}/fixtures/minimal.sql"
      - "modules/{module_name}/fixtures/standard.sql"
    
    validation:
      - "TEST_DATA.md包含场景定义"
      - "Fixtures可通过make load_fixture加载"
      - "agent.md包含test_data配置"
    
    common_issues:
      - issue: "不知道准备多少测试数据"
        solution: "最少3个场景：minimal(3-5条)、standard(20-30条)、full(可选)"
      - issue: "Fixtures vs Mock如何选择"
        solution: "参考TEST_DATA_STRATEGY.md决策树"

  - step: 8
    name: "上下文恢复文档"
    description: "创建.context/目录和恢复文档"
    estimated_time: "15-20分钟"
    
    ai_prompt_template: |
      为{module_name}模块创建上下文恢复文档
    
    documents_to_load:
      - path: /doc/process/CONTEXT_GUIDE.md
        priority: critical
      - path: /doc/modules/example/.context/
        priority: high
    
    expected_output:
      - "modules/{module_name}/.context/quick-start.md"
      - "modules/{module_name}/.context/key-decisions.md"
      - "modules/{module_name}/.context/troubleshooting.md"
    
    validation:
      - ".context/目录包含3个核心文档"
      - ".gitignore已排除.context/"
    
    common_issues:
      - issue: ".context/内容不知道写什么"
        solution: "参考example/.context/示例，记录关键决策和常见问题"

  - step: 9
    name: "完整性校验"
    description: "运行所有自动化检查"
    estimated_time: "10-15分钟"
    
    ai_prompt_template: |
      运行完整性校验：
      1. make agent_lint
      2. make registry_check
      3. make doc_route_check
      4. make type_contract_check
      5. make db_lint (如有数据库变更)
      6. make validate
    
    documents_to_load:
      - path: /doc/modules/resources/init-validation.md
        priority: critical
    
    expected_output:
      - "所有检查通过"
      - "生成校验报告"
    
    validation:
      - "make validate 全部通过"
      - "无Linter错误"
      - "无路径引用错误"
    
    common_issues:
      - issue: "agent_lint失败"
        solution: "检查agent.md YAML格式，参考agent.schema.yaml"
      - issue: "doc_route_check失败"
        solution: "确保context_routes中的路径都存在"

# 常见陷阱（简洁列表）
pitfalls:
  - issue: "模块职责不清，边界模糊"
    impact: "导致模块间耦合度高，难以维护"
    solution: "参考MODULE_TYPES.md决策树，明确3个维度（职责边界、依赖关系、数据所有权）"
    severity: "high"
  
  - issue: "遗漏测试数据准备"
    impact: "开发和测试环境数据不一致，难以复现问题"
    solution: "使用TEST_DATA.md模板，至少准备minimal场景"
    severity: "medium"
  
  - issue: "agent.md YAML格式错误"
    impact: "智能编排系统无法识别模块"
    solution: "参考schemas/agent.schema.yaml和example/agent.md"
    severity: "high"
  
  - issue: "忘记更新registry.yaml"
    impact: "模块不在系统注册表中，无法被编排"
    solution: "Step 4完成后立即运行make registry_check"
    severity: "medium"
  
  - issue: "数据库迁移脚本不成对"
    impact: "无法回滚，生产环境风险高"
    solution: "每个up.sql必须有对应的down.sql"
    severity: "critical"

# 质量检查清单（清单式）
quality_checklist:
  - "[ ] plan.md明确模块目标和技术栈"
  - "[ ] 目录结构符合规范（core/必需）"
  - "[ ] agent.md包含完整YAML Front Matter"
  - "[ ] CONTRACT.md明确API和前端组件"
  - "[ ] 模块已注册到registry.yaml"
  - "[ ] 通过make agent_lint"
  - "[ ] 通过make registry_check"
  - "[ ] 通过make validate"
  - "[ ] 测试覆盖率≥75%"
  - "[ ] TEST_DATA.md已创建"
  - "[ ] Fixtures已准备（minimal + standard）"
  - "[ ] .context/目录已创建"
  - "[ ] 无Linter错误"
  - "[ ] 无路径引用错误"
  - "[ ] README.md包含'目录结构'章节"

# 估时参考（基于经验数据）
time_breakdown:
  planning: "30-45分钟"
  directory_setup: "15-20分钟"
  documentation: "30-40分钟"
  registration: "10-15分钟"
  coding: "1-2小时"
  database: "20-30分钟 (如需要)"
  test_data: "20-30分钟"
  context_docs: "15-20分钟"
  validation: "10-15分钟"
  total: "2.5-4小时"

# 参考资源（指向人类文档）
references:
  detailed_guide: "/ai/workflow-patterns/examples/module-creation-example.md"
  related_patterns:
    - "api-development (如需要HTTP接口)"
    - "database-migration (如需要数据库变更)"
  templates:
    - "/doc/modules/TEMPLATES/"
  examples:
    - "/doc/modules/example/"

# 成功标准
success_criteria:
  - "所有9个步骤完成"
  - "所有质量检查清单项通过"
  - "模块可正常运行和测试"
  - "文档完整且格式正确"
  - "已注册到系统"

# 下一步行动
next_actions:
  - "如需要HTTP接口 → 参考api-development模式"
  - "如需要性能优化 → 参考performance-optimization模式"
  - "如遇到问题 → 参考bug-fix模式"

