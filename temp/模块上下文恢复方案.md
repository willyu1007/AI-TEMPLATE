# 模块上下文恢复机制方案

> **创建时间**: 2025-11-08  
> **用途**: 为每个模块建立上下文恢复机制

---

## 1. 目录命名建议

### 方案A: `.context/` ⭐（推荐）
- **优点**: 点前缀表示隐藏/内部文件，不易被误读
- **缺点**: 可能被.gitignore忽略（需要排除）
- **适用**: 强调"不应频繁阅读"

### 方案B: `_context/`
- **优点**: 下划线前缀表示内部目录，排序靠前
- **缺点**: 在文件列表中仍然显眼
- **适用**: 需要容易找到但不常用

### 方案C: `context/`
- **优点**: 简单直观
- **缺点**: 与doc/等目录平级，可能被频繁查看
- **适用**: 希望context和doc地位相当

### 方案D: `doc/_internal/` 或 `doc/.context/`
- **优点**: 归入doc/体系，但用特殊前缀区分
- **缺点**: 路径较深
- **适用**: 希望统一管理文档

---

## 2. 推荐方案

**建议使用**: `.context/` ⭐

**理由**:
1. 符合"不希望经常被阅读"的需求
2. 点前缀在Unix/Linux习惯中表示隐藏或内部文件
3. 可以通过`.gitignore`排除规则保留
4. 与doc/平级，但明确区分用途

**配置**:
在.gitignore中添加排除规则：
```
# 保留模块的.context/目录
!modules/*/.context/
!doc/modules/*/.context/
```

---

## 3. 目录结构

### 模块级.context/目录结构

```
modules/<entity>/.context/
├── README.md                   # 上下文目录说明
├── requirements/               # 需求文档
│   ├── PRD.md                 # 产品需求文档（可选）
│   ├── design.md              # 设计文档（可选）
│   └── user_stories.md        # 用户故事（可选）
├── context/                    # 上下文记录
│   ├── overview.md            # 模块概览和背景
│   ├── decisions.md           # 设计决策记录（ADR风格）
│   └── history.md             # 变更历史摘要
└── sessions/                   # AI会话记录（可选）
    ├── 2025-11-01_初始化.md
    └── 2025-11-08_功能扩展.md
```

### 根目录doc/下的规范文档位置

建议路径: `doc/process/CONTEXT_GUIDE.md`

---

## 4. 规范文档内容框架

### doc/process/CONTEXT_GUIDE.md

**章节**:
1. 目标和用途
2. .context/目录结构规范
3. 文档写入规则
   - 何时写入
   - 写什么内容
   - 文档命名规范
4. 文档清理规则
   - 清理触发条件
   - 清理标准（过时、重复、无效）
   - 清理流程
5. 持续迭代流程
   - 定期审查机制
   - 文档归档策略
   - 版本管理建议
6. 上下文恢复流程
   - 快速恢复（5分钟）
   - 标准恢复（15分钟）
   - 完整恢复（30分钟）
7. 最佳实践
8. 与doc/的区别
9. 集成到模块初始化

---

## 5. 与doc/的区别

| 维度 | doc/ | .context/ |
|------|------|-----------|
| 用途 | 规范、契约、技术文档 | 背景、历史、会话记录 |
| 读取频率 | 频繁（on_demand路由） | 偶尔（上下文丢失时） |
| 更新频率 | 按需更新 | 持续追加 |
| 生命周期 | 长期维护 | 定期清理 |
| AI路由 | ✅ 包含在context_routes | ❌ 不包含（除非明确需要） |
| 内容性质 | 标准化、结构化 | 叙事性、时序性 |

---

## 6. 模块初始化集成

### MODULE_INIT_GUIDE.md新增

**新增Phase**: Phase 8 - 建立上下文恢复机制（可选）

**内容**:
1. 创建.context/目录结构
2. 编写overview.md（模块背景和目标）
3. 如有需求文档，放入requirements/
4. 建立decisions.md（记录关键决策）
5. 在agent.md中说明.context/的用途（但不路由）

---

## 7. agent.md中的说明

在模块级agent.md中添加注释（不在YAML中）：

```markdown
## 上下文恢复

本模块使用 `.context/` 目录记录开发上下文和历史。

**目录说明**:
- `.context/requirements/` - 需求文档
- `.context/context/` - 上下文记录
- `.context/sessions/` - AI会话记录

**何时查阅**: 
- 上下文丢失时
- 需要了解模块背景时
- 需要回顾设计决策时

**详细规范**: 参考 `doc/process/CONTEXT_GUIDE.md`
```

---

## 8. 实施步骤

1. 创建doc/process/CONTEXT_GUIDE.md
2. 为example模块创建.context/示例
3. 更新MODULE_INIT_GUIDE.md
4. 更新ai_begin.sh生成.context/目录
5. 更新agent.schema.yaml（可选，添加context_notes字段）
6. 测试完整流程

---

**建议**: 使用 `.context/` 目录名

**下一步**: 待用户确认后开始实施

