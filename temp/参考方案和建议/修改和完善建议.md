
## **0. 结论**

-   **优势**：已有清晰的项目骨架、质量门禁与自动化脚本（DAG 无环、契约兼容、DB 迁移成对、配置 Schema、文档一致性、测试覆盖率），并提供 Makefile 入口和 ai_begin 快速生成模块雏形，指向 agent.md / QUICK_START / TEMPLATE_USAGE 三份核心文档。
    
-   **主要短板**：根目录 **agent.md** **过重（>1350 行）**，语义与 README 存在交叉；模块实例层未形成**轻量、可解析的** **agent.md** **标准**；**初始化流程与编排路由未“可编排化”**（缺少可被 Orchestrator 自动读取的统一 Schema 与 Registry）；**模块文档分布与命名不利于上下文精准提取**。
    
-   **改造抓手（优先级顺序）**：  
    1.  推出 **agent.md v2** **统一 Schema（YAML+Markdown）**
    2.  **根** **agent.md** **轻量化**，仅保留全局目标、质量与安全门槛、路由指引；      
    3.  为**每个模块实例**补齐 agent.md 与 README.md + doc/ 子目录；     
    4.  增加 **/doc/orchestration/registry.yaml**（模块类型/实例/依赖/上下游）和 **/schemas/agent.schema.yaml**（自动校验）；       
    5.  增加 **项目初始化**与**模块初始化**规范（存放于 /doc/init/ 与 /doc/modules/）；       
    6.  新增 CI：**Agent Schema 校验、Registry 拓扑校验、文档路由校验**；      
    7.  明确 **README（人读） vs agent.md（模型读）** 的职责边界并在每个 README 顶部声明“编排系统请读 agent.md”；    
    8.  用 **Makefile/Action** 将“需求→检索→调度→编码→测试→文档→知识库”的闭环工具化。

## **1. 现状评估（基于仓库可见信息）**

-   **项目结构与自动化**：根 README 已罗列结构与能力，含 .aicontext/（AI 上下文索引）、.contracts_baseline/、scripts/ 下的 docgen.py / dag_check.py / contract_compat_check.py，以及 make ai_begin 初始化模块。质量门禁清单明确。
    
-   **文档中心化但过重**：根 README 引导阅读 agent.md（称 1350+ 行、含流程/规则/脚本），这对**模型读写性能与上下文预算**不友好，也与“根级轻量化”目标相悖。
    
-   **模块层**：存在 modules/example/，但从公开信息看，仍以“单层说明文档”组织，尚未形成“**实例级 agent.md + 独立 doc 子目录**”的可替换/可编排模式。
    
-   **模板与快速上手**：QUICK_START.md、TEMPLATE_USAGE.md 与 agent.md 的边界需要进一步切分：人读/模型读/初始化流程分别承载。
    
-   **目标对齐**：你希望**AI 友好+模块化**、**自动化完备**、**适配智能体编排**并且**README/agent.md 职责清晰**、**根 agent.md 轻量化**、**子级文档标准化**、**初始化有规范**。以下方案完全围绕这些原则推进

## **2. 目标状态（To‑Be）**
> 面向“智能体深度参与”的**可编排仓库模板**：文档/代码/工具三位一体，**可解析、可校验、可调度**。

### **2.1 文档职责切分**

-   **README（人读）**：介绍、入口、目录地图、安装、示例、维护/版本；在“开头”声明——**编排/模型请转同级** **agent.md**。    
-   **agent.md（模型读）**：**统一 YAML 头部 + Markdown 说明**；可被 Orchestrator 自动爬取、合并、校验与调度。根级轻量；模块实例详尽且聚焦本实例的 I/O、边界、依赖与调度提示。
    
### **2.2 目录骨架（更新版）**
``` markdown
.
├── agent.md                 # 根-轻量路由与全局策略（必读短文）
├── README.md                # 根-人读
├── QUICK_START.md           # 人读-快速上手
├── TEMPLATE_USAGE.md        # 人读-模板使用
├── schemas/
│   └── agent.schema.yaml    # agent.md YAML 前言校验Schema
├── doc/
│   ├── orchestration/
│   │   ├── registry.yaml    # 模块类型/实例/关系/版本/状态
│   │   └── routing.md       # 路由策略与合并规则（子覆盖父）
│   ├── policies/
│   │   ├── goals.md         # 全局目标/成功标准/质量门槛
│   │   └── safety.md        # 通用安全/合规
│   ├── indexes/
│   │   └── context-rules.md # 上下文抽取/切片/屏蔽策略
│   ├── init/
│   │   ├── PROJECT_INIT_GUIDE.md  # 项目初始化规范（给模型）
│   │   └── CHECKLISTS.md
│   └── modules/
│       ├── MODULE_INIT_GUIDE.md   # 模块初始化规范（给模型）
│       └── TEMPLATES/             # agent.md/README/合同/测试模板
└── modules/
    └── <module-entity>/
        ├── agent.md               # 实例-模型读
        ├── README.md              # 实例-人读
        ├── plan.md                # 计划（含并发与冲突策略）
        └── doc/
            ├── CHANGELOG.md
            ├── CONTRACT.md
            ├── PROGRESS.md
            ├── BUGS.md
            ├── RUNBOOK.md
            └── TEST_PLAN.md
```
> 该结构满足你在第 3 章的骨架诉求：文档下沉到 modules/<entity>/doc/，模块实例目录仅保留 agent.md / plan.md / README.md。

## **3. 统一规范（YAML+Markdown，可自动解析）**

### **3.1 YAML 头部字段（最小必需集合）**
``` yaml
# --- agent.md (YAML front matter) ---
spec_version: "1.0"
agent_id: "modules.<entity>.<instance>"        # 唯一ID
role: "API layer coordinator"                   # 角色
level: 1|2|3|4                                  # 模块层级
module_type: "1_Assign/2_Select/3_SelectMethod" # 按你的分级规则
ownership:
  code_paths:
    include: ["modules/<entity>/"]              # 允许改动范围
    exclude: ["modules/*/doc/CHANGELOG.md"]     # 只读或需审批
io:
  inputs:                                       # I/O Schema（JSON Schema 或 Ref）
    - name: "request"
      schema_ref: "schemas/request.json"
  outputs:
    - name: "response"
      schema_ref: "schemas/response.json"
contracts:
  apis: ["openapi://modules/<entity>/openapi.yaml"] # 或 CONTRACT.md 的锚点
dependencies:
  upstream: ["modules.other.M_X"]               # 依赖谁
  downstream: ["orchestrator.main"]             # 输出给谁
constraints:
  - "must not access DB directly"
tools_allowed:
  calls: ["http", "fs.read", "queue.publish"]
  models: ["gpt-4.1-mini", "reranker-v2"]       # 示例
quality_gates:
  required_tests: ["unit", "contract", "e2e"]
  coverage_min: 0.75
orchestration_hints:
  triggers: ["on_http_request", "batch_nightly"]
  routing_tags: ["io:json", "domain:assign"]
  priority: 5
context_routes:                                  # 轻量路由：指向应读文档
  always_read:
    - "/doc/policies/goals.md"
    - "/doc/policies/safety.md"
  on_demand:
    - topic: "api"
      paths: ["/modules/<entity>/doc/CONTRACT.md"]
    - topic: "ops"
      paths: ["/modules/<entity>/doc/RUNBOOK.md"]
# --- end YAML ---

```
### **3.2 Markdown 正文（结构约定）**
``` markdown
# Summary
简述该 Agent 能力边界与使用前提。

## Responsibilities
- Route requests
- Validate payloads
- Delegate to core logic

## Limitations
- 不允许直连数据库；必须通过 Data Agent。

## I/O Examples
```json
{ "input": { "foo": "..."} }

```

 **Test & SLO**
-   必须通过 CONTRACT/TEST_PLAN；P95 延迟 < 200ms（示例）。
    
**Runbook**
-   故障定位→旁路→回滚→恢复 的标准流程链接：./doc/RUNBOOK.md

> **根目录 `agent.md`** 使用相同 Schema，但**只保留**：`spec_version / global goals 路由 / safety / orchestration 合并规则 / 必读清单`，不放冗余流程细节（将细节搬到 `/doc/` 下并做路由）。这契合你“根 agent.md 轻量化、目录分层阅读建议与路由”的目标。 [oai_citation:11‡完善模板和文档.md](sediment://file_000000005eac720c8685feef9bfea6cb)

---

## 4. README 规范（根与子目录一致）
**规则**：顶部是“语义地图”，接着放“声明：编排/大模型请去读 `agent.md`”。示例：

```markdown
# <模块/项目名称>
> 一句话介绍；使用人群；边界声明。

## 目录地图
- 入口：`src/main.py`
- 快速体验：`make run`
- 结构：
  - `agent.md`（模型/编排读）
  - `doc/`（契约、测试、运维、变更）
  - `plan.md`（计划与并发策略）

## 安装
...
## 使用示例
...

> **给编排系统**：请读取同级 `agent.md`（YAML front matter 可解析）。
```
> 满足“README 更像介绍书、agent.md 是角色与约束说明”的边界诉求。

## **5. 初始化引导（项目&模块）——规范化文档与自动化**
### **5.1 项目初始化（放/doc/init/PROJECT_INIT_GUIDE.md）**

**目的**：让大模型严格按流程完成仓库级初始化，满足根 agent.md 的要求。要点：

1.  **四种初始化路径**（有文档/无文档/手动/导入其他项目），各自 checklist；  
2.  对齐信息收集表（目标、范围、模块清单、质量门槛、合规模板）；  
3.  生成动作：更新根 README.md、根 agent.md、移除 init/ 与 TEMPLATE_USAGE.md；  
4.  make init:project 驱动，串起 docgen / update_baselines / dev_check。

**附：模板片段**
``` markdown
# PROJECT_INIT_GUIDE
## Inputs
- 现有需求文档（可选，路径/上传）
- 目标/非目标/质量门槛/合规要求

## Steps
S1 收集 → S2 方案对齐 → S3 生成骨架 → S4 校验 → S5 确认与清理

## Outputs
- 更新后的 README.md / agent.md
- /doc/orchestration/registry.yaml 初版
- 移除 /init 与 TEMPLATE_USAGE.md
```

### **5.2 模块初始化（放/doc/modules/MODULE_INIT_GUIDE.md）**
**目标**：让大模型能**生成目录、文档与可编排的 agent.md**，并能**准确更新其他目录**。

**关键点**：

-   询问是否有需求文档→存于 modules/<entity>/doc/； 
-   反复澄清直至**冻结**需求，产出 CONTRACT.md / TEST_PLAN.md 雏形；   
-   生成实例级 agent.md（按 v2 Schema）与 README.md；
-   更新 **/doc/orchestration/registry.yaml**（注册类型、实例、上下游、版本、状态、标签）；    
-   计划执行前必须在 plan.md 写明**执行人、并行策略、冲突解决**；   
-   make init:module MODULE=<entity> 一键脚手架。
    
**附：registry.yaml 片段**
``` yaml
modules:
  - type: "1_Assign/2_Select/3_SelectMethod"
    instance: "M_AI_Select_2"
    path: "modules/assign/select/ai_v2"
    level: 3
    owners: ["@owner1", "@owner2"]
    io_ref: ["schemas/assign/select.json"]
    upstream: ["M_Data_Query"]
    downstream: ["orchestrator.main"]
    status: "active"    # active/deprecated/wip
    version: "2.0.0"	
```

## **6. 编排落地：自动读取、合并与调度**

**运行时行为**：
1.  Orchestrator 递归读取各层 agent.md YAML； 
2.  按“**子级覆盖父级**”合并策略构建 Agent 网； 
3.  依据 routing_tags / triggers / constraints / tools_allowed 做**约束内调度**；  
4.  通过 context_routes **延迟加载**所需文档，减少无效上下文；   
5.  通过 quality_gates 与 contracts 强制门禁。
    
**校验脚本建议（scripts/agent_lint.py 伪代码）**：
``` python
# 1) 遍历仓库，抽取 agent.md 的 YAML front matter
# 2) 用 schemas/agent.schema.yaml 校验字段与类型
# 3) 校验 registry.yaml 拓扑（无环）并与 agent 声明一致
# 4) 校验 context_routes 指向的路径存在
# 5) 输出报告并以非零码退出 CI
```

## **7. 并行开发与冲突解决（与plan.md强关联）**
> 这直接回应你的并行/冲突治理诉求。

**plan.md 必填项**：
-   assignee（执行体；可为人或 Agent 标识）、reviewers、code_paths.lock（乐观锁/目录级并发策略）；
-   breaking_change 标记与兼容策略（向后兼容/灰度/双栈）   
-   合并顺序（基于模块依赖拓扑）；
-   冲突判定与处置（文件级优先级、合同基线对比、自动三方合并失败转人工）；  
-   “**未获批准不得写码**”——CI 在 plan.md 缺失或未签字时阻塞。

## **8. CI/CD 增强（GitHub Actions 示例）**
.github/workflows/ci.yml（片段）：
``` yaml
name: CI
on: [push, pull_request]
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - run: pip install -r requirements.txt
      - name: Agent schema check
        run: python scripts/agent_lint.py
      - name: Contract compat
        run: python scripts/contract_compat_check.py
      - name: DAG check
        run: python scripts/dag_check.py
      - name: Doc index
        run: python scripts/docgen.py
      - name: Dev gate
        run: make dev_check
```
> 与现有 Makefile/脚本衔接，巩固“自动化门禁”。

## **9. 逐文档错误与改进报告（结构化）**

### **9.1 根级 README.md**

-   **错误/风险**  
    1.  与 agent.md 存在职责交叉（将“流程/规则/脚本细节”外溢到人读文档的风险）        
    2.  对“编排系统的入口”提醒不够显著（建议放在**开头第二段**）。
        
-   **修正**   
    -   引入“**人读 vs 模型读**”显式段落（见第 4 节模板）；    
    -   仅保留**地图/入口/示例**，流程类跳转到 /doc/ 与 agent.md。

### **9.2 根级 agent.md**

-   **错误/风险**  
    1.  体量过大（1350+ 行）→ **上下文污染**、**加载成本高**、**难以模块化继承**。
-   **修正**
    -   “**轻量核心 + 路由列表**”模式：全局目标、质量/安全门槛、合并与继承规则、文档路由； 
    -   其他细节**迁移**到 /doc/policies/*, /doc/orchestration/*, /doc/indexes/*；
    -   使用 schemas/agent.schema.yaml 强制字段最小化与合法性。
        
### **9.3 QUICK_START.md/TEMPLATE_USAGE.md**

-   **错误/风险**
    1.  与 agent.md 存在内容重叠的可能（指令与流程）；
-   **修正**
    -   QUICK_START.md：**5 分钟体验** + 常用命令；    
    -   TEMPLATE_USAGE.md：**模板变项清单**与**必须修改项**；      
    -   所有“编排/模型相关指令”统一迁至 /doc/init/ 与根 agent.md 路由。
       

### **9.4 模块目录（以modules/example/为例）**

-   **错误/风险**    
    1.  实例级 agent.md 缺失/未标准化；        
    2.  文档在实例根部过多，影响“可替换实例”的清洁边界。
 
-   **修正**    
    -   补齐实例级 agent.md（v2 Schema），并将除 README/plan 外的文档迁至 doc/ 子目录；    
    -   在 **/doc/orchestration/registry.yaml** 注册类型/实例/上下游/状态/版本。
        
  

----------

##  **10. 最小模板示例**

### **10.1 根agent.md（轻量版）**
``` yaml
spec_version: "1.0"
agent_id: "root"
role: "orchestration-policy"
policies:
  goals_ref: "/doc/policies/goals.md"
  safety_ref: "/doc/policies/safety.md"
merge_strategy: "child_overrides_parent"
context_routes:
  always_read:
    - "/doc/policies/goals.md"
    - "/doc/policies/safety.md"
  by_scope:
    - scope: "repo"
      read: ["/doc/orchestration/registry.yaml", "/doc/indexes/context-rules.md"]
    - scope: "module"
      read: ["modules/*/agent.md"]
```
``` markdown
# Root Agent Guide (Light)
- 本仓库采用“子级覆盖父级”的合并策略。
- 质量门槛：见 `/doc/policies/goals.md`。
- 初始化流程：见 `/doc/init/PROJECT_INIT_GUIDE.md`。
```

### **10.2 模块实例 agent.md**
见第 3 节 YAML+Markdown 模板；复制即可用。

### **10.3 schemas/agent.schema.yaml（摘要）**
``` yaml
type: object
required: [spec_version, agent_id, role]
properties:
  spec_version: { type: string }
  agent_id: { type: string }
  role: { type: string }
  level: { type: integer, minimum: 1, maximum: 4 }
  module_type: { type: string }
  ownership:
    type: object
    properties:
      code_paths:
        type: object
        properties:
          include: { type: array, items: { type: string } }
          exclude: { type: array, items: { type: string } }
  io: { type: object }
  dependencies: { type: object }
  constraints: { type: array, items: { type: string } }
  tools_allowed: { type: object }
  quality_gates: { type: object }
  orchestration_hints: { type: object }
  context_routes: { type: object }
additionalProperties: true
```

## **11. 执行清单（两阶段）**

### **Phase A**

1.  新增 schemas/agent.schema.yaml 与 scripts/agent_lint.py；
2.  拆分根 agent.md → /doc/；根 agent.md 改为轻量路由； 
3.  建立 /doc/orchestration/registry.yaml（把现有模块/示例登记齐全）；  
4.  替换 modules/*：添加实例级 agent.md 与 doc/ 子目录；
5.  在根/模块 README.md 顶部加入“编排系统请读 agent.md”；  
6.  CI 接入 **Agent Schema 校验** 与 **Registry 无环检查**。

### **Phase B**
1.  完善 PROJECT_INIT_GUIDE.md 与 MODULE_INIT_GUIDE.md，加上**对话范式**与**确认门槛**；
2.  Makefile：init:project / init:module / ai:route（根据 tags 给出建议 Agent）；  
3.  观察/迭代：收集 agent_lint 误报/漏报，迭代 Schema 与路由策略； 
4.  增加“知识库索引”策略（.aicontext/ 生成规则），统一碎片文档抽取粒度与屏蔽清单
