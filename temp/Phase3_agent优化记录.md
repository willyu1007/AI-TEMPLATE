# agent.md优化记录

> **优化时间**: 2025-11-07
> **优化轮次**: 3轮
> **最终结果**: 从2434行精简到256行（精简89%）

---

## 优化历程

### 第1轮：基础精简（442行）
**操作**: 迁移详细内容，添加YAML Front Matter
**结果**: 2434行 → 442行（精简82%）

### 第2轮：深度精简（229行）
**用户反馈问题**:
1. 第1章目录规范太详细 → 迁移到doc/architecture/directory.md
2. "提示词与清单"命名不清 → 改为"质量检查清单"
3. 第4章命令会持续更新 → 迁移到doc/reference/commands.md
4. 第5章内容重复 → 合并重复项

**操作**: 删除目录和命令章节，去重
**结果**: 442行 → 229行（再精简48%）

### 第3轮：补充关键信息（256行）
**用户反馈问题**:
- 缺少测试相关信息
- 缺少PR/提交流程
- 缺少门禁说明
- 文档路由说明不够详细

**操作**: 
1. 创建doc/process/testing.md（测试准则）
2. 创建doc/process/pr_workflow.md（PR工作流）
3. 在agent.md中添加简要说明和引用
4. 在context_routes中添加3个新主题
5. 补充文档路由的工作原理说明

**结果**: 229行 → 256行（增加必要信息）

---

## 最终的agent.md结构

### YAML Front Matter（60行）
```yaml
---
spec_version: "1.0"
agent_id: "repo"
role: "AI-TEMPLATE仓库根编排配置"

policies:
  goals_ref, safety_ref, roles_ref

merge_strategy: "child_overrides_parent"

context_routes:
  always_read: [3个必读文档]
  on_demand: [10个主题] ← 新增3个
  by_scope: [2个范围]
---
```

### 正文（196行）

#### 重要提醒（7行）
- 阅读文档规范
- 遵循工作流程  
- 理解职责边界
- 遵循文档路由

#### § 0 工作流程6步法（75行）
- S0: 刷新上下文（分层加载）
- S1: 任务建模
- S2: 方案预审（AI-SR-plan）
- S3: 实现与验证 + **测试要求** ← 新增
- S4: 文档更新
- S5: 自审与PR + **PR流程** + **CI门禁** ← 新增
- S6: 自动维护

#### § 1 文档路由与上下文（35行）
- **按需加载原理** ← 详细说明工作原理
- 10个on_demand主题列表 ← 新增
- 记忆机制

#### § 2 质量检查清单（30行）
- 变更前检查
- 实现中检查
- 提交前检查

#### § 3 文档编写规范（8行）
- 语言一致性
- 结构化输出
- 禁用颜文字
- 版本追踪

#### § 4 核心参考文档（35行）
- 编排与策略（5个）
- 初始化指南（4个）
- 架构与参考（4个）
- 过程文档（5个）← 新增testing.md和pr_workflow.md

---

## context_routes配置详情

### always_read（3个）
每次必读的策略文档：
- /doc/policies/goals.md
- /doc/policies/safety.md
- /README.md

### on_demand（10个主题）
按任务类型按需读取：

| 主题 | 文档路径 | 使用场景 |
|------|---------|---------|
| 目录结构 | doc/architecture/directory.md | 了解项目结构时 |
| 数据库操作 | doc/db/, db/engines/README.md | 操作数据库时 |
| 模块开发 | doc/modules/MODULE_INIT_GUIDE.md等 | 创建/修改模块时 |
| 项目初始化 | doc/init/PROJECT_INIT_GUIDE.md | 初始化项目时 |
| 配置管理 | config/README.md, doc/process/CONFIG_GUIDE.md | 修改配置时 |
| 命令参考 | doc/reference/commands.md | 查找命令时 |
| **测试规范** | **doc/process/testing.md** | **编写测试时** ← 新增 |
| **提交与PR** | **doc/process/pr_workflow.md** | **提交代码时** ← 新增 |
| **文档路由使用** | **doc/orchestration/routing.md** | **配置路由时** ← 新增 |

### by_scope（2个范围）
按工作范围读取：
- 模块开发 → MODULE_INIT_GUIDE.md + TEMPLATES/
- 编排管理 → registry.yaml + routing.md

---

## 新增文档

### doc/process/testing.md（~450行）
**内容**:
- 测试策略（测试金字塔）
- 覆盖率要求（≥80%）
- 4种测试类型（单元、集成、契约、E2E）
- 多语言测试规范（Python/Go/TypeScript）
- 测试最佳实践
- 质量门槛
- CI集成

**路由**: on_demand主题"测试规范"

---

### doc/process/pr_workflow.md（~400行）
**内容**:
- 提交流程（5步）
- Commit消息规范（Conventional Commits）
- PR描述模板
- CI/CD门禁（3个风险级别）
- 审核流程（快速/常规/严格通道）
- 合并策略
- 回滚机制
- 分支策略
- 发布流程

**路由**: on_demand主题"提交与PR"

---

## 核心改进点

### 1. 补充遗漏的关键信息 ✅
- **测试**: 覆盖率要求、测试类型、多语言规范
- **PR**: 提交流程、门禁规则、审核流程
- **门禁**: dev_check、rollback_check、风险分级

### 2. 文档路由清晰化 ✅
- 10个on_demand主题明确列出
- 添加工作原理说明
- 每个主题都有对应的详细文档

### 3. 信息分层 ✅
- **agent.md**: 工作流程 + 简要说明 + 引用
- **详细文档**: 完整规范和示例
- **按需加载**: 根据任务类型加载相关文档

---

## 最终验证

```bash
✅ agent.md: 256行（≤500行）
✅ make agent_lint: 1个通过, 0个失败
✅ YAML Front Matter: 完整，10个on_demand主题
✅ 工作流程: S0-S6包含测试、PR、门禁要求
✅ 文档路由: 清晰说明工作原理
```

---

## 对比：优化前后

### 信息完整性
| 内容 | 原始版本 | 优化后 | 说明 |
|------|---------|--------|------|
| 工作流程 | ✅ 有 | ✅ 有 | 保留 |
| 测试规范 | ✅ 有（337行） | ✅ 有（引用） | 迁移 |
| PR流程 | ❌ 分散 | ✅ 清晰 | 新增 |
| 门禁规则 | ✅ 有（7行） | ✅ 有（详细） | 增强 |
| 文档路由 | ❌ 无 | ✅ 有 | 新增 |
| 目录规范 | ✅ 有（268行） | ✅ 有（引用） | 迁移 |
| 命令手册 | ✅ 有（22行） | ✅ 有（引用） | 迁移 |

### 可维护性
| 方面 | 原始版本 | 优化后 |
|------|---------|--------|
| 文档更新频率 | 高（命令、目录常变） | 低（核心流程稳定） |
| 修改agent.md次数 | 频繁 | 极少 |
| 详细内容位置 | 集中在agent.md | 分散到doc/按需加载 |

---

## 设计理念

### agent.md应该是什么
✅ 工作流程手册（S0-S6）  
✅ 文档路由配置（context_routes）  
✅ 核心规范摘要（最小必要信息）  
✅ 文档索引中心（引用详细文档）

### agent.md不应该是什么
❌ 详细规范大全  
❌ 命令手册（会频繁更新）  
❌ 目录说明（属于架构文档）  
❌ 重复信息的堆积

---

## 用户反馈与改进

### 用户反馈1
> 如果已经有文档路由，是否还需要第1章？特别是第1章的子章节，似乎都没必要放到根目录下

**改进**: ✅ 第1章（目录规范）迁移到doc/architecture/directory.md，通过路由按需加载

---

### 用户反馈2
> 提示词与清单是通用的开发过程检验吗？是否需要明确，或者使用开发流程？

**改进**: ✅ 改名为"质量检查清单"，更明确表达用途

---

### 用户反馈3
> 第4章的内容是不是会持续更新？如果是是不是应该有一个回写机制？

**改进**: ✅ 命令迁移到doc/reference/commands.md，由该文档独立维护，避免频繁修改agent.md

---

### 用户反馈4
> 第3章感觉内容重复，（如禁止语言混用和语言一致性）

**改进**: ✅ 合并重复项，从30+行精简到5行核心规范

---

### 用户反馈5
> agent.md中似乎没有测试、提交（PR）、门禁等相关信息，也没有文档路由

**改进**: ✅ 
- 新增doc/process/testing.md（测试准则）
- 新增doc/process/pr_workflow.md（PR工作流）
- 在S3、S5中添加测试和PR要求
- 在§1中添加详细的文档路由工作原理说明
- 在context_routes中添加3个新主题

---

## 最终状态

### agent.md（256行）
- YAML Front Matter：完整，10个on_demand主题
- 工作流程：S0-S6，包含测试、PR、门禁
- 文档路由：详细说明工作原理
- 质量检查：3个阶段的检查清单
- 文档规范：4条核心规范
- 参考索引：20+个文档链接

### 支撑文档体系
```
agent.md (256行)
    ↓ context_routes
    ├─ doc/policies/ (3个策略)
    ├─ doc/architecture/ (1个架构)
    ├─ doc/reference/ (1个参考)
    ├─ doc/modules/ (4个模块相关)
    ├─ doc/init/ (1个初始化)
    ├─ doc/process/ (5个过程) ← 新增testing.md和pr_workflow.md
    ├─ doc/orchestration/ (2个编排)
    └─ 其他按需文档
```

---

## 信息完整性检查 ✅

- [x] 工作流程（S0-S6）
- [x] 测试规范（testing.md + S3中说明）
- [x] 提交流程（pr_workflow.md + S5中说明）
- [x] CI门禁（pr_workflow.md + S5中说明）
- [x] 文档路由（§1详细说明 + routing.md）
- [x] 质量检查（§2检查清单）
- [x] 文档规范（§3核心规范）
- [x] 参考索引（§4文档列表）

**结论**: 所有关键信息均已覆盖 ✅

---

## 优化效果评估

### 可读性
- **原版本**: 2434行，需要30+分钟阅读
- **优化后**: 256行，可在5-10分钟内理解核心流程

### 可维护性
- **原版本**: 命令、目录等常变内容在agent.md中，需频繁修改
- **优化后**: 详细内容在doc/下，agent.md极少需要修改

### 可扩展性
- **原版本**: 新增内容只能堆积在agent.md
- **优化后**: 新增文档到doc/，在context_routes添加路由即可

### 信息完整性
- **原版本**: 信息混在2434行中，难以快速定位
- **优化后**: 信息分层，通过路由按需加载，清晰高效

---

**优化完成**: 2025-11-07  
**最终版本**: agent.md v2.0  
**行数**: 256行  
**精简率**: 89%（从2434行）

