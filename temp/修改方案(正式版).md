# AI-TEMPLATE Repo 修改方案(正式版)

> **状态**: 正式版,整合所有需求和参考方案
> **创建日期**: 2025-11-07
> **版本**: v1.0

---

## 0. 执行摘要

本方案基于用户需求、现状分析和参考方案,提出AI-TEMPLATE仓库的全面优化方案,实现:
1. **AI友好**: agent.md轻量化、可解析、按需加载
2. **模块化**: 实例独立、类型可替换、关系清晰维护
3. **自动化**: 全流程可校验、可脚本化、可CI化,包括**数据库半自动化**
4. **可编排**: 支持智能体自动读取/合并/调度

**核心改进**:
- 根agent.md从2434行轻量化到≤500行
- 建立agent.md v2统一Schema(YAML Front Matter)
- 补齐模块实例级agent.md + doc/子目录
- 建立模块注册表registry.yaml(半自动化)
- **建立数据库治理体系,实现半自动化操作**
- 完善项目和模块初始化规范(大模型交互为主)
- 新增三校验脚本+CI集成

---

## 1. 设计原则

1. **AI友好**: 文档可解析、上下文按需加载、路径路由清晰、避免冗长根文档
2. **模块化**: 同类型可替换、实例独立、I/O稳定、关系清晰维护
3. **自动化**: 一切可校验、可脚本化、可CI化、闭环完整
4. **可编排**: Orchestrator能自动读取/合并agent.md,基于标签与约束调度
5. **安全与质量**: 默认最小权限、测试覆盖率门槛前置、破坏性操作需二次确认
6. **半自动化**: 关键操作(registry, db)采用自动生成+人工确认模式

---

## 2. 目录结构调整

### 2.1 整体结构
```text
.
├── agent.md                 # 根-轻量路由与全局策略(≤500行)
├── README.md                # 根-人读(顶部声明"编排系统请读agent.md")
├── QUICK_START.md           # 人读-快速上手
├── TEMPLATE_USAGE.md        # 人读-模板使用
│
├── schemas/                 # 新增目录
│   ├── agent.schema.yaml    # agent.md YAML前言校验Schema
│   └── db/                  # 新增-数据库Schema (可选)
│       └── table.schema.yaml # 表结构YAML的Schema
│
├── doc/                     # 扩展目录
│   ├── orchestration/       # 新增子目录
│   │   ├── registry.yaml    # 模块类型/实例/依赖/上下游(半自动化)
│   │   └── routing.md       # 路由策略与合并规则
│   ├── policies/            # 新增子目录
│   │   ├── goals.md         # 全局目标/成功标准/质量门槛
│   │   └── safety.md        # 通用安全/合规/文档规范
│   ├── indexes/             # 新增子目录
│   │   └── context-rules.md # 上下文抽取/切片/屏蔽策略
│   ├── init/                # 新增子目录
│   │   ├── PROJECT_INIT_GUIDE.md  # 项目初始化规范(大模型用)
│   │   └── CHECKLISTS.md    # 初始化检查清单
│   ├── modules/             # 新增子目录
│   │   ├── MODULE_INIT_GUIDE.md   # 模块初始化规范(大模型用)
│   │   └── TEMPLATES/       # agent.md/README/CONTRACT等模板
│   ├── project/             # 已有
│   ├── process/             # 已有
│   ├── db/                  # 已有(后续可能迁移到db/engines/postgres/docs/)
│   ├── flows/               # 已有
│   ├── ux/                  # 已有
│   └── adr/                 # 已有
│
├── db/                      # 新增目录-数据库治理
│   ├── registry.yaml        # 数据引擎/实例/扩展注册表
│   └── engines/
│       ├── postgres/
│       │   ├── migrations/  # 原migrations/迁移至此
│       │   ├── schemas/
│       │   │   └── tables/  # 每张表一个YAML
│       │   ├── extensions/  # pgvector/timescaledb配置
│       │   └── docs/        # 原docs/db/迁移至此
│       └── redis/           # 如需要
│           ├── schemas/keys/
│           └── docs/
│
├── migrations/              # 保留兼容别名(README指向新路径) 或 逐步废弃
│
└── modules/
    └── <module-entity>/
        ├── agent.md         # 新增-模块实例级(YAML+MD)
        ├── README.md        # 已有-模块说明(人读)
        ├── plan.md          # 已有-开发计划
        └── doc/             # 新增子目录
            ├── CHANGELOG.md     # 从模块根目录移入
            ├── CONTRACT.md      # 从模块根目录移入
            ├── PROGRESS.md      # 从模块根目录移入
            ├── BUGS.md          # 从模块根目录移入
            ├── RUNBOOK.md       # 从模块根目录移入
            └── TEST_PLAN.md     # 从模块根目录移入
```

### 2.2 文件迁移清单

#### 根agent.md内容迁移
| 当前章节 | 迁移目标 | 根agent.md保留内容 |
|---------|----------|-------------------|
| §0 快速开始 | doc/init/PROJECT_INIT_GUIDE.md | 保留简化版S0-S6流程(10行以内) |
| §1 目录规范 | doc/init/PROJECT_INIT_GUIDE.md | 保留核心目录树+路由指引 |
| §2 角色与门禁 | doc/policies/goals.md | 保留一句话说明+引用链接 |
| §4 DAG与接口契约 | docs/flows/DAG_GUIDE.md (已有) | 保留SSOT路径引用 |
| §5 模块化开发流程 | doc/modules/MODULE_INIT_GUIDE.md | 保留流程图+路由 |
| §6 测试准则(详细) | docs/process/CONVENTIONS.md | 保留质量门槛要求 |
| §7 数据库与数据规范 | db/engines/postgres/docs/ (新) | 保留SSOT路径引用 |
| §8 统一配置 | docs/process/CONFIG_GUIDE.md (已有) | 保留路由 |
| §9 使用流程(UX) | docs/ux/UX_GUIDE.md (已有) | 保留路由 |
| §10.1 PR规则(详细) | docs/process/CONVENTIONS.md | 保留PR规则摘要+链接 |
| §11 代码审查流程(详细) | docs/process/CONVENTIONS.md | 保留审查流程摘要+链接 |
| §12 命令与脚本 | 保留(核心命令列表) | 保留 |
| §13 临时文件管理规范 | 保留(重要规范) | 保留 |
| §13.1 文档编写规范 | doc/policies/safety.md | 保留核心要点+链接 |
| §14 AI自动维护机制 | 保留(自动化相关) | 保留 |
| §15 参考与链接 | 保留(路由索引) | 保留 |

**目标**: 根agent.md保留≤500行,重点是路由、核心命令、重要规范

#### 模块文档迁移
| 当前位置 | 迁移后位置 |
|---------|----------|
| modules/<entity>/CHANGELOG.md | modules/<entity>/doc/CHANGELOG.md |
| modules/<entity>/CONTRACT.md | modules/<entity>/doc/CONTRACT.md |
| modules/<entity>/PROGRESS.md | modules/<entity>/doc/PROGRESS.md |
| modules/<entity>/BUGS.md | modules/<entity>/doc/BUGS.md |
| modules/<entity>/RUNBOOK.md | modules/<entity>/doc/RUNBOOK.md |
| modules/<entity>/TEST_PLAN.md | modules/<entity>/doc/TEST_PLAN.md |

**保留在模块根目录**: agent.md (新增), README.md, plan.md

#### 数据库文件迁移
| 当前位置 | 迁移后位置 | 备注 |
|---------|----------|------|
| migrations/*.sql | db/engines/postgres/migrations/*.sql | 保留migrations/作为兼容别名(README指向) |
| docs/db/DB_SPEC.yaml | db/engines/postgres/docs/DB_SPEC.yaml | 或逐步拆分为tables/*.yaml |
| docs/db/SCHEMA_GUIDE.md | db/engines/postgres/docs/SCHEMA_GUIDE.md | 或生成为SCHEMA_CATALOG.md |

---

## 3. 模块实例标准结构

### 3.0 应用层与模块层职责划分

> **重要说明**：根目录可能有`app/`或`frontend/`目录，需要明确它们与`modules/`下子目录的职责边界。

#### 核心原则
```
根目录app/frontend/ = 应用层（Application Layer）
    - 职责：入口、路由分发、全局中间件、通用组件
    - 不含：业务逻辑

modules/<entity>/api/frontend/ = 模块层（Module Layer）
    - 职责：模块特定的业务实现
    - 包含：该模块的具体功能实现
```

#### 调用关系
```
后端: app/ → modules/<entity>/api/ → modules/<entity>/core/
前端: frontend/ → modules/<entity>/frontend/ → API调用
```

#### 判断标准：模块是否需要api/或frontend/子目录？

**后端：是否需要api/？**
- 该模块对外提供HTTP接口？→ **是** → 创建`api/`子目录
- 纯内部模块、工具模块？→ **否** → 不创建`api/`，仅有`core/`

**前端：是否需要frontend/？**
- 该模块有特定的UI页面或组件？→ **是** → 创建`frontend/`子目录
- 纯后端模块或使用通用组件？→ **否** → 不创建`frontend/`

#### 模块实例标准目录结构
```text
modules/<entity>/
├── agent.md              # 模块实例agent.md（YAML+MD）
├── README.md             # 模块说明（人读）
├── plan.md               # 开发计划
├── doc/                  # 文档子目录
│   ├── CHANGELOG.md
│   ├── CONTRACT.md       # 接口契约：API+前端组件说明
│   ├── PROGRESS.md
│   ├── BUGS.md
│   ├── RUNBOOK.md
│   └── TEST_PLAN.md
├── core/                 # 核心业务逻辑（必需）
│   ├── __init__.py
│   ├── service.py
│   └── processor.py
├── api/                  # HTTP接口（可选，如提供API）
│   ├── __init__.py
│   ├── routes.py
│   └── handlers.py
├── frontend/             # 前端（可选，如有UI）
│   ├── views/
│   ├── components/
│   └── api/client.ts
├── models/               # 数据模型（可选）
│   ├── __init__.py
│   └── entities.py
└── utils/                # 工具函数（可选）
```

#### 文档记录要求
| 信息类型 | 记录位置 | 说明 |
|---------|---------|------|
| 功能概述、目录结构说明 | README.md | 必须有"目录结构"章节，说明各子目录职责 |
| API接口定义 | doc/CONTRACT.md | HTTP接口、请求响应格式 |
| 前端组件说明 | doc/CONTRACT.md | 组件Props、Events、使用示例 |
| 内部架构 | README.md | 核心组件、数据流、设计模式 |

> 详细说明见`temp/app_frontend_职责划分说明.md`

---

## 4. agent.md v2 规范

### 4.1 YAML Front Matter (必填字段)

#### 根agent.md
```yaml
---
spec_version: "1.0"
agent_id: "repo"
role: "policy_router"
policies:
  goals_ref: "/doc/policies/goals.md"
  safety_ref: "/doc/policies/safety.md"
merge_strategy: "child_overrides_parent"
quality_gates:
  gates: ["dag_check", "contract_compat", "tests", "docs", "agent_lint", "registry_check", "doc_route_check"]
orchestration_hints:
  routing_tags: ["repo"]
  priority: 10
context_routes:
  always_read:
    - "/doc/policies/goals.md"
    - "/doc/policies/safety.md"
  by_scope:
    - scope: repo
      read: ["/docs/flows/DAG_GUIDE.md", "/docs/process/CONFIG_GUIDE.md", "/doc/orchestration/registry.yaml"]
    - scope: module
      read: ["modules/*/agent.md"]
    - scope: db
      read: ["/db/engines/postgres/docs/DB_SPEC.yaml"]
---
```

#### 模块实例agent.md
```yaml
---
spec_version: "1.0"
agent_id: "modules.example.v1"
role: "示例模块-展示模块结构与文档协同"
level: 1
module_type: "1_example"
ownership:
  code_paths:
    include: ["modules/example/"]
    exclude: ["modules/example/doc/CHANGELOG.md"]
io:
  inputs:
    - name: "user_request"
      schema_ref: "modules/example/doc/CONTRACT.md#inputs"
  outputs:
    - name: "response"
      schema_ref: "modules/example/doc/CONTRACT.md#outputs"
contracts:
  apis: ["modules/example/doc/CONTRACT.md"]
dependencies:
  upstream: []
  downstream: []
constraints:
  - "must follow project conventions"
  - "must maintain test coverage >= 80%"
tools_allowed:
  calls: ["http", "fs.read", "db.query"]
  models: []
quality_gates:
  required_tests: ["unit", "integration", "smoke"]
  coverage_min: 0.80
orchestration_hints:
  triggers: ["on_http_request"]
  routing_tags: ["module:example", "level:1"]
  priority: 5
context_routes:
  always_read:
    - "/doc/policies/goals.md"
    - "/doc/policies/safety.md"
  on_demand:
    - topic: "api"
      paths: ["./doc/CONTRACT.md"]
    - topic: "ops"
      paths: ["./doc/RUNBOOK.md"]
    - topic: "testing"
      paths: ["./doc/TEST_PLAN.md"]
---
```

### 3.2 Markdown正文结构
```markdown
# Summary
简述该Agent能力边界与使用前提。

## Responsibilities
- 职责1: 描述
- 职责2: 描述

## Limitations
- 限制1: 描述
- 限制2: 描述

## I/O Examples
```json
{
  "input": {...},
  "output": {...}
}
```

## Test & SLO
- 测试要求: unit/integration/e2e
- 性能指标: P95 < 200ms

## Runbook
- 故障定位→旁路→回滚→恢复: 链接到./doc/RUNBOOK.md
```

---

## 4. 模块注册表(registry.yaml)

### 4.1 位置与生成方式
- **位置**: `doc/orchestration/registry.yaml`
- **生成方式**: 半自动化
  1. 运行`make registry_gen`扫描modules/目录
  2. 生成registry.yaml草案
  3. 用户审核、补充语义信息(描述、关系等)
  4. 用户确认后保存
  5. 运行`make registry_check`校验完整性

### 4.2 结构示例
```yaml
version: "1.0"
description: "模块类型、实例、依赖关系注册表"

# 模块类型定义
module_types:
  - id: "1_example"
    name: "示例模块类型"
    level: 1
    description: "一级模块-示例类型"
    io_contract: "标准HTTP请求/响应"
  
  # 教辅系统示例
  - id: "1_Assign"
    name: "作业发布"
    level: 1
    description: "作业发布功能模块类型"
  
  - id: "2_Select"
    name: "选题"
    level: 2
    parent: "1_Assign"
    description: "选题功能模块类型"
  
  - id: "3_SelectMethod"
    name: "选题方式"
    level: 3
    parent: "2_Select"
    description: "选题方式模块类型(如AI选题、手动选题)"

# 模块实例
module_instances:
  - id: "example.v1"
    type: "1_example"
    path: "modules/example"
    level: 1
    status: "active"
    version: "1.0.0"
    owners: ["@maintainer"]
    agent_md: "modules/example/agent.md"
    readme: "modules/example/README.md"
    contracts: ["modules/example/doc/CONTRACT.md"]
    upstream: []
    downstream: []
    tags: ["example", "reference"]
```

---

## 5. 数据库治理与半自动化(重要)

### 5.1 目录结构
```text
db/
├── registry.yaml                 # 数据引擎/实例/扩展注册表
└── engines/
    ├── postgres/
    │   ├── migrations/           # 原migrations/迁移至此
    │   │   ├── 001_*_up.sql
    │   │   └── 001_*_down.sql
    │   ├── schemas/
    │   │   └── tables/           # 每张表一个YAML
    │   │       ├── runs.yaml
    │   │       └── users.yaml
    │   ├── extensions/           # pgvector/timescaledb配置
    │   │   ├── pgvector.yaml
    │   │   └── timescaledb.yaml
    │   └── docs/                 # 原docs/db/迁移至此
    │       ├── DB_SPEC.yaml      # 或逐步废弃
    │       └── SCHEMA_CATALOG.md # 自动生成
    └── redis/                    # 如需要
        ├── schemas/keys/
        └── docs/
```

### 5.2 表结构YAML标准
**位置**: `db/engines/postgres/schemas/tables/<table_name>.yaml`

**格式**(最小必需):
```yaml
table: public.runs
version: 1
description: "运行记录表"
columns:
  - name: run_id
    type: uuid
    primary_key: true
    nullable: false
    default: gen_random_uuid()
    comment: "运行唯一标识"
  - name: agent
    type: text
    nullable: false
  - name: created_at
    type: timestamp
    nullable: false
    default: CURRENT_TIMESTAMP
indexes:
  - name: idx_runs_created_at
    columns: [created_at]
    order: desc
constraints:
  - type: check
    expr: "latency_ms >= 0"
relations:
  - type: fk
    column: user_id
    ref: "public.users(id)"
security:
  pii: none  # none/internal/personal/sensitive
  rls: false
lifecycle:
  retention: "365d"
extensions:
  uses: []  # [pgvector, timescaledb]
```

### 5.3 半自动化流程

#### 流程图
```
1. 大模型与用户交互 → 明确DB变更意图
                    ↓
2. 生成YAML意图文件或通过CLI参数
                    ↓
3. make db_plan → 生成up/down SQL草案
                    ↓
4. 预览DDL差异、影响面提示
                    ↓
5. 用户确认(y/N) ← 破坏性操作需额外确认短语
                    ↓
6. make db_apply → 执行迁移(dry-run或真实)
                    ↓
7. 内省DB → 更新表YAML → 生成SCHEMA_CATALOG.md
                    ↓
8. 运行db_lint/migrate_check校验
                    ↓
9. 验证: CRUD冒烟 + rollback_check
                    ↓
10. 输出变更报告
```

#### 命令说明
```bash
# 1. 规划迁移(预览)
make db_plan [TARGET=dev|staging|prod] [URL=...]
# 输出: up/down SQL草案、DDL差异、影响面提示

# 2. 执行迁移(半自动)
make db_apply [TARGET=dev] [DRY_RUN=0] [MODE=auto|manual|sync-only] [PROTECT_DROP=1]
# - DRY_RUN=1: 仅预览,不执行(CI永远为1)
# - DRY_RUN=0: 真实执行(需二次确认)
# - MODE=auto: 自动执行(默认,需确认)
# - MODE=manual: 仅生成SQL和报告,人工执行
# - MODE=sync-only: 已人工执行,仅同步文档
# - PROTECT_DROP=1: 禁止自动执行DROP(默认)

# 3. 生成文档
make db_docgen
# 输出: db/engines/postgres/docs/SCHEMA_CATALOG.md

# 4. 校验
make db_lint
# 聚合: migrate_check + db_spec_align_check
```

### 5.4 安全边界
1. **准入门槛**: 必须有`modules/<name>/plan.md`中的DB变更条目且获批
2. **CI行为**: 永远不连生产库,仅做语法/幂等/事务/对齐校验与dry-run
3. **破坏性操作保护**: 
   - DROP TABLE/COLUMN需额外确认短语: `CONFIRM="I-UNDERSTAND"`
   - 默认`PROTECT_DROP=1`阻止自动DROP
4. **目标库选择优先级**(高→低):
   - 命令行: `TARGET=dev|staging|prod`或`URL=postgres://...`
   - 环境变量: `DATABASE_URL`/`POSTGRES_URL`
   - 配置文件: `config/<env>.yaml`的`db.url`
   - 默认: 本地docker-compose(postgres:16)

### 5.5 新增脚本
1. `scripts/db_spec_align_check.py` - 迁移与文档同步检查
2. `scripts/docgen_db.py` - 汇总表YAML生成SCHEMA_CATALOG.md
3. `scripts/db_plan.py` - 生成迁移计划(可选,也可集成到db_apply)
4. `scripts/db_apply.py` - 执行迁移并同步文档(可选,也可用shell+Python组合)

### 5.6 大模型交互规范
**在`doc/modules/MODULE_INIT_GUIDE.md`中说明**:
1. 大模型收到DB变更需求后,询问用户:
   - 要添加/修改哪些表/列/索引?
   - 是否有特殊约束(PII/RLS/retention)?
2. 生成YAML意图文件或直接调用`make db_plan`
3. 展示预览结果给用户确认
4. 用户确认后执行`make db_apply`
5. 验证成功后更新`plan.md`和相关文档

---

## 6. 新增脚本与校验

### 6.1 agent.md相关
**scripts/agent_lint.py**
- 功能: 遍历所有agent.md,校验YAML前言
- 依赖: schemas/agent.schema.yaml
- 输出: 错误报告(缺失字段、类型错误等)

**scripts/registry_check.py**
- 功能: 校验registry.yaml
- 检查: 实例ID唯一、引用完整(agent_md路径存在)、DAG无环
- 输出: 错误报告

**scripts/doc_route_check.py**
- 功能: 校验context_routes路径
- 检查: 所有路径指向的文档存在
- 输出: 缺失文档列表

### 6.2 数据库相关
**scripts/db_spec_align_check.py**
- 功能: 检查迁移与文档同步
- 检查: 有迁移变更时,schemas/tables/*.yaml或DB_SPEC.yaml是否同步更新
- 输出: 未同步的表列表

**scripts/docgen_db.py**
- 功能: 汇总表YAML生成SCHEMA_CATALOG.md
- 输入: db/engines/postgres/schemas/tables/*.yaml
- 输出: db/engines/postgres/docs/SCHEMA_CATALOG.md

### 6.3 registry半自动化
**scripts/registry_gen.py** (新增)
- 功能: 扫描modules/目录,生成registry.yaml草案
- 输出: doc/orchestration/registry.yaml.draft
- 用户审核后重命名为registry.yaml

### 6.4 Makefile新增命令
```makefile
# agent.md相关
agent_lint:
	@python scripts/agent_lint.py

registry_check:
	@python scripts/registry_check.py

doc_route_check:
	@python scripts/doc_route_check.py

# registry半自动化
registry_gen:
	@python scripts/registry_gen.py
	@echo "✅ 草案已生成: doc/orchestration/registry.yaml.draft"
	@echo "请审核并重命名为 registry.yaml"

# 数据库相关
db_plan:
	@python scripts/db_plan.py $(TARGET) $(URL)

db_apply:
	@python scripts/db_apply.py $(TARGET) $(URL) $(DRY_RUN) $(MODE) $(PROTECT_DROP)

db_docgen:
	@python scripts/docgen_db.py

db_lint:
	@python scripts/migrate_check.py
	@python scripts/db_spec_align_check.py

# 更新dev_check
dev_check: docgen doc_style_check dag_check contract_compat_check \
           deps_check runtime_config_check migrate_check consistency_check \
           frontend_types_check agent_lint registry_check doc_route_check \
           db_lint
	@echo "✅ 全部检查通过"
```

---

## 7. 初始化规范(大模型交互为主)

### 7.1 项目初始化规范
**位置**: `doc/init/PROJECT_INIT_GUIDE.md`

**核心内容**(为大模型设计):
1. **对话范式**:
   - 大模型: "您想如何初始化项目?"
   - 提供四种选项: 有文档/无文档/手动/导入其他项目
   - 根据用户选择进入不同流程

2. **信息收集清单**:
   - 项目目标、范围、非目标
   - 技术栈(Python/Go/Vue等)
   - 数据库(PostgreSQL/MySQL/MongoDB等)
   - 质量门槛(测试覆盖率、SLA等)
   - 合规要求(PII处理、审计等)

3. **生成骨架**:
   - 根agent.md(轻量,补齐YAML前言)
   - doc/下的子目录和文档
   - config/下的配置文件
   - registry.yaml初版

4. **确认门槛**:
   - 展示生成的结构
   - 用户确认后执行`make dev_check`
   - 全绿后提示删除init/和TEMPLATE_USAGE.md

5. **大模型行为规范**:
   - 引导用户完成信息收集
   - 不要跳过确认步骤
   - 满足根agent.md要求
   - 遵循文档编写规范

### 7.2 模块初始化规范
**位置**: `doc/modules/MODULE_INIT_GUIDE.md`

**核心内容**(为大模型设计):
1. **对话范式**:
   - 大模型: "请描述要创建的模块功能"
   - 询问: 模块类型(一级/二级/三级/四级)
   - 询问: 是否有需求文档?
   - **询问: 该模块是否对外提供HTTP接口？**(决定是否创建api/)
   - **询问: 该模块是否有特定的前端页面或组件？**(决定是否创建frontend/)
   - **询问: 该模块是否有数据模型？**(决定是否创建models/)
   - 迭代澄清直到需求明确

2. **生成目录**:
   - modules/<entity>/agent.md (YAML+MD)
   - modules/<entity>/README.md (包含"目录结构"章节)
   - modules/<entity>/plan.md
   - modules/<entity>/doc/ (6个文档模板)
   - modules/<entity>/core/ (必需)
   - modules/<entity>/api/ (根据询问结果，可选)
   - modules/<entity>/frontend/ (根据询问结果，可选)
   - modules/<entity>/models/ (根据询问结果，可选)

3. **补齐agent.md**:
   - 引导填写YAML必填项
   - level, module_type
   - ownership.code_paths
   - io.inputs/outputs
   - dependencies.upstream/downstream
   - context_routes

4. **注册编排**:
   - 在registry.yaml登记类型/实例/上下游
   - 或使用`make registry_gen`半自动生成后手动补充

5. **准入检查**:
   - plan.md已填写且获批
   - agent.md通过`make agent_lint`
   - registry.yaml通过`make registry_check`

6. **数据库变更**(如需要):
   - 引导用户说明表结构需求
   - 调用`make db_plan`生成SQL草案
   - 用户确认后执行`make db_apply`

7. **大模型行为规范**:
   - 正确初始化模块实例(包含必需的core/和可选的api/frontend/)
   - 在README.md中增加"目录结构"章节，说明各子目录职责
   - 在doc/CONTRACT.md中区分API接口和前端组件说明(如有)
   - 准确修改registry.yaml
   - 遵循agent.md v2规范
   - 不跳过确认步骤

8. **职责边界检查**:
   - app/routes/中不应有业务逻辑 → 业务逻辑应在modules/<entity>/core/
   - frontend/components/中不应有业务逻辑 → 业务组件应在modules/<entity>/frontend/
   - modules/<entity>/api/调用modules/<entity>/core/，不直接操作数据库

---

## 8. 实施阶段

### Phase 0: 准备与方案确认(当前)
- [x] 遍历当前repo
- [x] 阅读需求文档和参考方案
- [x] 收集用户反馈
- [x] 整合所有信息形成正式方案
- [ ] 与用户确认最终方案
- [ ] 细化执行计划

### Phase 1: Schema与基础设施(3-5天)
**目标**: 建立Schema和校验脚本,不改动现有核心文件

**子任务**:
1. 从Enhancement-Pack复制schemas/agent.schema.yaml
2. 从Enhancement-Pack复制scripts/{agent_lint.py, registry_check.py, doc_route_check.py}
3. 新增scripts/registry_gen.py
4. Makefile新增命令(警告模式)
5. 测试三校验脚本

**验收**: 三校验脚本可运行,输出警告(允许不通过)

### Phase 2: 目录结构调整(5-7天)
**目标**: 新增doc/和db/下的子目录,不迁移现有内容

**子任务**:
1. 创建doc/orchestration/, doc/policies/, doc/indexes/, doc/init/, doc/modules/目录
2. 从Enhancement-Pack复制doc/下的文档和模板
3. 创建db/目录和子目录(空,占位README)
4. doc/orchestration/registry.yaml初版(仅含example模块)
5. 运行`make registry_check`(允许警告)

**验收**: 新目录创建成功,文档可访问

### Phase 3: 根agent.md轻量化(3-5天)
**目标**: 迁移根agent.md内容,补齐YAML前言

**子任务**:
1. 盘点根agent.md章节,建立迁移映射表(见2.2节)
2. 迁移详细内容到doc/下对应文档
3. 精简根agent.md,补齐YAML前言
4. 根README.md顶部添加声明"编排系统请读agent.md"
5. 运行`make agent_lint`(应通过)

**验收**: 根agent.md≤500行,`make agent_lint`通过,路由正确

### Phase 4: 模块实例标准化(3-5天)
**目标**: 为example模块补齐agent.md和doc/子目录

**子任务**:
1. 为modules/example/创建agent.md(从Enhancement-Pack复制并调整)
2. 创建modules/example/doc/子目录
3. 迁移6个文档到doc/
4. 更新modules/example/README.md
5. 在registry.yaml注册example模块
6. 运行三校验(应通过)

**验收**: example模块符合新标准,三校验通过

### Phase 5: 数据库治理实施(5-7天)
**目标**: 建立db/目录结构,实现半自动化

**子任务**:
1. 创建db/engines/postgres/目录结构
2. 迁移migrations/到db/engines/postgres/migrations/
3. 迁移docs/db/到db/engines/postgres/docs/
4. 为核心表创建tables/*.yaml
5. 新增scripts/db_spec_align_check.py, docgen_db.py
6. 新增scripts/db_plan.py, db_apply.py(或shell脚本)
7. Makefile新增db相关命令
8. 测试半自动化流程
9. 更新相关文档和脚本的路径引用

**验收**: 数据库半自动化流程可用,`make db_lint`通过

### Phase 6: 初始化规范完善(2-3天)
**目标**: 完善PROJECT_INIT_GUIDE.md和MODULE_INIT_GUIDE.md

**子任务**:
1. 更新doc/init/PROJECT_INIT_GUIDE.md(增加对话范式)
2. 更新doc/modules/MODULE_INIT_GUIDE.md(增加DB变更引导)
3. 更新scripts/ai_begin.sh以支持新结构
4. 测试模块初始化流程

**验收**: 按指南可完成初始化,生成的结构通过校验

### Phase 7: CI集成与测试(2-3天)
**目标**: 将所有校验集成到dev_check和CI

**子任务**:
1. Makefile: dev_check增加agent_lint, registry_check, doc_route_check, db_lint
2. 更新.github/workflows/ci.yml(如有)
3. 全面测试dev_check
4. 修复发现的问题

**验收**: `make dev_check`全部通过,CI绿色

### Phase 8: 文档更新与收尾(2-3天)
**目标**: 更新所有相关文档,确保一致性

**子任务**:
1. 更新README.md, QUICK_START.md, TEMPLATE_USAGE.md
2. 更新agent.md中的路径引用
3. 更新其他文档中的路径引用
4. 生成路径迁移映射表
5. 运行完整检验
6. 生成验收报告

**验收**: 所有文档路径正确,`make dev_check`通过,验收报告完整

---

## 9. 验收标准

### 9.1 Repo级
- [ ] 根agent.md≤500行,含合并策略与路由,无大段流程性内容
- [ ] 根README.md顶部有"编排系统请读agent.md"声明
- [ ] schemas/agent.schema.yaml存在且完整
- [ ] doc/orchestration/registry.yaml列举所有模块与关系
- [ ] doc/下所有子目录创建完成,文档齐全
- [ ] db/目录结构建立,核心表有YAML
- [ ] `make agent_lint`通过
- [ ] `make registry_check`通过
- [ ] `make doc_route_check`通过
- [ ] `make db_lint`通过
- [ ] `make dev_check`全部通过

### 9.2 模块级(以example为例)
- [ ] modules/example/agent.md存在(YAML+MD)
- [ ] modules/example/README.md存在，包含"目录结构"章节说明各子目录职责
- [ ] modules/example/plan.md存在
- [ ] modules/example/doc/下6个文档齐全
- [ ] modules/example/core/存在(必需)
- [ ] modules/example/api/和frontend/根据实际需要创建
- [ ] doc/CONTRACT.md区分了API接口和前端组件说明(如有)
- [ ] agent.md的ownership.code_paths合理
- [ ] agent.md的context_routes路径存在
- [ ] 在registry.yaml中注册

### 9.3 数据库级
- [ ] db/engines/postgres/migrations/下有迁移脚本
- [ ] db/engines/postgres/schemas/tables/下有核心表YAML
- [ ] db/engines/postgres/docs/SCHEMA_CATALOG.md可生成
- [ ] `make db_plan`可预览迁移
- [ ] `make db_apply DRY_RUN=1`可运行
- [ ] `make db_docgen`可生成文档
- [ ] `make db_lint`通过

### 9.4 文档级
- [ ] 文档格式符合规范(无颜文字、语言一致、结构化)
- [ ] 代码块正确标记语言
- [ ] 所有路径引用正确
- [ ] 无临时文件残留
- [ ] 路径迁移映射表完整

---

## 10. 风险与缓解

### 10.1 风险
1. **根agent.md拆分**可能导致引用缺失
2. **模块文档迁移**可能影响现有脚本(consistency_check.py等)
3. **数据库目录调整**影响面大,需更新多处路径引用
4. **首次改造工作量大**,预计15-25天
5. **用户需要学习新结构**

### 10.2 缓解措施
1. 保留根agent.md.bak副本,可随时回滚
2. 路径适配时先保留兼容别名(如migrations/放README指向新路径)
3. 分阶段推进,每个阶段都可独立验证,出问题可回滚
4. 更新所有涉及路径的文档和脚本,使用查找替换工具
5. 提供路径迁移映射表和详细的使用指导(更新QUICK_START.md)
6. 在TEMPLATE_USAGE.md中增加"新旧路径对照"章节

---

## 11. 资源需求

### 11.1 人力
- **大模型执行**: 15-25天(按Phase划分)
- **用户审核确认**: 每个Phase结束需1-2小时审核

### 11.2 环境
- 本地开发环境(Python 3.11+)
- Docker(用于测试db_apply)
- Git(用于版本控制和回滚)

### 11.3 依赖
- Enhancement-Pack中的文件(可直接复制)
- 参考方案中的脚本示例
- 用户提供的项目特定信息

---

## 12. 后续计划

改进完成后,建议:
1. **用户培训**: 介绍新结构和使用方式
2. **文档优化**: 根据使用反馈持续优化
3. **模板推广**: 分享给团队其他项目使用
4. **功能扩展**: 根据实际需求增加新的自动化功能
5. **性能优化**: 监控校验脚本性能,优化慢速检查

---

## 附录A: 路径迁移对照表

| 旧路径 | 新路径 | 备注 |
|--------|--------|------|
| migrations/*.sql | db/engines/postgres/migrations/*.sql | 保留兼容别名 |
| docs/db/DB_SPEC.yaml | db/engines/postgres/docs/DB_SPEC.yaml | 或拆分为tables/*.yaml |
| docs/db/SCHEMA_GUIDE.md | db/engines/postgres/docs/SCHEMA_CATALOG.md | 自动生成 |
| modules/example/CHANGELOG.md | modules/example/doc/CHANGELOG.md | 6个文档均迁移 |
| modules/example/CONTRACT.md | modules/example/doc/CONTRACT.md | |
| modules/example/PROGRESS.md | modules/example/doc/PROGRESS.md | |
| modules/example/BUGS.md | modules/example/doc/BUGS.md | |
| modules/example/RUNBOOK.md | modules/example/doc/RUNBOOK.md | |
| modules/example/TEST_PLAN.md | modules/example/doc/TEST_PLAN.md | |

---

## 附录B: 参考资源

### 已参考文档
- temp/完善模板和文档(需求).md
- temp/参考方案和建议/修改和完善建议.md
- temp/参考方案和建议/AI-TEMPLATE_Improvement_Plan_v1.md
- temp/参考方案和建议/EXECUTION_PLAN.md
- temp/参考方案和建议/AI-TEMPLATE-Enhancement-Pack/

### 用户反馈记录
- temp/用户反馈记录.md

### 执行计划
- temp/执行计划.md (草案→正式版)

---

**版本历史**:
- v1.0 (2025-11-07): 正式版,整合所有需求和参考方案,增加数据库半自动化


