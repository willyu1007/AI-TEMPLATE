# AI-TEMPLATE Repo 阅读笔记

## 创建日期
2025-11-07

## 目标
记录阅读当前repo和需求文档的过程,形成对改进方向的清晰认知

---

## 第一部分:当前Repo结构分析

### 1.1 核心文档
- **README.md**: 项目说明,目标受众是人类用户
- **agent.md**: AI工作指南(2434行),非常详细,包含:
  - S0-S6工作流程
  - 测试准则(Python/Vue/Go)
  - PR规则和代码审查流程
  - 文档编写规范
  - 临时文件管理规范
- **QUICK_START.md**: 快速开始指南
- **TEMPLATE_USAGE.md**: 模板使用说明

### 1.2 目录结构
```
.
├── agent.md                 # AI工作指南(核心)
├── README.md                # 项目说明(人读)
├── QUICK_START.md           # 快速开始
├── TEMPLATE_USAGE.md        # 模板使用
├── Makefile                 # 统一命令入口
├── .aicontext/              # AI上下文索引
├── ai/                      # AI会话记录
│   ├── LEDGER.md           # 任务清册
│   └── maintenance_reports/ # 维护报告
├── config/                  # 配置文件
├── docs/                    # 项目文档
│   ├── project/            # 项目级文档
│   ├── process/            # 流程规范
│   ├── db/                 # 数据库文档
│   ├── flows/              # 流程图
│   ├── ux/                 # UX文档
│   └── adr/                # 架构决策记录
├── flows/                   # DAG配置
│   └── dag.yaml
├── migrations/              # 数据库迁移
├── modules/                 # 业务模块
│   └── example/            # 示例模块
├── scripts/                 # 自动化脚本(20个)
├── tests/                   # 测试
├── tools/                   # 工具契约
├── common/                  # 共享代码库
└── observability/           # 可观测性配置
```

### 1.3 自动化工具链(Makefile + scripts/)
**核心命令**:
- `make dev_check`: 完整开发检查(CI门禁)
- `make docgen`: 生成文档索引
- `make ai_begin MODULE=<name>`: 初始化模块
- `make dag_check`: DAG拓扑校验
- `make contract_compat_check`: 契约兼容性检查
- `make ai_maintenance`: AI自动维护
- `make cleanup_tmp`: 清理临时文件

**scripts/ 目录下的脚本**(20个):
1. `ai_begin.sh` - 模块初始化
2. `ai_maintenance.py` - AI自动维护
3. `app_structure_check.py` - 应用层结构检查
4. `consistency_check.py` - 一致性检查
5. `contract_compat_check.py` - 契约兼容性
6. `dag_check.py` - DAG校验
7. `dataflow_trace.py` - 数据流追踪
8. `deps_manager.py` - 依赖管理
9. `doc_style_check.py` - 文档风格检查
10. `docgen.py` - 文档索引生成
11. `encoding_check.py` - 编码检查
12. `frontend_types_check.py` - 前端类型检查
13. `generate_frontend_types.py` - 生成前端类型
14. `generate_openapi.py` - 生成OpenAPI
15. `migrate_check.py` - 迁移脚本检查
16. `rollback_check.sh` - 回滚验证
17. `runtime_config_check.py` - 配置校验
18. `test_scaffold.py` - 测试脚手架
19. `test_status_check.py` - 测试状态检查
20. `validate.sh` - 聚合验证

### 1.4 模块结构
每个模块需要8个必备文档:
1. README.md - 模块说明
2. plan.md - 开发计划
3. CONTRACT.md - 接口契约
4. TEST_PLAN.md - 测试计划
5. RUNBOOK.md - 运维手册
6. PROGRESS.md - 进度跟踪
7. BUGS.md - 缺陷管理
8. CHANGELOG.md - 变更日志

### 1.5 工作流程(S0-S6)
- **S0**: 刷新上下文(分层读取文档)
- **S1**: 任务建模(更新plan.md)
- **S2**: 方案预审(生成AI-SR-plan.md)
- **S3**: 实现与最小验证
- **S4**: 文档与索引更新
- **S5**: 自审与PR(生成AI-SR-impl.md)
- **S6**: 自动维护(make ai_maintenance)

---

## 第二部分:需求文档分析

### 2.1 核心目标(来自需求文档)
1. **AI友好和模块化为核心导向**
2. **自动化流程的完备程度为评价标准**
3. **融入和适配智能体编排体系**
4. **repo骨架为模板,文档为通用文档(项目无关)**

### 2.2 关键需求点

#### 2.2.1 模块(Modules)概念
- 模块分为不同类型,同类型可相互替换
- 每个模块实例可以有独立的前端、后端、核心逻辑
- 模块分级:一级、二级、三级、四级
- 模块间关系需要单独维护

**示例**: 教辅系统
- 一级模块: 1_Assign, 1_Collect, 1_Overview, 1_Grading
- 二级模块: 2_Select, 2_Assemble, 2_Setting
- 三级模块实例: M_AI_Select, M_Manual_Select

**需要为每个模块实例增加agent.md文档**,实现:
1. 模块信息文档维护流程
2. 模块开发过程中其他文档维护流程
3. 开发过程中代码大模型正确获取必要知识和上下文的方式和流程

#### 2.2.2 README.md vs agent.md职责边界
**README.md**(人读):
- 内容: 项目简介、使用示例、安装方式、依赖环境
- 职责: 建立项目上下文、识别代码入口、识别整体结构
- 对象: 人

**agent.md**(模型读):
- 内容: 角色、职责、边界、接口、依赖关系、可操作范围
- 职责: 任务分解、行为约束、调度方式
- 对象: 大模型

**要求**: 多层级目录下分别维护独立的agent.md和README.md

#### 2.2.3 agent.md轻量化
- 根目录agent.md过重(当前2434行)
- 按功能划分,维护路由,让大模型按需读取
- 维护每次必读内容: 全局目标、通用安全和质量门槛
- 分层级给出文档阅读建议

#### 2.2.4 骨架结构调整
1. 给每个模块实例增加agent.md和README.md
2. 模块实例新增doc目录: `/modules/<entity>/doc/`
3. 模块实例目录下只放: agent.md, plan.md, README.md
4. 根目录doc/下增加多个目录,用于承接从agent.md提取的内容
5. 增加专门目录规范和更新模块信息

#### 2.2.5 初始化引导
**项目初始化**:
- 提供四种方式: 有开发文档、无开发文档、手动、导入其他项目
- 初始化后删除: 初始化目录, TEMPLATE_USAGE.md

**模块初始化**:
- 结合实际功能需求初始化模块实例
- 询问是否有需求文档
- 确认开发需求后修改相关文档
- 完成后按规范修改接口文档、agent.md等

#### 2.2.6 智能体编排体系
**agent.md在编排中的职责**:
- 角色(Role)
- 输入输出(I/O schema)
- 权限与依赖
- 上下游关系
- 职责边界(responsibilities)
- 限制条件(constraints)

**要求采用结构化约定**(YAML/markdown混合),便于解析

**目录层级与继承**:
- 根目录/agent.md: 全局目标、默认策略、通用安全与质量门槛、路由
- 子目录/agent.md: 继承根策略,声明本模块可改动路径,子级覆盖父级

#### 2.2.7 其他需求
- 逐文档检查正确性,输出错误报告
- 解决模型并行开发冲突问题(在plan.md中明确执行人)

---

## 第三部分:当前Repo与需求的对应关系

### 3.1 已满足的需求
✅ 1. 工作流程完整(S0-S6)
✅ 2. 自动化工具链完善(Makefile + 20个脚本)
✅ 3. 模块8个必备文档标准
✅ 4. README.md vs agent.md职责已有一定区分
✅ 5. 文档编写规范详细(agent.md §13)
✅ 6. 临时文件管理规范清晰
✅ 7. 测试准则完善(Python/Vue/Go)
✅ 8. PR规则和代码审查流程详细

### 3.2 需要改进的地方
❌ 1. **agent.md过重**(2434行),需要轻量化
❌ 2. **缺少模块实例级别的agent.md**标准
❌ 3. **缺少模块关系维护机制**(模块类型、实例、依赖关系)
❌ 4. **缺少YAML前言的统一Schema**
❌ 5. **缺少项目初始化和模块初始化的规范化流程**
❌ 6. **缺少模块文档doc子目录**的结构
❌ 7. **缺少智能体编排注册表**(registry.yaml)
❌ 8. **缺少agent.md的自动校验机制**
❌ 9. **README.md中未声明**"编排系统请读agent.md"
❌ 10. **根目录doc/下未分类**存放从agent.md提取的内容

### 3.3 需要新增的内容
📝 1. `schemas/agent.schema.yaml` - agent.md YAML前言校验Schema
📝 2. `doc/orchestration/registry.yaml` - 模块类型/实例/依赖/上下游关系
📝 3. `doc/orchestration/routing.md` - 路由策略与合并规则
📝 4. `doc/policies/goals.md` - 全局目标/成功标准/质量门槛
📝 5. `doc/policies/safety.md` - 通用安全/合规
📝 6. `doc/indexes/context-rules.md` - 上下文抽取/切片/屏蔽策略
📝 7. `doc/init/PROJECT_INIT_GUIDE.md` - 项目初始化规范
📝 8. `doc/modules/MODULE_INIT_GUIDE.md` - 模块初始化规范
📝 9. `scripts/agent_lint.py` - agent.md校验脚本
📝 10. `scripts/registry_check.py` - registry.yaml校验脚本
📝 11. `scripts/doc_route_check.py` - 文档路由校验脚本

---

## 第四部分:参考方案要点

### 4.1 修改和完善建议.md要点
**核心结论**:
- 优势: 已有清晰骨架、质量门禁、自动化脚本
- 主要短板: agent.md过重(>1350行)、模块实例层未形成标准、初始化流程未可编排化
- 改造抓手(优先级): 
  1. agent.md v2统一Schema
  2. 根agent.md轻量化
  3. 模块实例补齐agent.md + doc/
  4. 增加registry.yaml和agent.schema.yaml
  5. 增加初始化规范
  6. 新增三校验CI
  7. README与agent.md职责分离
  8. 需求→编码→测试→文档闭环工具化

**目录骨架建议**:
- schemas/agent.schema.yaml
- doc/orchestration/registry.yaml, routing.md
- doc/policies/goals.md, safety.md
- doc/indexes/context-rules.md
- doc/init/PROJECT_INIT_GUIDE.md
- doc/modules/MODULE_INIT_GUIDE.md + TEMPLATES/
- modules/<entity>/agent.md, README.md, plan.md, doc/

### 4.2 AI-TEMPLATE_Improvement_Plan_v1.md要点
**设计原则**:
1. AI友好: 文档可解析、上下文按需加载、路径路由清晰
2. 模块化: 同类型可替换、实例独立、I/O稳定
3. 自动化: 一切可校验、可脚本化、可CI化
4. 可编排: Orchestrator能自动读取/合并agent.md
5. 安全与质量: 默认最小权限、测试覆盖率门槛前置

**验收矩阵**:
- Repo级: agent.md轻量、Schema存在、registry.yaml完整、CI通过
- 模块级: agent.md/README/plan/doc完整、ownership合理、plan获批

### 4.3 EXECUTION_PLAN.md要点
**数据库治理方案**(重要,用户要求):
1. **目录调整**:
   - `db/` 新目录
   - `db/registry.yaml` - 数据引擎/实例/扩展注册表
   - `db/engines/postgres/migrations/` - 原migrations/迁移
   - `db/engines/postgres/schemas/tables/*.yaml` - 每张表一个YAML
   - `db/engines/postgres/docs/` - 原docs/db/迁移

2. **表结构YAML标准**(最小必需):
   ```yaml
   table: public.runs
   version: 1
   description: 描述
   columns: [...]
   indexes: [...]
   constraints: [...]
   relations: [...]
   security: {pii: none/internal/personal/sensitive, rls: true/false}
   lifecycle: {retention: 365d}
   extensions: {uses: []}
   ```

3. **自动化执行策略**(半自动化):
   - 准入: plan.md声明DB变更且获批后才允许db_apply
   - 顺序: preview(dry-run) → 人工确认 → 执行 → 验证
   - 保护: 禁止自动执行破坏性DROP
   - CI: 永远不连生产库,仅做语法/幂等/事务/对齐校验与dry-run

4. **新增命令**:
   - `make db_plan [TARGET=dev|staging|prod]` - 预览迁移
   - `make db_apply [TARGET=...] [DRY_RUN=0|1] [MODE=auto|manual|sync-only]` - 执行迁移
   - `make db_lint` - 聚合migrate_check + db_spec_align_check
   - `make db_docgen` - 生成SCHEMA_CATALOG.md

5. **新增脚本**:
   - `scripts/db_spec_align_check.py` - 迁移与文档同步检查
   - `scripts/docgen_db.py` - 汇总表YAML生成文档

6. **执行流程**(半自动):
   - 输入: 声明要添加/修改的表/列/索引(CLI/交互/YAML意图文件)
   - 生成: up/down SQL草案(自动补全IF NOT EXISTS/事务包裹)
   - 预览: 打印DDL差异、影响面、需更新的代码/契约提示
   - 确认: 交互式二次确认,破坏性操作需额外确认短语
   - 执行: 连接目标库应用迁移
   - 同步: 内省DB → 更新表YAML → 生成SCHEMA_CATALOG.md → 运行校验
   - 验证: 最小CRUD冒烟、rollback_check通过

### 4.4 AI-TEMPLATE-Enhancement-Pack内容
**已有现成文件**:
✅ schemas/agent.schema.yaml - 完整的YAML Schema定义
✅ doc/orchestration/registry.yaml - 模块注册表示例
✅ doc/orchestration/routing.md - 路由策略说明
✅ doc/policies/goals.md, safety.md - 全局策略文档
✅ doc/indexes/context-rules.md - 上下文规则
✅ doc/init/PROJECT_INIT_GUIDE.md - 项目初始化指南
✅ doc/modules/MODULE_INIT_GUIDE.md - 模块初始化指南
✅ doc/modules/TEMPLATES/ - 各种模板文件
✅ modules/example/agent.md - 模块实例agent.md示例
✅ modules/example/doc/ - 6个文档的示例
✅ scripts/agent_lint.py - agent.md校验脚本
✅ scripts/registry_check.py - registry.yaml校验脚本
✅ scripts/doc_route_check.py - 文档路由校验脚本

**可直接复用**: Enhancement-Pack中的大部分文件可以直接复制到repo中使用

---

## 第五部分:用户反馈确认

### 5.1 关键决策
1. ✅ 模块文档迁移到doc/子目录
2. ✅ 根agent.md轻量化到500行以内(以满足AI友好和自动化为准)
3. ✅ registry.yaml半自动化(自动生成+手动确认)
4. ✅ 初始化流程重点是大模型交互,保留手动文档引导
5. ✅ YAML Schema以智能体编排需求为准,尽可能填写
6. ✅ **数据库半自动化操作**(类似registry.yaml方式)

### 5.2 数据库半自动化要点(待整合)
- 参考EXECUTION_PLAN.md中的数据库治理方案
- 目录调整: db/engines/postgres/
- 表结构YAML化
- 新增db_plan/db_apply命令
- 半自动流程: 生成SQL → 预览 → 确认 → 执行 → 同步文档
- 安全边界: plan.md准入、dry-run、禁止自动DROP

---

## 待办事项
- [x] 遍历当前repo
- [x] 阅读需求文档
- [x] 阅读参考方案
- [x] 收集用户反馈
- [ ] 完善修改方案,整合数据库半自动化内容
- [ ] 细化执行计划
- [ ] 与用户确认最终方案
- [ ] 开始执行改进


