# AI-TEMPLATE Repo 改进执行计划

> **状态**: 草案(Draft)
> **创建日期**: 2025-11-07
> **最后更新**: 2025-11-07

---

## 重要说明
本执行计划处于**草案阶段**,在获得最终确认前,**不允许修改temp目录以外的任何文件或目录**。

---

## 0. 目标
完善AI-TEMPLATE仓库的结构和文档体系,实现:
1. **AI友好**: 文档可解析、上下文按需加载、路径路由清晰
2. **模块化**: 同类型可替换、实例独立、I/O稳定
3. **自动化**: 一切可校验、可脚本化、可CI化
4. **可编排**: 支持智能体自动读取/合并agent.md,基于标签与约束调度

---

## 1. 改进原则
1. 以AI友好和模块化为核心导向
2. 以自动化流程的完备程度为评价标准
3. 融入和适配智能体编排体系
4. repo骨架为模板,repo中的文档为通用文档(项目无关)
5. 通过初始化引导,将模板转换成项目repo

---

## 2. 执行阶段划分

### Phase 0: 调研与方案确认(当前阶段)
**目标**: 充分理解需求,形成可行方案,获得确认
**状态**: 进行中

**子任务**:
- [x] 遍历当前repo,熟悉架构
- [x] 阅读agent.md和README.md等关键文档
- [x] 了解自动化流程(Makefile + scripts/)
- [ ] 阅读需求文档,理解改进方向
- [ ] 阅读参考方案,吸收好的建议
- [ ] 形成初步改进方案
- [ ] 与用户充分讨论,对齐需求
- [ ] 形成最终执行计划
- [ ] 获得用户确认

**关键产出**:
- [x] 阅读笔记.md (当前repo理解)
- [ ] 修改方案(初稿).md
- [ ] 最终执行计划.md

### Phase 1: 骨架调整与Schema建立(待确认)
**目标**: 建立agent.md v2规范,调整目录结构
**前置条件**: Phase 0完成并获得确认

**子任务**(待细化):
1. 新增schemas/agent.schema.yaml
2. 调整doc/目录结构
3. 为模块实例补齐doc/子目录
4. 建立doc/orchestration/registry.yaml草案
5. 新增agent.md校验脚本

### Phase 2: agent.md轻量化(待确认)
**目标**: 根agent.md轻量化,内容迁移到doc/下
**前置条件**: Phase 1完成

**子任务**(待细化):
1. 盘点根agent.md章节,建立迁移映射表
2. 新建doc/policies/*, doc/init/*, doc/modules/*
3. 迁移根agent.md长段落到对应文档
4. 精简根agent.md,补齐YAML前言与路由
5. 校验路由指向文档存在

### Phase 3: 模块实例标准化(待确认)
**目标**: 为模块实例补齐agent.md和文档结构
**前置条件**: Phase 2完成

**子任务**(待细化):
1. 为示例模块补齐agent.md(YAML+MD)
2. 为示例模块补齐doc/子目录
3. 在agent.md中声明ownership、io、dependencies
4. 在registry.yaml注册模块实例
5. 更新模块初始化脚本

### Phase 4: 初始化规范与校验(待确认)
**目标**: 补齐项目初始化和模块初始化规范,增加CI校验
**前置条件**: Phase 3完成

**子任务**(待细化):
1. 完善PROJECT_INIT_GUIDE.md
2. 完善MODULE_INIT_GUIDE.md
3. Makefile接入三校验(agent_lint, registry_check, doc_route_check)
4. CI接入校验(警告模式)
5. 测试并验证

### Phase 5: 数据库治理实施(待确认)
**目标**: 建立db/目录结构，实现半自动化
**前置条件**: Phase 4完成

**子任务**(待细化):
1. 创建db/engines/postgres/目录结构
2. 迁移migrations/到db/engines/postgres/migrations/
3. 迁移docs/db/到db/engines/postgres/docs/
4. 为核心表创建tables/*.yaml
5. 新增数据库相关脚本
6. Makefile新增db相关命令
7. 测试半自动化流程
8. 更新相关文档和脚本的路径引用

### Phase 6: 初始化规范完善(待确认)
**目标**: 完善PROJECT_INIT_GUIDE.md和MODULE_INIT_GUIDE.md
**前置条件**: Phase 5完成

**子任务**(待细化):
1. 更新PROJECT_INIT_GUIDE.md（增加对话范式）
2. 更新MODULE_INIT_GUIDE.md（增加DB变更引导）
3. 更新scripts/ai_begin.sh以支持新结构
4. 测试模块初始化流程

### Phase 7: CI集成与测试(待确认)
**目标**: 将所有校验集成到dev_check和CI
**前置条件**: Phase 6完成

**子任务**(待细化):
1. Makefile: dev_check增加agent_lint, registry_check, doc_route_check, db_lint
2. 更新.github/workflows/ci.yml(如有)
3. 全面测试dev_check
4. 修复发现的问题

### Phase 8: 文档更新与路径修正(待确认)
**目标**: 更新所有相关文档，确保路径引用正确
**前置条件**: Phase 7完成

**子任务**(待细化):
1. 更新README.md, QUICK_START.md, TEMPLATE_USAGE.md
2. 更新agent.md中的路径引用
3. 更新其他文档中的路径引用
4. 生成路径迁移映射表
5. 运行完整检验

### Phase 9: 文档审查与清理(新增)
**目标**: 全面审查文档质量，清理无效文档，确保格式正确
**前置条件**: Phase 8完成

**子任务**:
1. **文档完整性审查**
   - 检查所有必需文档是否齐全
   - 验证文档间引用的有效性
   - 确认文档路由正确

2. **文档格式审查**
   - 运行`make doc_style_check`检查格式
   - 检查颜文字使用（应无）
   - 检查语言一致性（中英文混用）
   - 检查代码块语言标记
   - 检查数学公式格式（LaTeX）
   - 检查标题层级（无跳级）

3. **文档内容审查**
   - 检查目标和上下文说明是否清晰
   - 检查是否有模糊表达
   - 检查逻辑流程是否使用分步结构
   - 检查是否包含验证步骤和回滚逻辑

4. **无效文档清理**
   - 识别并删除过时文档
   - 清理临时文档（运行`make cleanup_tmp`）
   - 删除.draft后缀的草案文件（如已正式化）
   - 删除重复或冗余文档

5. **路径引用验证**
   - 运行`make doc_route_check`验证所有路由
   - 检查文档内部链接的有效性
   - 验证所有路径引用可访问
   - 生成断链报告

6. **自动化链路测试**
   - 运行完整`make dev_check`
   - 验证所有校验脚本通过
   - 测试半自动化流程（registry_gen, module_doc_gen, db相关）
   - 确认CI流程正常

7. **生成最终报告**
   - 文档审查报告
   - 变更清单
   - 路径映射表
   - 验收报告

**验收标准**:
- [ ] `make doc_style_check`全部通过
- [ ] `make doc_route_check`全部通过
- [ ] 无临时文件残留
- [ ] 所有文档格式符合规范
- [ ] 所有链接和路径有效
- [ ] `make dev_check`全部通过
- [ ] 最终审查报告生成

---

## 3. 关键改进点(草案)

### 3.1 目录结构调整
```text
添加/调整:
.
├── schemas/
│   └── agent.schema.yaml        # 新增
├── doc/
│   ├── orchestration/           # 新增目录
│   │   ├── registry.yaml       # 新增
│   │   └── routing.md          # 新增
│   ├── policies/                # 新增目录
│   │   ├── goals.md            # 新增
│   │   └── safety.md           # 新增
│   ├── indexes/                 # 新增目录
│   │   └── context-rules.md    # 新增
│   ├── init/                    # 新增目录
│   │   └── PROJECT_INIT_GUIDE.md  # 新增
│   └── modules/                 # 新增目录
│       └── MODULE_INIT_GUIDE.md   # 新增
└── modules/
    └── <module-entity>/
        ├── agent.md             # 新增(模块实例级)
        ├── README.md            # 已有
        ├── plan.md              # 已有
        └── doc/                 # 新增目录
            ├── CHANGELOG.md     # 从上级移入
            ├── CONTRACT.md      # 从上级移入
            ├── PROGRESS.md      # 从上级移入
            ├── BUGS.md          # 从上级移入
            ├── RUNBOOK.md       # 从上级移入
            └── TEST_PLAN.md     # 从上级移入
```

### 3.2 agent.md v2 规范(草案)
**结构**: YAML Front Matter + Markdown正文

**YAML最小必需字段**:
```yaml
---
spec_version: "1.0"
agent_id: "repo" 或 "modules.<entity>.<instance>"
role: "角色描述"
level: 1|2|3|4  # 模块层级
module_type: "类型路径"  # 如 "1_Assign/2_Select"
ownership:
  code_paths:
    include: ["可改动路径"]
    exclude: ["只读路径"]
io:
  inputs: [...]
  outputs: [...]
contracts:
  apis: [...]
dependencies:
  upstream: [...]
  downstream: [...]
constraints: [...]
tools_allowed:
  calls: [...]
quality_gates:
  required_tests: [...]
  coverage_min: 0.75
orchestration_hints:
  triggers: [...]
  routing_tags: [...]
context_routes:
  always_read: [...]
  on_demand: [...]
---
```

### 3.3 新增脚本(草案)
1. `scripts/agent_lint.py` - 校验agent.md YAML前言
2. `scripts/registry_check.py` - 校验registry.yaml
3. `scripts/doc_route_check.py` - 校验context_routes路径

### 3.4 Makefile新增命令(草案)
```makefile
agent_lint:             # agent.md校验
registry_check:         # registry.yaml校验
doc_route_check:        # 文档路由校验
init_project:           # 项目初始化(可选)
init_module:            # 模块初始化(可选)
```

---

## 4. 风险与缓解

### 4.1 风险
1. **根agent.md拆分**可能导致引用缺失
2. **registry.yaml不完整**可能导致编排断链
3. **模块文档迁移**可能影响现有脚本
4. **首次改造工作量大**,可能影响项目进度

### 4.2 缓解措施
1. 保留根agent.md副本,可随时回滚
2. registry.yaml增量维护,先覆盖核心模块
3. 路径适配时保留兼容别名
4. 分阶段推进,每个阶段都可独立验证

---

## 5. 验收标准(草案)

### 5.1 Repo级
- [ ] 根agent.md轻量(≤500行)
- [ ] 根agent.md包含§1.3"应用层与模块层职责边界"
- [ ] 根README.md顶部有"编排系统请读agent.md"声明
- [ ] schemas/agent.schema.yaml存在且字段完整
- [ ] doc/orchestration/registry.yaml列举所有模块
- [ ] doc/modules/MODULE_TYPES.md存在
- [ ] doc/modules/MODULE_INSTANCES.md可生成
- [ ] docs/已改名为doc/
- [ ] flows/已移动到doc/flows/
- [ ] db/目录结构建立
- [ ] CI成功跑通所有校验
- [ ] 路由指向的文档均存在

### 5.2 模块级
- [ ] 示例模块存在agent.md/README.md/plan.md/doc/*
- [ ] 示例模块有core/子目录（必需）
- [ ] 示例模块的api/frontend/根据需要创建
- [ ] README.md有"目录结构"章节说明
- [ ] doc/CONTRACT.md区分API和前端组件说明
- [ ] agent.md的ownership.code_paths和tools_allowed合理
- [ ] 模块在registry.yaml中注册

### 5.3 文档级
- [ ] 所有文档格式符合规范(无颜文字、语言一致、结构化)
- [ ] 所有代码块正确标记语言
- [ ] 所有路径索引和路由正确
- [ ] 无临时文件残留
- [ ] 无无效或过时文档
- [ ] 所有文档内部链接有效

### 5.4 自动化级
- [ ] `make agent_lint`通过
- [ ] `make registry_check`通过
- [ ] `make doc_route_check`通过
- [ ] `make module_doc_gen`可运行
- [ ] `make db_lint`通过（如Phase 5完成）
- [ ] `make dev_check`全部通过

---

## 6. 当前状态更新(2025-11-07)

### 已完成
- [x] 遍历当前repo,熟悉架构和自动化流程
- [x] 阅读需求文档(完善模板和文档.md)
- [x] 阅读参考方案(修改和完善建议.md, AI-TEMPLATE_Improvement_Plan_v1.md, EXECUTION_PLAN.md)
- [x] 阅读AI-TEMPLATE-Enhancement-Pack目录
- [x] 收集用户反馈,确认关键决策
- [x] 整合所有信息,形成正式修改方案
- [x] 创建阅读笔记、用户反馈记录、修改方案(初稿和正式版)

### 用户已确认的决策
1. ✅ 模块文档迁移到doc/子目录
2. ✅ 根agent.md轻量化到≤500行
3. ✅ registry.yaml半自动化(自动生成+手动确认)
4. ✅ 初始化流程重点是大模型交互
5. ✅ YAML Schema以智能体编排需求为准,尽可能填写
6. ✅ **数据库半自动化操作**(类似registry.yaml方式)

### 待办
- [ ] 用户审阅修改方案(正式版)
- [ ] 根据用户反馈调整(如有)
- [ ] 获得用户最终确认
- [ ] 开始Phase 1执行

---

## 7. Phase 9详细说明：文档审查与清理流程

### 7.1 目标
确保升级完成后：
- 所有文档质量达标
- 无无效或过时文档
- 格式规范统一
- 路径引用正确
- 自动化链路通畅

### 7.2 审查清单

#### A. 文档完整性审查
```bash
# 1. 检查必需文档
- 根目录: agent.md, README.md, QUICK_START.md, TEMPLATE_USAGE.md, CONTRIBUTING.md
- doc/: orchestration/, policies/, indexes/, init/, modules/等子目录及文档
- modules/<entity>/: agent.md, README.md, plan.md, doc/（6个文档）

# 2. 检查文档间引用
- agent.md中的context_routes指向的文档存在
- README.md中链接的文档存在
- 各模块文档间的交叉引用有效

# 3. 验证命令
make consistency_check
make doc_route_check
```

#### B. 文档格式审查
```bash
# 1. 自动格式检查
make doc_style_check

# 检查项：
- [ ] 无颜文字（除代码示例外）
- [ ] 语言一致性（无中英文混用）
- [ ] 代码块标记语言
- [ ] 数学公式使用LaTeX格式
- [ ] 标题层级正确（无跳级）
- [ ] 无模糊表达
- [ ] 使用逻辑连接词和编号

# 2. 人工抽查
随机抽查3-5个文档，验证：
- 目标和上下文说明清晰
- 操作步骤使用分步结构
- 包含验证步骤（如适用）
- 包含回滚逻辑（如适用）
```

#### C. 无效文档识别与清理
```bash
# 1. 识别无效文档
过时文档标准：
- 指向不存在的路径或文件
- 描述已废弃的功能
- 与当前架构不符
- 标记为"待删除"或"已废弃"

# 2. 临时文件清理
make cleanup_tmp

# 3. 草案文件检查
查找所有.draft文件，确认是否已正式化：
find . -name "*.draft" -type f

# 4. 删除或归档
- 删除：确认无用的文档
- 归档：移动到docs/archived/（如需保留历史）
```

#### D. 路径引用全面验证
```bash
# 1. 运行路由检查
make doc_route_check

# 2. 检查Markdown链接
使用工具检查所有.md文件的内部链接：
- 相对路径链接
- 绝对路径链接
- 锚点链接

# 3. 检查代码中的路径引用
grep -r "docs/" --include="*.py" --include="*.md"
grep -r "flows/" --include="*.py" --include="*.md"
grep -r "migrations/" --include="*.py" --include="*.md"

# 4. 验证修复
确保所有路径引用已更新为新路径
```

#### E. 自动化链路测试
```bash
# 1. 运行完整dev_check
make dev_check

# 包含的检查：
- docgen（文档索引生成）
- doc_style_check（文档风格）
- dag_check（DAG校验）
- contract_compat_check（契约兼容性）
- deps_check（依赖检查）
- runtime_config_check（配置校验）
- migrate_check（迁移检查）
- consistency_check（一致性）
- frontend_types_check（前端类型）
- agent_lint（agent.md校验）
- registry_check（注册表校验）
- doc_route_check（文档路由）
- db_lint（数据库校验，如Phase 5完成）

# 2. 测试半自动化工具
make registry_gen          # 生成registry草案
make module_doc_gen        # 生成模块文档

# 如Phase 5完成：
make db_plan TARGET=dev    # 数据库迁移预览
make db_docgen             # 生成数据库文档

# 3. 验证生成的文档
检查自动生成的文档格式正确、内容完整
```

#### F. 文档内容质量审查
```bash
# 1. README.md审查
每个README.md应包含：
- [ ] 目标/概述
- [ ] 适用场景
- [ ] 前置条件（如适用）
- [ ] 快速开始/使用说明
- [ ] 目录结构说明（模块README）
- [ ] 相关文档链接

# 2. agent.md审查
每个agent.md应包含：
- [ ] YAML Front Matter（通过agent_lint校验）
- [ ] Summary章节
- [ ] Responsibilities章节
- [ ] Limitations章节
- [ ] I/O Examples
- [ ] context_routes路径正确

# 3. CONTRACT.md审查
每个CONTRACT.md应包含：
- [ ] API接口定义（如有）
- [ ] 前端组件说明（如有）
- [ ] 请求/响应格式
- [ ] 调用示例
- [ ] 错误码说明

# 4. 初始化文档审查
- [ ] PROJECT_INIT_GUIDE.md包含对话范式
- [ ] MODULE_INIT_GUIDE.md包含子目录创建规范
- [ ] MODULE_TYPES.md内容完整
- [ ] 模板文件（TEMPLATES/）齐全
```

#### G. 生成最终报告
```bash
# 1. 变更清单
记录所有Phase的变更：
- 新增文件列表
- 修改文件列表
- 删除文件列表
- 重命名/移动文件映射表

# 2. 路径映射表
生成完整的旧路径→新路径映射表：
docs/ → doc/
flows/ → doc/flows/
migrations/ → db/engines/postgres/migrations/
docs/db/ → db/engines/postgres/docs/
modules/<entity>/CONTRACT.md → modules/<entity>/doc/CONTRACT.md

# 3. 验收报告
- Repo级验收结果
- 模块级验收结果
- 文档级验收结果
- 自动化级验收结果

# 4. 问题汇总（如有）
- 待解决问题
- 遗留优化项
- 建议改进点
```

### 7.3 清理脚本（可选）

可以创建一个专门的清理检查脚本：

```python
# scripts/final_cleanup_check.py
功能：
1. 扫描所有文档文件
2. 检查格式规范
3. 识别无效引用
4. 生成清理建议报告
```

### 7.4 Phase 9执行时间
预计：2-3天

**子任务时间分配**:
- 文档完整性和格式审查: 0.5天
- 无效文档识别和清理: 0.5天
- 路径引用全面验证: 0.5天
- 自动化链路测试: 0.5天
- 文档内容质量审查: 0.5天
- 生成最终报告: 0.5天

### 7.5 Phase 9验收标准
- [ ] `make doc_style_check`通过
- [ ] `make doc_route_check`通过
- [ ] `make consistency_check`通过
- [ ] `make dev_check`全部通过
- [ ] 无临时文件（`make cleanup_tmp`清理后）
- [ ] 无.draft文件残留
- [ ] 路径映射表完整
- [ ] 最终验收报告生成
- [ ] 所有文档质量达标

---

## 8. 总体时间预估（更新）

| Phase | 任务 | 预估时间 | 状态 |
|-------|------|---------|------|
| Phase 0 | 调研与方案确认 | - | ✅ 完成 |
| Phase 1 | Schema与基础设施 | 4-6天 | ✅ 完成 |
| Phase 2 | 目录结构调整 | 6-8天 | 待执行 |
| Phase 3 | 根agent.md轻量化与目录改名 | 4-6天 | 待执行 |
| Phase 4 | 模块实例标准化 | 4-6天 | 待执行 |
| Phase 5 | 数据库治理实施 | 5-7天 | 待执行 |
| Phase 6 | 初始化规范完善 | 2-3天 | 待执行 |
| Phase 7 | CI集成与测试 | 2-3天 | 待执行 |
| Phase 8 | 文档更新与路径修正 | 2-3天 | 待执行 |
| Phase 9 | 文档审查与清理 | 2-3天 | 待执行 |

**总计**: 31-45天（原27-39天，增加Phase 9的2-3天）

---

## 9. 变更历史
- 2025-11-07: 创建执行计划草案
- 2025-11-07: Phase 1执行完成
- 2025-11-07: 新增Phase 9"文档审查与清理流程"


