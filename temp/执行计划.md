# AI-TEMPLATE Repo 改进执行计划

> **状态**: 草案(Draft)
> **创建日期**: 2025-11-07
> **最后更新**: 2025-11-07

---

## 重要说明
本执行计划处于**草案阶段**,在获得最终确认前,**不允许修改temp目录以外的任何文件或目录**。

---

## 0. 目标
完善AI-TEMPLATE仓库的结构和文档体系,实现:
1. **AI友好**: 文档可解析、上下文按需加载、路径路由清晰
2. **模块化**: 同类型可替换、实例独立、I/O稳定
3. **自动化**: 一切可校验、可脚本化、可CI化
4. **可编排**: 支持智能体自动读取/合并agent.md,基于标签与约束调度

---

## 1. 改进原则
1. 以AI友好和模块化为核心导向
2. 以自动化流程的完备程度为评价标准
3. 融入和适配智能体编排体系
4. repo骨架为模板,repo中的文档为通用文档(项目无关)
5. 通过初始化引导,将模板转换成项目repo

---

## 2. 执行阶段划分

### Phase 0: 调研与方案确认(当前阶段)
**目标**: 充分理解需求,形成可行方案,获得确认
**状态**: 进行中

**子任务**:
- [x] 遍历当前repo,熟悉架构
- [x] 阅读agent.md和README.md等关键文档
- [x] 了解自动化流程(Makefile + scripts/)
- [ ] 阅读需求文档,理解改进方向
- [ ] 阅读参考方案,吸收好的建议
- [ ] 形成初步改进方案
- [ ] 与用户充分讨论,对齐需求
- [ ] 形成最终执行计划
- [ ] 获得用户确认

**关键产出**:
- [x] 阅读笔记.md (当前repo理解)
- [ ] 修改方案(初稿).md
- [ ] 最终执行计划.md

### Phase 1: 骨架调整与Schema建立 ✅（已完成）
**目标**: 建立agent.md v2规范,调整目录结构
**前置条件**: Phase 0完成并获得确认

**必读文档**（开始前）⭐:
- `temp/修改方案(正式版).md` - 了解完整方案
- `temp/执行计划.md` - 了解Phase划分
- `temp/参考方案和建议/AI-TEMPLATE-Enhancement-Pack/` - 参考示例

**子任务**（已完成）:
1. 新增schemas/agent.schema.yaml
2. 调整doc/目录结构
3. 为模块实例补齐doc/子目录
4. 建立doc/orchestration/registry.yaml草案
5. 新增agent.md校验脚本

**详见**: `temp/Phase1_最终总结.md`

### Phase 2: 目录结构调整 ✅（已完成）
**目标**: 创建doc/和db/子目录，编写规范文档
**前置条件**: Phase 1完成

**必读文档**（开始前）⭐:
- `temp/Phase1_最终总结.md` - 了解Phase 1成果
- `temp/修改方案(正式版).md` - 了解目录结构设计（第8.2节）
- `temp/参考方案和建议/AI-TEMPLATE-Enhancement-Pack/` - 参考文档示例

**子任务**（已完成）:
1. 创建doc/子目录结构
2. 创建db/子目录结构
3. 编写规范文档（routing.md, goals.md, safety.md等）
4. 创建文档模板（6个）
5. 正式化registry.yaml

**详见**: `temp/Phase2_最终总结.md`

### Phase 3: 根agent.md轻量化与目录改名 ✅（已完成）
**目标**: 根agent.md轻量化，docs/和flows/目录整合
**前置条件**: Phase 2完成

**必读文档**（开始前）⭐:
- `temp/Phase2_最终总结.md` - 了解Phase 2成果
- `agent.md` - 了解当前agent.md内容（2434行）
- `temp/修改方案(正式版).md` - 了解轻量化方案（第8.3节）

**子任务**（已完成）:
1. 建立内容迁移映射表
2. 迁移内容到doc/下的各个文档
3. 精简agent.md到256行
4. 添加完整YAML Front Matter
5. docs/和doc/目录合并
6. flows/移动到doc/flows/

**详见**: `temp/Phase3_最终总结.md`, `temp/Phase3_agent优化记录.md`

### Phase 4: 模块实例标准化 ✅（已完成）
**目标**: 为模块实例补齐agent.md和文档结构，优化模块类型体系
**前置条件**: Phase 3完成

**必读文档**（开始前）⭐:
- `temp/Phase3_最终总结.md` - 了解Phase 3成果
- `doc/modules/MODULE_TYPES.md` - 了解当前模块类型（477行）
- `temp/修改方案(正式版).md` - 了解模块标准化方案（第8.4节）

**子任务**（已完成）:
1. 为example模块补齐agent.md
2. 创建example/doc/子目录，迁移6个文档
3. example移至doc/modules/（参考文档定位）
4. 创建MODULE_TYPE_CONTRACTS.yaml
5. 精简MODULE_TYPES.md（477→274行）
6. 实现type_contract_check.py
7. 实现doc_script_sync_check.py

**详见**: `temp/Phase4_完整总结.md`

### Phase 5: 数据库治理实施 ✅（已完成）
**目标**: 建立db/目录结构，实现半自动化
**前置条件**: Phase 4完成

**必读文档**（开始前）⭐:
- `temp/Phase4_完整总结.md` - 了解Phase 4成果
- `db/engines/README.md` - 了解数据库目录规范（Phase 3创建）
- `doc/db/DB_SPEC.yaml` - 了解当前数据库规范
- `migrations/` - 了解当前迁移脚本

**子任务**（已完成）:
1. 创建db/engines/postgres/目录结构
2. 迁移migrations/到db/engines/postgres/migrations/
3. 迁移docs/db/到db/engines/postgres/docs/
4. 为核心表创建tables/*.yaml
5. 新增数据库相关脚本
6. Makefile新增db相关命令
7. 测试半自动化流程
8. 更新相关文档和脚本的路径引用

### Phase 6: 初始化规范完善
**目标**: 完善PROJECT_INIT_GUIDE.md和MODULE_INIT_GUIDE.md，增加测试数据管理
**前置条件**: Phase 5完成

**必读文档**（开始前）⭐:
- `temp/Phase5_最终总结.md` - 了解Phase 5成果
- `temp/Phase5_数据库治理扩展方案.md` - 了解测试数据管理方案（第5-7节）
- `doc/modules/MODULE_INIT_GUIDE.md` - 查看当前的引导内容
- `schemas/agent.schema.yaml` - 了解当前Schema结构

**子任务**:
1. 更新PROJECT_INIT_GUIDE.md（增加对话范式）
2. 更新MODULE_INIT_GUIDE.md（增加DB变更引导）
3. **增加MODULE_INIT_GUIDE.md第7步：定义测试数据需求**（Phase 5扩展）⭐
   - AI引导对话示例
   - Fixtures和Mock的选择逻辑
   - 数据分布定义方法
4. **Schema扩展：agent.schema.yaml添加test_data字段**（Phase 5扩展）⭐
5. **创建TEST_DATA.md.template模板**（Phase 5扩展）⭐
6. **更新example模块：添加测试数据示例**（Phase 5扩展）⭐
   - doc/modules/example/doc/TEST_DATA.md
   - doc/modules/example/fixtures/目录结构
7. 更新scripts/agent_lint.py支持test_data字段
8. 更新scripts/module_doc_gen.py支持生成Mock规则
9. 更新scripts/ai_begin.sh以支持新结构
10. 测试模块初始化流程

**验收**:
- [ ] MODULE_INIT_GUIDE.md包含"第7步：定义测试数据需求"
- [ ] agent.schema.yaml包含test_data字段定义
- [ ] TEST_DATA.md.template模板已创建
- [ ] example模块有完整的测试数据示例
- [ ] agent_lint支持test_data字段校验
- [ ] 按指南可完成初始化，生成的结构通过校验

### Phase 7: CI集成与测试数据工具实施
**目标**: 将所有校验集成到dev_check和CI，实施测试数据管理工具
**前置条件**: Phase 6 + 6.5完成

**必读文档**（开始前）⭐:
- `temp/Phase6_完整总结.md` - 了解Phase 6+6.5完整成果 ⭐
- `temp/Phase6_遗留任务清单.md` - 了解Phase 6/6.5的遗留任务 ⭐⭐
- `temp/Phase5_数据库治理扩展方案.md` - 了解Fixtures管理和环境管理方案（第4节、第7.2节）
- `doc/modules/example/doc/TEST_DATA.md` - 参考示例（Phase 6创建）
- `db/engines/postgres/schemas/tables/runs.yaml` - 了解表YAML结构

**Phase 6/6.5遗留任务**（本Phase必须处理）:
1. 🔴 **必须实施**: 
   - fixture_loader.py（Fixtures加载工具）← Phase 6遗留
   - dev_check集成（统一质量检查）← Phase 6遗留
2. 🟡 **建议实施**: 
   - db_env.py（环境管理工具）← Phase 6.5遗留
   - CI配置更新 ← Phase 6遗留

**子任务**:
1. 🔴 **Makefile: dev_check集成**（Phase 6遗留，必须）
   - 整合agent_lint, registry_check, doc_route_check, db_lint等
   - 统一输出格式
   - 错误汇总

2. 🔴 **实现Fixtures管理工具**（Phase 6遗留，必须）⭐
   - scripts/fixture_loader.py（模块感知的加载器）
   - 读取TEST_DATA.md定义
   - 支持场景选择（minimal/standard/full）
   - Makefile添加load_fixture命令
   - 清理功能

3. 🟡 **实现环境管理工具**（Phase 6.5遗留，建议）
   - scripts/db_env.py（环境切换和识别）
   - 创建db/engines/postgres/config/目录
   - 创建dev.yaml、test.yaml配置示例
   - Makefile添加db_env命令

4. 🟡 **更新CI配置**（Phase 6遗留，建议）
   - 更新.github/workflows/ci.yml（如有）
   - 集成所有校验命令

5. 全面测试dev_check
6. 修复发现的问题

**验收**:
- [ ] `make dev_check`包含所有校验（含db_lint）✅
- [ ] `make load_fixture MODULE=example FIXTURE=minimal`可运行 ✅（Phase 6遗留）
- [ ] fixture_loader.py可正常工作 ✅（Phase 6遗留）
- [ ] db_env.py可正常工作（如已实现）
- [ ] CI配置已更新

### Phase 8: 文档更新与高级功能实施
**目标**: 更新所有相关文档，实施高级数据库功能（可选）
**前置条件**: Phase 7完成

**必读文档**（开始前）⭐:
- `temp/Phase7_最终总结.md` - 了解Phase 7成果
- `temp/Phase6_遗留任务清单.md` - 了解Phase 6/6.5的可选遗留任务
- `temp/Phase5_数据库治理扩展方案.md` - 了解Mock生成器和实例注册表方案（第4.3-4.4节、第7.3节）
- `doc/modules/example/doc/TEST_DATA.md` - 参考Mock规则示例（Phase 6创建）

**Phase 6/6.5遗留任务**（本Phase可选处理）:
1. 🟢 **可选实施**（根据实际需求决定）:
   - mock_generator.py（Mock数据生成器）← Phase 6遗留
   - mock_lifecycle.py（Mock生命周期管理）← Phase 6遗留
   - project_migrate.py（项目迁移工具）← Phase 6.5遗留
   - doc_parser.py（文档解析器）← Phase 6.5遗留

**子任务**:
1. 更新README.md, QUICK_START.md, TEMPLATE_USAGE.md
2. 更新agent.md中的路径引用
3. 更新其他文档中的路径引用
4. 生成路径迁移映射表

5. 🟢 **实现Mock数据生成器**（Phase 6遗留，可选）⭐
   - scripts/mock_generator.py（模块感知，读取TEST_DATA.md的Mock规则）
   - scripts/mock_lifecycle.py（生命周期管理）
   - 创建db/engines/postgres/fixtures/mock/目录
   - Makefile添加generate_mock、cleanup_mock命令
   
6. 🟢 **实现项目迁移工具**（Phase 6.5遗留，可选）
   - scripts/project_migrate.py（自动化架构映射和import调整）
   - 生成迁移报告
   
7. 🟢 **实现文档解析器**（Phase 6.5遗留，可选）
   - scripts/doc_parser.py（解析PRD/需求文档）
   - 提取结构化信息（模块、表、技术栈）
   
8. 🟢 **实现数据库实例注册表**（Phase 5扩展，可选）⭐
   - 创建db/engines/registry.yaml
   - 实现实例识别和验证机制

9. 清理旧文件（migrations/和doc/db/的重定向文件）
10. 运行完整检验

**验收**:
- [ ] 所有路径引用正确
- [ ] 路径迁移映射表完整
- [ ] mock_generator.py可正常工作（如已实施）
- [ ] `make generate_mock MODULE=example COUNT=1000`可运行（如已实施）
- [ ] project_migrate.py可正常工作（如已实施）
- [ ] 旧文件已清理
- [ ] `make dev_check`全部通过

### Phase 9: 文档审查与清理
**目标**: 全面审查文档质量，清理无效文档，确保格式正确
**前置条件**: Phase 8完成

**必读文档**（开始前）⭐:
- `temp/Phase8_最终总结.md` - 了解Phase 8成果
- `temp/执行计划.md` - 查看§5"验收标准"（30项）
- `doc/process/CONVENTIONS.md` - 了解文档规范
- `doc/process/DoR_DoD.md` - 了解质量标准

**子任务**:
1. **文档完整性审查**
   - 检查所有必需文档是否齐全
   - 验证文档间引用的有效性
   - 确认文档路由正确

2. **文档格式审查**
   - 运行`make doc_style_check`检查格式
   - 检查颜文字使用（应无）
   - 检查语言一致性（中英文混用）
   - 检查代码块语言标记
   - 检查数学公式格式（LaTeX）
   - 检查标题层级（无跳级）

3. **文档内容审查**
   - 检查目标和上下文说明是否清晰
   - 检查是否有模糊表达
   - 检查逻辑流程是否使用分步结构
   - 检查是否包含验证步骤和回滚逻辑

4. **无效文档清理**
   - 识别并删除过时文档
   - 清理临时文档（运行`make cleanup_tmp`）
   - 删除.draft后缀的草案文件（如已正式化）
   - 删除重复或冗余文档

5. **路径引用验证**
   - 运行`make doc_route_check`验证所有路由
   - 检查文档内部链接的有效性
   - 验证所有路径引用可访问
   - 生成断链报告

6. **脚本双向同步检查**（新增）⭐
   - 运行`make doc_script_sync_check`进行双向检查
   - 检查文档提及但脚本不存在（缺失实现）
   - 检查脚本存在但文档未提及（孤儿脚本）
   - 验证Makefile命令与实际脚本的映射关系
   - 更新scripts/README.md确保所有脚本都有说明

7. **自动化链路测试**
   - 运行完整`make dev_check`
   - 验证所有校验脚本通过
   - 测试半自动化流程（registry_gen, module_doc_gen, db相关）
   - 确认CI流程正常

8. **按标准评估Repo质量**（新增）⭐
   - 对照§5"验收标准"逐项检查
   - Repo级验收（11项）
   - 模块级验收（7项）
   - 文档级验收（6项）
   - 自动化级验收（6项）
   - 生成评估报告，标注未达标项

9. **生成最终报告**
   - 文档审查报告
   - 脚本同步检查报告
   - Repo质量评估报告
   - 变更清单
   - 路径映射表
   - 验收报告

**验收标准**:
- [x] `make doc_style_check`全部通过 ✅
- [x] `make doc_route_check`全部通过（28/28）✅
- [x] `make doc_script_sync_check`全部通过 ✅
- [x] 无临时文件残留 ✅
- [x] 所有文档格式符合规范 ✅
- [x] 所有链接和路径有效 ✅
- [x] `make dev_check`全部通过 ✅
- [x] Repo质量评估完成（95/100分）✅
- [x] 最终审查报告生成 ✅

**完成情况**: ✅ 100%（Phase 9 + Phase 9+优化）

**详见**:
- temp/Phase9_Repo质量评估报告.md（729行）
- temp/Phase9_最终报告.md（659行）
- temp/Phase9+优化完成报告.md（640行）
- temp/Phase9+_最终总结.md（309行）

---

### Phase 10: claude-showcase优势集成（计划）
**目标**: 整合claude-code-infrastructure-showcase的4个核心优势，提升AI工作效率30%+，降低token成本25%+
**前置条件**: Phase 9完成，AI-TEMPLATE v1.0已发布
**预估时间**: 9-14天（可分4个子Phase实施）

**必读文档**（开始前）⭐⭐⭐:
- `temp/互补方案_claude_showcase集成.md` - 完整技术方案（2090行）⭐⭐⭐
- `temp/互补方案_增强点评估.md` - 量化收益评估（1140行）⭐⭐
- `temp/Phase9+_最终总结.md` - Phase 9完成状态
- `/Volumes/DataDisk/Project/claude-code-infrastructure-showcase/README.md` - 源项目参考

**核心互补点**:
1. **智能触发系统** - 自动匹配文件路径和prompt，精准加载文档
2. **渐进式披露** - 大文档拆分（主文件+resources），按需加载
3. **Dev Docs机制** - plan/context/tasks三文件，增强上下文恢复
4. **Guardrail机制** - Block/Warn/Suggest三级防护，事前阻止错误

**预期收益**:
- AI工作效率: +30%
- Token成本: -25% (年节约$3,000)
- 错误避免率: +93% (55次→4次错误/100次操作)
- 上下文恢复时间: -83% (15-30分钟 → 2-5分钟)
- 首年ROI: 887% (投入$8,000，回报$79,000)

---

#### 10.1 智能触发系统（P0高优先级，1-2天）

**目标**: 实现类似claude-showcase的skill-rules.json机制，自动触发文档加载

**子任务**:

1. **创建agent-triggers.yaml**
   - 路径：`doc/orchestration/agent-triggers.yaml`（约240行）
   - 定义5个触发规则：
     ```yaml
     triggers:
       database-operations:        # 数据库操作
       module-development:         # 模块开发
       contract-changes:           # 契约变更（Guardrail）
       agent-config-changes:       # agent.md编辑
       documentation-writing:      # 文档编写
     ```
   - 每个规则包含：
     - priority (critical/high/medium/low)
     - enforcement (suggest/warn/block)
     - file_triggers (path_patterns, content_patterns)
     - prompt_triggers (keywords, intent_patterns)
     - load_documents (文档列表+优先级)
     - block_config (Block/Warn模式配置)

2. **实现触发器引擎**
   - 创建`scripts/agent_trigger.py`（约280行）
   - 实现AgentTrigger类：
     - `__init__()` - 加载配置文件
     - `match_file(file_path)` - 匹配文件路径触发器
     - `match_prompt(prompt)` - 匹配prompt触发器
     - `get_documents_to_load(matches)` - 获取文档列表（按优先级）
     - `check_enforcement(matches, file_path)` - 检查enforcement模式
     - `check_make_command_passed(command)` - 验证make命令
   - 实现main()函数：
     - 接受file_path和prompt参数
     - 匹配规则
     - 执行enforcement检查
     - 输出建议加载的文档
     - 返回exit code（0=通过，1=blocked）

3. **Makefile命令集成**
   - 新增命令：
     ```makefile
     agent_trigger_check:  # 检查触发规则
       用法: make agent_trigger_check FILE=<path> PROMPT="<text>"
     
     agent_trigger_test:   # 测试触发器准确率
     ```
   - 可选：在dev_check中添加（需要配置开关）

4. **扩展agent.md配置**
   - 在YAML Front Matter的context_routes中新增：
     ```yaml
     triggers:
       enabled: true
       config_ref: /doc/orchestration/agent-triggers.yaml
       execution_mode: "pre_task"
       overrides: []
     ```
   - 更新§1"文档路由与上下文管理"
     - 添加"触发器机制"章节
     - 说明与on_demand的协同工作

5. **创建触发器使用指南**
   - 创建`doc/orchestration/triggers-guide.md`（约300行）
   - 说明触发器工作原理
   - 提供规则配置示例
   - 说明如何添加新规则

6. **测试触发系统**
   - 测试场景：
     - 数据库操作（文件+prompt双触发）
     - 模块开发（自动加载MODULE_INIT_GUIDE）
     - 契约变更（Block模式阻止）
     - agent.md编辑（Warn模式提示）
   - 验证准确率（目标≥90%）
   - 验证Block/Warn模式工作正常

**验收标准**:
- [ ] agent-triggers.yaml创建完成，5个规则完整
- [ ] agent_trigger.py可运行，所有方法测试通过
- [ ] make agent_trigger_check命令可用
- [ ] 触发器准确率≥90%（测试10个场景）
- [ ] Block模式可正确阻止操作
- [ ] Warn模式可正确提示用户
- [ ] agent.md包含triggers配置
- [ ] triggers-guide.md创建完成
- [ ] 文档加载准确率提升到≥95%

---

#### 10.2 渐进式披露改造（P0高优先级，3-4天）

**目标**: 将大文档拆分为主文件+resources，降低token成本25%，提升文档精度80%

**子任务**:

1. **拆分MODULE_INIT_GUIDE.md**（最高优先级）
   - 当前：1200行，一次性加载
   - 目标：主文件300行 + 8个resource文件
   - 创建目录：`doc/modules/resources/`
   - 拆分内容：
     - init-planning.md (Phase 1详细，200行)
     - init-directory.md (Phase 2详细，150行)
     - init-documents.md (Phase 3详细，250行)
     - init-registration.md (Phase 4详细，120行)
     - init-validation.md (Phase 5详细，100行)
     - init-database.md (Phase 6详细，180行)
     - init-testdata.md (Phase 7详细，200行)
     - init-code.md (Phase 9详细，150行)
   - 主文件结构：
     - 快速开始（脚本vs手动）
     - 完整流程概览（每Phase简要说明+指向resource）
     - AI执行规范（简要）
     - 常见问题（列表+指向详细resource）
     - Resources索引表

2. **拆分DB_CHANGE_GUIDE.md**
   - 当前：688行
   - 目标：主文件250行 + 5个resource文件
   - 创建目录：`doc/process/resources/`
   - 拆分内容：
     - db-create-table.md (创建表完整指南，180行)
     - db-alter-table.md (修改表完整指南，200行)
     - db-drop-table.md (删除表完整指南，150行)
     - db-migration-script.md (迁移脚本编写，160行)
     - db-test-data.md (测试数据更新，120行)
   - 主文件结构：
     - 快速决策树（根据变更类型指向resource）
     - 标准流程概览
     - Resource索引表
     - 常见场景快速入口
     - 安全检查清单

3. **进一步精简safety.md**（可选）
   - 当前：233行（已精简22%）
   - 目标：150-180行（如需进一步优化）
   - 方式：将示例代码拆分到resources

4. **更新触发器规则支持resource条件加载**
   - 在agent-triggers.yaml中为load_documents添加：
     ```yaml
     load_documents:
       - path: /doc/modules/MODULE_INIT_GUIDE.md
         priority: critical
         type: main
       - path: /doc/modules/resources/init-planning.md
         priority: high
         type: resource
         conditions:
           prompt_contains: ["Phase 1", "规划", "planning"]
     ```
   - 实现条件匹配逻辑（在agent_trigger.py中）

5. **创建resources检查工具**
   - 创建`scripts/resources_check.py`（约150行）
   - 检查功能：
     - 主文件Resources索引表完整性
     - Resource文件实际存在
     - Resource文件大小控制（≤200行）
     - 主文件+resources总行数对比原文档
   - Makefile新增：`make resources_check`

6. **更新所有文档路径引用**
   - agent.md中的context_routes
   - 其他文档中对MODULE_INIT_GUIDE和DB_CHANGE_GUIDE的引用
   - 保持向后兼容（主文件路径不变）

7. **测试渐进式披露效果**
   - 场景测试：
     - 仅需Phase 1信息→仅加载init-planning.md
     - 数据库创建表→仅加载db-create-table.md
   - Token消耗测试（目标降低≥25%）
   - AI理解速度测试（目标提升≥67%）

**验收标准**:
- [ ] MODULE_INIT_GUIDE.md精简到≤300行
- [ ] doc/modules/resources/包含8个resource文件，每个≤250行
- [ ] DB_CHANGE_GUIDE.md精简到≤250行
- [ ] doc/process/resources/包含5个resource文件，每个≤200行
- [ ] 所有主文件包含完整Resources索引表
- [ ] resources_check.py可运行并通过
- [ ] make resources_check命令可用
- [ ] 触发器规则支持resource条件加载
- [ ] Token节省≥25%（测试10个典型场景）
- [ ] 文档查找时间减少≥60%
- [ ] AI理解时间减少≥67%
- [ ] make doc_route_check通过（验证新增resources路径）

---

#### 10.3 Dev Docs机制实施（P1中优先级，2-3天）

**目标**: 实施plan/context/tasks三文件模式，上下文恢复时间从15-30分钟降到2-5分钟

**子任务**:

1. **创建workdoc模板**
   - 创建`doc/templates/workdoc-plan.md`（约300行）
     - 包含：执行摘要、当前状态分析、实施阶段、风险管理、成功指标、时间线、依赖关系
   - 创建`doc/templates/workdoc-context.md`（约250行）
     - 包含：**SESSION PROGRESS**（关键！）、关键文件、关键决策、**错误记录**、技术约束、Quick Resume
   - 创建`doc/templates/workdoc-tasks.md`（约200行）
     - 包含：Phase清单（checkbox格式）、总体进度、Quick Status、阻塞任务、里程碑

2. **实现workdoc管理脚本**
   - 创建`scripts/workdoc_create.sh`（约80行）
     - 创建ai/workdocs/active/<task>/目录
     - 从模板复制三文件
     - 替换占位符（[Task Name]、[YYYY-MM-DD]）
     - 提示下一步操作
   - 创建`scripts/workdoc_update.py`（约200行）
     - 自动检测当前active任务
     - 分析git log提取已完成工作
     - 更新SESSION PROGRESS
     - 更新tasks.md勾选状态
     - 提示需要手动补充的信息
   - 创建`scripts/workdoc_archive.sh`（约60行）
     - 移动任务从active/到archive/
     - 创建完成报告快照
     - 更新LEDGER.md

3. **创建ai/workdocs目录结构**
   - 创建`ai/workdocs/active/`
   - 创建`ai/workdocs/archive/`
   - 创建`ai/workdocs/README.md`（说明使用方法）

4. **Makefile命令集成**
   - 新增命令：
     ```makefile
     workdoc_create TASK=<name>:   # 创建work doc
     workdoc_update:                # 更新active work doc
     workdoc_archive TASK=<name>:   # 归档work doc
     workdoc_list:                  # 列出active任务
     workdoc_status:                # 显示当前任务状态
     ```

5. **扩展agent.md配置**
   - 在context_routes中新增workdocs字段：
     ```yaml
     workdocs:
       enabled: true
       location: /ai/workdocs/
       auto_detect: true
       auto_load_on_start: true
       resume_priority:
         - context.md  # 最高优先级
         - tasks.md
         - plan.md
     ```
   - 在§0工作流程中插入"S0.5 - 检查Active Work Docs"
     - 自动检测ai/workdocs/active/下的任务
     - 如有active任务，读取context.md恢复状态

6. **创建使用指南**
   - 创建`doc/process/WORKDOCS_GUIDE.md`（约400行）
   - 章节：
     - § 什么是Dev Docs（解决的问题）
     - § 三文件结构说明
     - § 使用流程（创建、更新、归档）
     - § SESSION PROGRESS重要性
     - § 错误记录格式（ERROR-001格式）
     - § Quick Resume使用
     - § 最佳实践
     - § 与.context/的区别

7. **创建示例work doc**
   - 在ai/workdocs/active/example-task/创建示例
   - 展示完整的plan/context/tasks结构
   - 包含实际的SESSION PROGRESS示例
   - 包含错误记录示例

8. **测试Dev Docs流程**
   - 场景1: 创建新任务，多次更新，归档
   - 场景2: 模拟上下文重置，验证恢复速度
   - 场景3: 跨天开发，恢复上下文
   - 场景4: 紧急中断1周后恢复
   - 验证恢复时间（目标<5分钟）

**验收标准**:
- [ ] 三个模板文件创建完成
- [ ] workdoc_create.sh可创建完整结构，占位符正确替换
- [ ] workdoc_update.py可自动更新SESSION PROGRESS
- [ ] workdoc_archive.sh可正确归档
- [ ] make workdoc_*命令全部可用（5个）
- [ ] agent.md包含workdocs配置
- [ ] WORKDOCS_GUIDE.md创建完成
- [ ] 示例work doc创建完成
- [ ] 上下文恢复时间<5分钟（场景2-4测试）
- [ ] ERROR记录功能测试通过
- [ ] 信息完整度≥95%（无关键信息丢失）

---

#### 10.4 Guardrail机制增强（P1中优先级，1-2天）

**目标**: 实现Block/Warn模式，破坏性变更避免率达到100%

**子任务**:

1. **定义Guardrail规则**（已在agent-triggers.yaml中）
   - contract-changes (Block模式) - 契约变更必须先运行兼容性检查
   - database-schema-changes (Block模式) - 数据库变更必须先运行db_lint
   - root-agent-changes (Warn模式) - 根agent.md变更需要确认
   - prod-config-changes (Block模式) - 生产配置变更需要审批

2. **增强agent_trigger.py**（在10.1基础上）
   - 实现make命令结果检查：
     - 运行命令
     - 捕获exit code
     - 超时处理（30秒）
   - 实现文件标记检查：
     - 读取文件内容
     - 搜索# SKIP_*标记
   - 实现环境变量override：
     - 检查SKIP_*_GUARD环境变量
   - 优化Block/Warn消息格式

3. **Git Hooks集成**（可选）
   - 创建`.git/hooks/pre-commit`模板（约40行）
   - 在staged文件上运行guardrail检查
   - 创建安装脚本：`scripts/install_git_hooks.sh`（约50行）
   - Makefile新增：`make install_hooks`

4. **创建Guardrail使用指南**
   - 创建`doc/process/GUARDRAIL_GUIDE.md`（约300行）
   - 章节：
     - § 什么是Guardrail（防护栏）
     - § 三种enforcement模式（suggest/warn/block）
     - § 4个Guardrail规则说明
     - § skip_conditions使用方法
     - § 紧急豁免流程
     - § 最佳实践
     - § 常见问题

5. **测试Guardrail场景**
   - 场景1: 契约变更未运行检查→阻止
   - 场景2: 契约变更已运行检查→允许
   - 场景3: 数据库变更未测试→阻止
   - 场景4: 根agent.md变更→警告并确认
   - 场景5: 生产配置变更→阻止
   - 场景6: skip_conditions生效
   - 验证阻止率（目标100%高风险操作）

6. **创建Guardrail监控**
   - 脚本：`scripts/guardrail_stats.py`（约100行）
   - 统计：
     - Guardrail触发次数
     - 阻止次数
     - 豁免次数
     - 误报次数

**验收标准**:
- [ ] 4个Guardrail规则在agent-triggers.yaml中完整定义
- [ ] agent_trigger.py支持完整enforcement检查
- [ ] make命令检查功能正常工作
- [ ] Block模式可正确阻止操作（场景1、3、5测试）
- [ ] Warn模式可正确提示用户（场景4测试）
- [ ] skip_conditions正确工作（场景2、6测试）
- [ ] Git hooks安装脚本可用（如实施）
- [ ] GUARDRAIL_GUIDE.md创建完成
- [ ] 破坏性变更避免率≥95%
- [ ] Guardrail误报率<5%
- [ ] guardrail_stats.py可运行

---

#### 10.5 集成验证与文档（P1中优先级，1天）

**目标**: 验证整合效果，完善文档，为v2.0发布做准备

**子任务**:

1. **端到端场景测试**
   - 场景1: 模块开发全流程
     - 触发器自动加载MODULE_INIT_GUIDE主文件
     - 按需加载init-planning.md
     - 创建work doc
     - 跨会话恢复
   - 场景2: 数据库变更
     - 触发器加载DB_CHANGE_GUIDE主文件
     - 按需加载db-create-table.md
     - Guardrail阻止（未运行db_lint）
     - 运行检查后允许
   - 场景3: 契约变更
     - Guardrail阻止
     - 运行contract_compat_check
     - 通过后允许
   - 场景4: 上下文重置恢复
     - 读取context.md
     - 2-5分钟内完全恢复

2. **性能测试与统计**
   - Token消耗统计（10个典型任务）
   - 对比优化前后（目标降低≥25%）
   - 触发器响应时间（目标<0.5秒）
   - 上下文恢复时间（目标<5分钟）
   - 文档加载准确率（目标≥95%）

3. **创建集成指南**
   - 创建`doc/process/CLAUDE_SHOWCASE_INTEGRATION.md`（约500行）
   - 章节：
     - § 集成概述（4个机制）
     - § 智能触发系统使用
     - § 渐进式披露文档结构
     - § Dev Docs最佳实践
     - § Guardrail规则说明
     - § 从v1.0到v2.0的变化
     - § 迁移步骤
     - § 常见问题

4. **更新核心文档**
   - README.md - 新增"v2.0新特性"章节
   - QUICK_START.md - 新增触发器和work docs使用
   - agent.md - 更新文档路由说明，添加触发器和workdocs章节
   - TEMPLATE_USAGE.md - 更新使用指南

5. **创建v2.0发布说明**
   - 创建`RELEASE_NOTES_V2.0.md`
   - 包含：
     - 新功能总览
     - 互补增强点（4个）
     - 预期收益（量化）
     - 从v1.0升级步骤
     - 破坏性变更说明（如有）

6. **运行完整验证**
   - make dev_check（15个检查）
   - make agent_trigger_test（触发器测试）
   - make resources_check（resources检查）
   - make validate（7个检查）

**验收标准**:
- [ ] 4个端到端场景测试全部通过
- [ ] Token成本降低≥25%（实测数据）
- [ ] 上下文恢复时间<5分钟（实测数据）
- [ ] 触发器准确率≥95%（实测数据）
- [ ] CLAUDE_SHOWCASE_INTEGRATION.md创建完成
- [ ] README.md等4个核心文档更新完成
- [ ] RELEASE_NOTES_V2.0.md创建完成
- [ ] 所有验证命令通过
- [ ] 性能指标达到预期

---

### Phase 11: 补充优化（可选，2-3天）
**目标**: 实施Phase 9+识别的中优先级任务，进一步提升易用性
**前置条件**: Phase 10完成，v2.0核心功能稳定
**优先级**: 🟡 可选（根据实际需求决定）

**必读文档**（开始前）⭐:
- `temp/Phase9+优化完成报告.md` § 其他优化项
- `temp/Phase10_完成报告.md` - 了解v2.0状态

**子任务**:

#### 11.1 Mock文档完善（P0，4-6小时）

1. **创建MOCK_RULES_GUIDE.md**
   - 路径：`doc/process/MOCK_RULES_GUIDE.md`（400-500行）
   - 章节：
     - § Mock规则语法
     - § 字段类型支持
     - § 生成器配置
     - § 关联数据处理
     - § 分布控制
     - § 时间序列生成
     - § 完整示例（5个）

2. **补充example/TEST_DATA.md**
   - 添加更多Mock规则示例：
     - 关联数据示例（外键关系）
     - 分布控制示例（70%活跃、30%不活跃）
     - 时间序列示例（最近30天）
   - 增加200-300行

3. **创建TEST_DATA_STRATEGY.md**
   - 路径：`doc/process/TEST_DATA_STRATEGY.md`（250-300行）
   - 章节：
     - § Fixtures vs Mock选择指南
     - § 数据量级决策（何时用哪种）
     - § 场景适用性
     - § 最佳实践

4. **创建FIELD_GENERATORS.md**（可选）
   - 路径：`doc/reference/FIELD_GENERATORS.md`（300-400行）
   - 所有支持的字段生成器参考

**验收标准**:
- [ ] MOCK_RULES_GUIDE.md创建完成
- [ ] example/TEST_DATA.md补充完整
- [ ] TEST_DATA_STRATEGY.md创建完成
- [ ] agent.md添加Mock相关路由
- [ ] make doc_route_check通过

---

#### 11.2 CONVENTIONS.md完善（P1，2-3小时）

1. **补充编码规范**
   - Python规范（PEP 8扩展）
   - TypeScript规范（如有）
   - Go规范（如有）

2. **补充命名规范**
   - 文件命名
   - 变量命名
   - 函数命名
   - 类命名

3. **补充提交规范**
   - Commit message格式
   - PR标题格式
   - 分支命名

**验收标准**:
- [ ] CONVENTIONS.md增加300-400行
- [ ] 涵盖编码、命名、提交三方面

---

#### 11.3 module_scaffold工具（P1，6-8小时）

1. **创建模块脚手架工具**
   - 脚本：`scripts/module_scaffold.py`（约400行）
   - 功能：
     - 交互式询问模块信息
     - 自动生成完整模块结构
     - 自动填充模板内容
     - 自动注册到registry.yaml
     - 自动运行校验
   - 与ai_begin.sh的区别：更智能、更自动化

2. **Makefile集成**
   - 新增命令：`make module_scaffold MODULE=<name>`

**验收标准**:
- [ ] module_scaffold.py可运行
- [ ] 生成的模块结构完整
- [ ] 自动注册功能正常
- [ ] make module_scaffold命令可用

---

#### 11.4 GitHub Actions模板（P1，3-4小时）

1. **创建CI/CD模板**
   - 模板：`.github/workflows/ai-template-ci.yml`
   - 包含所有15个检查
   - 支持多Python版本测试

2. **创建使用说明**
   - 文档：`doc/process/CI_SETUP.md`

**验收标准**:
- [ ] CI模板创建完成
- [ ] CI_SETUP.md创建完成

---

### Phase 12: 社区与长期演进（长期，可选）
**目标**: 建立AI-TEMPLATE社区，持续收集反馈和最佳实践
**前置条件**: Phase 11完成，v2.0稳定运行
**执行方式**: 长期持续，按需实施

**必读文档**（开始前）⭐:
- `temp/Phase11_完成报告.md` - 了解v2.0完整状态
- `temp/互补方案_增强点评估.md` § 适用场景

**长期工作方向**:

1. **社区建设**
   - 收集用户反馈
   - 建立Issue模板
   - 维护FAQ
   - 沉淀使用案例

2. **生态工具**（Phase 9+识别的低优先级任务）
   - 契约测试示例（4-6小时）
   - 依赖可视化工具（4-5小时）
   - VSCode扩展（15-20小时）

3. **持续演进**
   - 监控使用数据
   - 优化触发规则
   - 优化文档结构
   - 架构演进（模块化单体→微服务）

4. **知识沉淀**
   - 建立最佳实践库
   - 建立模块模板库
   - 建立常见问题解决方案库

**此Phase为长期持续工作，无固定完成时间**

---

## 3. 关键改进点(草案)

### 3.1 目录结构调整
```text
添加/调整:
.
├── schemas/
│   └── agent.schema.yaml        # 新增
├── doc/
│   ├── orchestration/           # 新增目录
│   │   ├── registry.yaml       # 新增
│   │   └── routing.md          # 新增
│   ├── policies/                # 新增目录
│   │   ├── goals.md            # 新增
│   │   └── safety.md           # 新增
│   ├── indexes/                 # 新增目录
│   │   └── context-rules.md    # 新增
│   ├── init/                    # 新增目录
│   │   └── PROJECT_INIT_GUIDE.md  # 新增
│   └── modules/                 # 新增目录
│       └── MODULE_INIT_GUIDE.md   # 新增
└── modules/
    └── <module-entity>/
        ├── agent.md             # 新增(模块实例级)
        ├── README.md            # 已有
        ├── plan.md              # 已有
        └── doc/                 # 新增目录
            ├── CHANGELOG.md     # 从上级移入
            ├── CONTRACT.md      # 从上级移入
            ├── PROGRESS.md      # 从上级移入
            ├── BUGS.md          # 从上级移入
            ├── RUNBOOK.md       # 从上级移入
            └── TEST_PLAN.md     # 从上级移入
```

### 3.2 agent.md v2 规范(草案)
**结构**: YAML Front Matter + Markdown正文

**YAML最小必需字段**:
```yaml
---
spec_version: "1.0"
agent_id: "repo" 或 "modules.<entity>.<instance>"
role: "角色描述"
level: 1|2|3|4  # 模块层级
module_type: "类型路径"  # 如 "1_Assign/2_Select"
ownership:
  code_paths:
    include: ["可改动路径"]
    exclude: ["只读路径"]
io:
  inputs: [...]
  outputs: [...]
contracts:
  apis: [...]
dependencies:
  upstream: [...]
  downstream: [...]
constraints: [...]
tools_allowed:
  calls: [...]
quality_gates:
  required_tests: [...]
  coverage_min: 0.75
orchestration_hints:
  triggers: [...]
  routing_tags: [...]
context_routes:
  always_read: [...]
  on_demand: [...]
---
```

### 3.3 新增脚本（已实施）
**Phase 1-4完成**:
1. `scripts/agent_lint.py` - 校验agent.md YAML前言
2. `scripts/registry_check.py` - 校验registry.yaml
3. `scripts/doc_route_check.py` - 校验context_routes路径
4. `scripts/registry_gen.py` - 生成registry.yaml草案
5. `scripts/module_doc_gen.py` - 生成MODULE_INSTANCES.md
6. `scripts/type_contract_check.py` - 校验模块类型契约
7. `scripts/doc_script_sync_check.py` - 文档脚本双向检查
8. `scripts/validate.sh` - 聚合验证

**Phase 5完成**:
9. `scripts/db_lint.py` - 数据库文件校验

**Phase 6+计划**:
10. `scripts/fixture_loader.py` - Fixtures加载器（模块感知）
11. `scripts/mock_generator.py` - Mock数据生成器（可选）
12. `scripts/mock_lifecycle.py` - Mock生命周期管理（可选）
13. `scripts/db_env.py` - 数据库环境管理（可选）

### 3.4 Makefile新增命令（已实施+计划）
```makefile
# 已实施（Phase 1-5）
agent_lint:                # agent.md校验
registry_check:            # registry.yaml校验
doc_route_check:           # 文档路由校验
type_contract_check:       # 类型契约校验
doc_script_sync_check:     # 脚本同步检查
registry_gen:              # 生成registry.yaml草案
module_doc_gen:            # 生成MODULE_INSTANCES.md
validate:                  # 聚合验证（7个检查）
db_lint:                   # 数据库文件校验

# 计划（Phase 6-8）
load_fixture:              # 加载模块Fixtures
generate_mock:             # 生成Mock数据（可选）
cleanup_mock:              # 清理Mock数据（可选）
db_env:                    # 切换数据库环境（可选）
```

---

## 4. 风险与缓解

### 4.1 风险
1. **根agent.md拆分**可能导致引用缺失
2. **registry.yaml不完整**可能导致编排断链
3. **模块文档迁移**可能影响现有脚本
4. **首次改造工作量大**,可能影响项目进度

### 4.2 缓解措施
1. 保留根agent.md副本,可随时回滚
2. registry.yaml增量维护,先覆盖核心模块
3. 路径适配时保留兼容别名
4. 分阶段推进,每个阶段都可独立验证

---

## 5. 验收标准(草案)

### 5.1 Repo级
- [x] 根agent.md轻量(≤500行) - 256行 ✅
- [x] 根agent.md包含§1.3"应用层与模块层职责边界" - 已删除，迁移到roles.md ✅
- [x] 根README.md顶部有"编排系统请读agent.md"声明 ✅
- [x] schemas/agent.schema.yaml存在且字段完整 ✅
- [x] doc/orchestration/registry.yaml列举所有模块 ✅
- [x] doc/modules/MODULE_TYPES.md存在 ✅
- [x] doc/modules/MODULE_INSTANCES.md可生成 ✅
- [x] docs/已改名为doc/ ✅
- [x] flows/已移动到doc/flows/ ✅
- [x] db/目录结构建立 ✅（Phase 5完成）
- [x] **db/engines/postgres/migrations/已迁移** ✅（Phase 5完成）
- [x] **db/engines/postgres/docs/已迁移** ✅（Phase 5完成）
- [x] **db/engines/postgres/schemas/tables/有示例YAML** ✅（Phase 5完成）
- [ ] CI成功跑通所有校验
- [x] 路由指向的文档均存在 ✅

### 5.2 模块级
- [x] 示例模块存在agent.md/README.md/plan.md/doc/* ✅（Phase 4完成，移至doc/modules/example/）
- [x] 示例模块有core/子目录（必需） ✅
- [x] 示例模块的api/frontend/根据需要创建 ✅
- [x] README.md有"目录结构"章节说明 ✅
- [x] doc/CONTRACT.md区分API和前端组件说明 ✅
- [x] agent.md的ownership.code_paths和tools_allowed合理 ✅
- [x] 模块在registry.yaml中注册 ✅（作为reference_modules）
- [x] **模块包含测试数据定义（test_data路由）** ✅（Phase 6完成，example已配置）
- [x] **模块有TEST_DATA.md规格文档** ✅（Phase 6完成，example有完整示例）
- [x] **模块有fixtures/目录结构** ✅（Phase 6完成，example有完整示例）

### 5.3 文档级
- [ ] 所有文档格式符合规范(无颜文字、语言一致、结构化)
- [ ] 所有代码块正确标记语言
- [ ] 所有路径索引和路由正确
- [ ] 无临时文件残留
- [ ] 无无效或过时文档
- [ ] 所有文档内部链接有效

### 5.4 自动化级
- [x] `make agent_lint`通过 ✅
- [x] `make registry_check`通过 ✅
- [x] `make doc_route_check`通过 ✅
- [x] `make type_contract_check`通过 ✅（Phase 4完成）
- [x] `make doc_script_sync_check`通过 ✅（Phase 4完成）
- [x] `make module_doc_gen`可运行 ✅
- [x] `make db_lint`通过 ✅（Phase 5完成）
- [x] `make validate`可运行 ✅（Phase 4完成）
- [ ] `make load_fixture MODULE=example FIXTURE=minimal`可运行 （Phase 6-7计划）
- [ ] `make generate_mock MODULE=example TABLE=users COUNT=100`可运行 （Phase 7-8计划，可选）
- [ ] `make dev_check`全部通过

---

## 6. 当前状态更新(2025-11-07)

### 已完成
- [x] Phase 0: 调研与方案确认
- [x] Phase 1: Schema与基础设施
- [x] Phase 2: 目录结构调整
- [x] Phase 3: 根agent.md轻量化
- [x] Phase 4: 模块实例标准化
- [x] Phase 5: 数据库治理实施
- [x] Phase 6: 初始化规范完善（含Phase 6.5）
- [x] Phase 7: CI集成与测试数据工具

### Phase 5完成情况 ✅
1. ✅ 迁移migrations/到db/engines/postgres/migrations/
2. ✅ 迁移doc/db/到db/engines/postgres/docs/
3. ✅ 创建表结构YAML示例（runs.yaml）
4. ✅ 编写数据库校验脚本（db_lint.py）
5. ✅ Makefile新增db_lint命令
6. ✅ 测试半自动化流程
7. ✅ 更新所有路径引用
8. ✅ 创建完成报告和最终总结

### 用户已确认的决策
1. ✅ 模块文档迁移到doc/子目录
2. ✅ 根agent.md轻量化到≤500行
3. ✅ registry.yaml半自动化(自动生成+手动确认)
4. ✅ 初始化流程重点是大模型交互
5. ✅ YAML Schema以智能体编排需求为准,尽可能填写
6. ✅ **数据库半自动化操作**(类似registry.yaml方式)

### Phase 6完成情况 ✅
1. ✅ 更新PROJECT_INIT_GUIDE.md（增加AI对话范式，5组问题）
2. ✅ 更新MODULE_INIT_GUIDE.md（新增Phase 6和7）
3. ✅ Schema扩展：agent.schema.yaml添加test_data字段
4. ✅ 创建TEST_DATA.md.template模板（428行）
5. ✅ 更新example模块：添加测试数据示例
6. ✅ 更新scripts/agent_lint.py支持test_data字段
7. ✅ 更新scripts/module_doc_gen.py支持生成Mock规则
8. ✅ 更新scripts/ai_begin.sh以支持新结构
9. ✅ 测试模块初始化流程
10. ✅ 创建Phase 6报告和总结

### Phase 6.5完成情况 ✅（用户反馈优化）
1. ✅ 创建doc/process/DB_CHANGE_GUIDE.md（数据库变更流程，630行）
2. ✅ 修改MODULE_INIT_GUIDE.md Phase 6（标记可选，引导到独立流程）
3. ✅ 补充PROJECT_INIT_GUIDE.md（4种初始化方式）
   - 方式1: 有开发文档（文档驱动）
   - 方式2: 从零开始（AI对话式）
   - 方式3: 手动初始化（操作清单）
   - 方式4: 导入现有项目（项目迁移）
4. ✅ 更新plan.md模板（添加数据库/测试数据影响评估）
5. ✅ 更新agent.md（添加数据库变更路由）
6. ✅ 创建doc/init/MANUAL_INIT_CHECKLIST.md（手动初始化，470行）
7. ✅ 创建doc/init/PROJECT_MIGRATION_GUIDE.md（项目迁移，1063行）
8. ✅ 测试完整流程

### 待办
- [x] 用户审阅Phase 6 + 6.5成果 ✅
- [x] Phase 6/6.5遗留任务已梳理 ✅（见temp/Phase6_遗留任务清单.md）
- [x] Phase 7执行完成 ✅
- [x] Phase 8执行完成 ✅
- [x] Phase 8.5执行完成 ✅
- [ ] 开始Phase 9执行

### Phase 7完成情况 ✅
1. ✅ dev_check集成（整合15个检查命令）
2. ✅ 实现fixture_loader.py（480行，模块感知）
3. ✅ Makefile新增5个测试数据管理命令
4. ✅ 更新scripts/README.md（Phase 5和Phase 7章节）
5. ✅ 全面测试所有新增命令
6. ✅ 创建完成报告和最终总结

**Phase 6/6.5遗留任务处理结果**:
- ✅ **必须任务（已完成）**: fixture_loader.py、dev_check集成
- ⏸️ **建议任务（留待Phase 8.5）**: db_env.py、CI配置更新
- ⏸️ **可选任务（留待未来）**: mock_generator.py、mock_lifecycle.py、project_migrate.py、doc_parser.py

**详见**: `temp/Phase7_完成报告.md`, `temp/Phase7_最终总结.md`

---

### Phase 8完成情况 ✅
1. ✅ 文档路径全面更新（70+处）
2. ✅ 核心文档更新（README, QUICK_START, TEMPLATE_USAGE）
3. ✅ doc/目录文档更新（12+个）
4. ✅ scripts/脚本路径更新（4个）
5. ✅ 旧文件清理（docs_old_backup/, agent_new.md）
6. ✅ 文档结构修复（doc/flows/dag.yaml）
7. ✅ 完整性检查（make validate 7/7通过）
8. ✅ 创建完成报告和最终总结

**详见**: `temp/Phase8_完成报告.md`, `temp/Phase8_最终总结.md`

---

### Phase 8.5完成情况 ✅（中优先级遗留任务实施）
1. ✅ CI配置更新（.github/workflows/ci.yml, +15行，集成15+个检查）
2. ✅ fixture_loader数据库连接（+140行，支持实际SQL执行）
   - 添加psycopg2支持（可选依赖）
   - 实现get_db_config和connect_to_db函数
   - 3种配置方式、事务管理、智能降级
3. ✅ db_env.py环境管理工具（285行）
   - 环境识别显示、连接测试、多环境查看
4. ✅ .context/上下文恢复机制（规范+实施）
   - doc/process/CONTEXT_GUIDE.md（约600行）
   - example/.context/示例（完整）
   - MODULE_INIT_GUIDE.md新增Phase 8
   - ai_begin.sh自动创建.context/
   - .gitignore排除规则

**详见**: `temp/Phase8.5_完成报告.md`, `temp/Phase8.5_最终总结.md`

**遗留任务处理完成度**:
- ✅ 必须任务：全部完成（Phase 7）
- ✅ 建议任务：全部完成（Phase 8.5）
- ⏸️ 可选任务：留待未来按需实施

---

## 7. Phase 9详细说明：文档审查与清理流程

### 7.1 目标
确保升级完成后：
- 所有文档质量达标
- 无无效或过时文档
- 格式规范统一
- 路径引用正确
- 自动化链路通畅

### 7.2 审查清单

#### A. 文档完整性审查
```bash
# 1. 检查必需文档
- 根目录: agent.md, README.md, QUICK_START.md, TEMPLATE_USAGE.md, CONTRIBUTING.md
- doc/: orchestration/, policies/, indexes/, init/, modules/等子目录及文档
- modules/<entity>/: agent.md, README.md, plan.md, doc/（6个文档）

# 2. 检查文档间引用
- agent.md中的context_routes指向的文档存在
- README.md中链接的文档存在
- 各模块文档间的交叉引用有效

# 3. 验证命令
make consistency_check
make doc_route_check
```

#### B. 文档格式审查
```bash
# 1. 自动格式检查
make doc_style_check

# 检查项：
- [ ] 无颜文字（除代码示例外）
- [ ] 语言一致性（无中英文混用）
- [ ] 代码块标记语言
- [ ] 数学公式使用LaTeX格式
- [ ] 标题层级正确（无跳级）
- [ ] 无模糊表达
- [ ] 使用逻辑连接词和编号

# 2. 人工抽查
随机抽查3-5个文档，验证：
- 目标和上下文说明清晰
- 操作步骤使用分步结构
- 包含验证步骤（如适用）
- 包含回滚逻辑（如适用）
```

#### C. 无效文档识别与清理
```bash
# 1. 识别无效文档
过时文档标准：
- 指向不存在的路径或文件
- 描述已废弃的功能
- 与当前架构不符
- 标记为"待删除"或"已废弃"

# 2. 临时文件清理
make cleanup_tmp

# 3. 草案文件检查
查找所有.draft文件，确认是否已正式化：
find . -name "*.draft" -type f

# 4. 删除或归档
- 删除：确认无用的文档
- 归档：移动到docs/archived/（如需保留历史）
```

#### D. 路径引用全面验证
```bash
# 1. 运行路由检查
make doc_route_check

# 2. 检查Markdown链接
使用工具检查所有.md文件的内部链接：
- 相对路径链接
- 绝对路径链接
- 锚点链接

# 3. 检查代码中的路径引用
grep -r "docs/" --include="*.py" --include="*.md"
grep -r "flows/" --include="*.py" --include="*.md"
grep -r "migrations/" --include="*.py" --include="*.md"

# 4. 验证修复
确保所有路径引用已更新为新路径
```

#### E. 脚本双向同步检查（新增）⭐
```bash
# 1. 运行脚本同步检查
make doc_script_sync_check

# 或直接运行脚本：
python scripts/doc_script_sync_check.py

# 检查内容：
- [ ] 文档提及但脚本/命令不存在（缺失实现）
- [ ] 脚本存在但文档未提及（孤儿脚本）
- [ ] Makefile命令与实际脚本的映射关系
- [ ] 所有脚本在scripts/README.md中有说明

# 2. 处理发现的问题
对于缺失实现：
- 实现对应的脚本
- 或更新文档移除无效引用

对于孤儿脚本：
- 在文档中补充说明
- 或删除不再需要的脚本
- 确保scripts/README.md包含所有脚本

# 3. 再次验证
确保所有脚本与文档完全同步
```

#### F. 自动化链路测试
```bash
# 1. 运行完整dev_check
make dev_check

# 包含的检查：
- docgen（文档索引生成）
- doc_style_check（文档风格）
- dag_check（DAG校验）
- contract_compat_check（契约兼容性）
- deps_check（依赖检查）
- runtime_config_check（配置校验）
- migrate_check（迁移检查）
- consistency_check（一致性）
- frontend_types_check（前端类型）
- agent_lint（agent.md校验）
- registry_check（注册表校验）
- doc_route_check（文档路由）
- doc_script_sync_check（脚本同步）← 新增
- db_lint（数据库校验，如Phase 5完成）

# 2. 测试半自动化工具
make registry_gen          # 生成registry草案
make module_doc_gen        # 生成模块文档

# 如Phase 5完成：
make db_plan TARGET=dev    # 数据库迁移预览
make db_docgen             # 生成数据库文档

# 3. 验证生成的文档
检查自动生成的文档格式正确、内容完整
```

#### F. 文档内容质量审查
```bash
# 1. README.md审查
每个README.md应包含：
- [ ] 目标/概述
- [ ] 适用场景
- [ ] 前置条件（如适用）
- [ ] 快速开始/使用说明
- [ ] 目录结构说明（模块README）
- [ ] 相关文档链接

# 2. agent.md审查
每个agent.md应包含：
- [ ] YAML Front Matter（通过agent_lint校验）
- [ ] Summary章节
- [ ] Responsibilities章节
- [ ] Limitations章节
- [ ] I/O Examples
- [ ] context_routes路径正确

# 3. CONTRACT.md审查
每个CONTRACT.md应包含：
- [ ] API接口定义（如有）
- [ ] 前端组件说明（如有）
- [ ] 请求/响应格式
- [ ] 调用示例
- [ ] 错误码说明

# 4. 初始化文档审查
- [ ] PROJECT_INIT_GUIDE.md包含对话范式
- [ ] MODULE_INIT_GUIDE.md包含子目录创建规范
- [ ] MODULE_TYPES.md内容完整
- [ ] 模板文件（TEMPLATES/）齐全
```

#### G. 按标准评估Repo质量（新增）⭐
```bash
# 对照执行计划.md §5"验收标准(草案)"逐项检查

# 1. Repo级验收（11项）
- [ ] 根agent.md轻量(≤500行)
- [ ] 根agent.md包含§1.3"应用层与模块层职责边界"
- [ ] 根README.md顶部有"编排系统请读agent.md"声明
- [ ] schemas/agent.schema.yaml存在且字段完整
- [ ] doc/orchestration/registry.yaml列举所有模块
- [ ] doc/modules/MODULE_TYPES.md存在
- [ ] doc/modules/MODULE_INSTANCES.md可生成
- [ ] docs/已改名为doc/
- [ ] flows/已移动到doc/flows/
- [ ] db/目录结构建立
- [ ] CI成功跑通所有校验
- [ ] 路由指向的文档均存在

# 2. 模块级验收（7项）
- [ ] 示例模块存在agent.md/README.md/plan.md/doc/*
- [ ] 示例模块有core/子目录（必需）
- [ ] 示例模块的api/frontend/根据需要创建
- [ ] README.md有"目录结构"章节说明
- [ ] doc/CONTRACT.md区分API和前端组件说明
- [ ] agent.md的ownership.code_paths和tools_allowed合理
- [ ] 模块在registry.yaml中注册

# 3. 文档级验收（6项）
- [ ] 所有文档格式符合规范(无颜文字、语言一致、结构化)
- [ ] 所有代码块正确标记语言
- [ ] 所有路径索引和路由正确
- [ ] 无临时文件残留
- [ ] 无无效或过时文档
- [ ] 所有文档内部链接有效

# 4. 自动化级验收（6项）
- [ ] `make agent_lint`通过
- [ ] `make registry_check`通过
- [ ] `make doc_route_check`通过
- [ ] `make module_doc_gen`可运行
- [ ] `make db_lint`通过（如Phase 5完成）
- [ ] `make dev_check`全部通过

# 5. 生成评估报告
创建文件：temp/Phase9_Repo质量评估报告.md
内容包括：
- 各级验收结果（通过/未通过/部分通过）
- 未达标项详细说明
- 需要修复的问题清单
- 优化建议
```

#### H. 生成最终报告
```bash
# 1. 变更清单
记录所有Phase的变更：
- 新增文件列表
- 修改文件列表
- 删除文件列表
- 重命名/移动文件映射表

# 2. 路径映射表
生成完整的旧路径→新路径映射表：
docs/ → doc/
flows/ → doc/flows/
migrations/ → db/engines/postgres/migrations/
docs/db/ → db/engines/postgres/docs/
modules/<entity>/CONTRACT.md → modules/<entity>/doc/CONTRACT.md

# 3. 验收报告
- Repo级验收结果
- 模块级验收结果
- 文档级验收结果
- 自动化级验收结果

# 4. 问题汇总（如有）
- 待解决问题
- 遗留优化项
- 建议改进点
```

### 7.3 清理脚本（可选）

可以创建一个专门的清理检查脚本：

```python
# scripts/final_cleanup_check.py
功能：
1. 扫描所有文档文件
2. 检查格式规范
3. 识别无效引用
4. 生成清理建议报告
```

### 7.4 Phase 9执行时间
预计：2-3天

**子任务时间分配**:
- 文档完整性和格式审查: 0.5天
- 无效文档识别和清理: 0.5天
- 路径引用全面验证: 0.5天
- 自动化链路测试: 0.5天
- 文档内容质量审查: 0.5天
- 生成最终报告: 0.5天

### 7.5 Phase 9验收标准
- [ ] `make doc_style_check`通过
- [ ] `make doc_route_check`通过
- [ ] `make doc_script_sync_check`通过（新增）
- [ ] `make consistency_check`通过
- [ ] `make dev_check`全部通过
- [ ] 无临时文件（`make cleanup_tmp`清理后）
- [ ] 无.draft文件残留
- [ ] 路径映射表完整
- [ ] Repo质量评估报告生成（新增）
- [ ] 脚本同步检查报告生成（新增）
- [ ] 最终验收报告生成
- [ ] 所有文档质量达标
- [ ] 所有验收标准（§5）达标或有改进计划

---

## 8. 总体时间预估（更新）

| Phase | 任务 | 预估时间 | 状态 |
|-------|------|---------|------|
| Phase 0 | 调研与方案确认 | - | ✅ 完成 |
| Phase 1 | Schema与基础设施 | 4-6天 | ✅ 完成 |
| Phase 2 | 目录结构调整 | 6-8天 | ✅ 完成 |
| Phase 3 | 根agent.md轻量化与目录改名 | 4-6天 | ✅ 完成 |
| Phase 4 | 模块实例标准化 | 4-6天 | ✅ 完成 |
| Phase 5 | 数据库治理实施 | 5-7天 | ✅ 完成 |
| Phase 6 | 初始化规范完善 | 2-3天 | ✅ 完成 |
| Phase 6.5 | 触发机制与迁移完善（用户反馈） | 2天 | ✅ 完成 |
| Phase 7 | CI集成与测试数据工具 | 2-3天 | ✅ 完成 |
| Phase 8 | 文档更新与高级功能 | 2-3天 | ✅ 完成 |
| Phase 8.5 | 中优先级遗留任务实施 | 1-2天 | ✅ 完成 |
| Phase 9 | 文档审查与清理（含9+优化） | 2-3天 | ✅ 完成 |
| **Phase 10** | **claude-showcase优势集成** | **9-14天** | **⏳ 计划** |
| Phase 11 | 补充优化 | 2-3天 | ⏸️ 可选 |
| Phase 12 | 社区与长期演进 | 持续 | ⏸️ 长期 |

**v1.0阶段（Phase 0-9）**:
- 预估时间：35-51天
- 实际已用：约1-2天
- 完成度：100% ✅

**v2.0阶段（Phase 10-11）**:
- 预估时间：11-17天
- 核心（Phase 10）：9-14天
- 可选（Phase 11）：2-3天

**总体进度**: 
- Phase 0-9: 100% ✅ (v1.0生产就绪)
- Phase 10-12: 计划中 (v2.0增强版)

---

## 9. 变更历史
- 2025-11-07: 创建执行计划草案
- 2025-11-07: Phase 1执行完成
- 2025-11-07: 新增Phase 9"文档审查与清理流程"
- 2025-11-07: Phase 9增加两个环节：脚本双向同步检查、按标准评估Repo质量
- 2025-11-07: Phase 5执行完成（数据库治理实施）
- 2025-11-07: Phase 5扩展讨论后更新Phase 6-8子任务
  - Phase 6增加测试数据管理基础（4个子任务）
  - Phase 7增加Fixtures管理工具实施
  - Phase 8增加Mock生成器实施（可选）
  - 更新验收标准，标记已完成项
- 2025-11-07: 为所有Phase添加"必读文档"说明
  - Phase 1-9均添加"必读文档（开始前）"章节
  - 明确每个Phase开始前应该阅读的文档
  - 确保上下文连续性和方案理解
- 2025-11-07: Phase 6执行完成（初始化规范完善）
  - 10个子任务全部完成
  - 新增8个文件，修改6个文件，约1200行
  - AI对话式引导体系、测试数据管理基础、工具链完善
- 2025-11-07: Phase 6.5执行完成（用户反馈优化）
  - 8个子任务全部完成
  - 新增5个文件，修改4个文件，约3300行
  - 数据库变更动态触发机制、4种初始化方式完整实现
  - 解决用户反馈的两个关键问题
- 2025-11-07: Phase 7执行完成（CI集成与测试数据工具）
  - 必须任务5/5全部完成（dev_check集成、fixture_loader.py）
  - 新增3个文件，修改2个文件，约1200行
  - dev_check从9个检查扩展到15个检查
  - 实现fixture_loader.py（480行，模块感知的Fixtures加载工具）
  - Makefile新增5个测试数据管理命令
  - 完成Phase 6/6.5的2个必须遗留任务
  - 总体进度达到80%（8/10 Phase完成）

- 2025-11-08: Phase 8执行完成（文档更新与高级功能实施）
  - 文档路径全面更新（70+处）：docs/→doc/, flows/→doc/flows/, migrations/→db/engines/postgres/migrations/
  - 核心文档更新（README.md, QUICK_START.md, TEMPLATE_USAGE.md）
  - doc/目录文档更新（12+个）
  - scripts/脚本更新（4个）
  - 旧文件清理（docs_old_backup/, agent_new.md）
  - 文档结构修复（doc/flows/dag.yaml）
  - make validate 7/7检查全部通过
  - 修改文件20+个，新增3个，删除2个
  - 总体进度达到90%（9/10 Phase完成）

- 2025-11-08: Phase 8.5执行完成（中优先级遗留任务实施+.context/机制）
  - CI配置更新：.github/workflows/ci.yml集成15+个检查
  - fixture_loader数据库连接：支持实际SQL执行（+140行）
  - db_env.py环境管理工具：完整实现（285行）
  - .context/上下文恢复机制：规范和实施
    - doc/process/CONTEXT_GUIDE.md（约600行）
    - example/.context/示例（完整）
    - MODULE_INIT_GUIDE.md新增Phase 8（上下文恢复）
    - ai_begin.sh自动创建.context/目录
    - .gitignore排除规则
  - 新增文件约1200行，修改文件11个
  - 完成所有建议任务
  - 总体进度达到95%（9.5/10 Phase完成）

- 2025-11-08: Phase 9执行完成（文档审查与清理+优化评估）
  - 文档格式规范化：清理装饰性emoji（7个文档，20+处）
  - safety.md精简：299→233行（-22%），节省100 tokens
    - 拆分security_details.md（537行）和quality_standards.md（402行）
  - agent.md路由更新：新增"安全详情"主题，路由28个
  - Repo质量评估：95/100分（全面验收）
  - 智能体编排系统效率评估：⭐⭐⭐⭐⭐（5/5）
  - 业务模块定义：3维度+4类型+决策树
  - Mock文档完善方案：5个方面，优先级明确
  - 其他优化项识别：8个优化点
  - 数据流转和中间件评估：当前不需要，可渐进演进
  - 总体进度达到100%（10/10 Phase完成）✅

- 2025-11-08: Phase 10-12规划完成（claude-showcase优势集成）
  - 基于互补方案创建后续改进计划
  - Phase 10: claude-showcase优势集成（9-14天）
    - 10.1 智能触发系统（1-2天）
    - 10.2 渐进式披露改造（3-4天）
    - 10.3 Dev Docs机制实施（2-3天）
    - 10.4 Guardrail机制增强（1-2天）
    - 10.5 集成验证与文档（1天）
  - Phase 11: 补充优化（2-3天，可选）
    - Mock文档完善、CONVENTIONS完善、module_scaffold、GitHub Actions模板
  - Phase 12: 社区与长期演进（持续）
  - 预期收益：AI效率+30%、Token成本-25%、错误避免+93%、上下文恢复-83%
  - 首年ROI: 887%


