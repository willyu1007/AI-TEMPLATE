# AI-TEMPLATE Repo 改进执行计划

> **状态**: 草案(Draft)
> **创建日期**: 2025-11-07
> **最后更新**: 2025-11-07

---

## 重要说明
本执行计划处于**草案阶段**,在获得最终确认前,**不允许修改temp目录以外的任何文件或目录**。

---

## 0. 目标
完善AI-TEMPLATE仓库的结构和文档体系,实现:
1. **AI友好**: 文档可解析、上下文按需加载、路径路由清晰
2. **模块化**: 同类型可替换、实例独立、I/O稳定
3. **自动化**: 一切可校验、可脚本化、可CI化
4. **可编排**: 支持智能体自动读取/合并agent.md,基于标签与约束调度

---

## 1. 改进原则
1. 以AI友好和模块化为核心导向
2. 以自动化流程的完备程度为评价标准
3. 融入和适配智能体编排体系
4. repo骨架为模板,repo中的文档为通用文档(项目无关)
5. 通过初始化引导,将模板转换成项目repo

---

## 2. 执行阶段划分

### Phase 0: 调研与方案确认(当前阶段)
**目标**: 充分理解需求,形成可行方案,获得确认
**状态**: 进行中

**子任务**:
- [x] 遍历当前repo,熟悉架构
- [x] 阅读agent.md和README.md等关键文档
- [x] 了解自动化流程(Makefile + scripts/)
- [ ] 阅读需求文档,理解改进方向
- [ ] 阅读参考方案,吸收好的建议
- [ ] 形成初步改进方案
- [ ] 与用户充分讨论,对齐需求
- [ ] 形成最终执行计划
- [ ] 获得用户确认

**关键产出**:
- [x] 阅读笔记.md (当前repo理解)
- [ ] 修改方案(初稿).md
- [ ] 最终执行计划.md

### Phase 1: 骨架调整与Schema建立 ✅（已完成）
**目标**: 建立agent.md v2规范,调整目录结构
**前置条件**: Phase 0完成并获得确认

**必读文档**（开始前）⭐:
- `temp/修改方案(正式版).md` - 了解完整方案
- `temp/执行计划.md` - 了解Phase划分
- `temp/参考方案和建议/AI-TEMPLATE-Enhancement-Pack/` - 参考示例

**子任务**（已完成）:
1. 新增schemas/agent.schema.yaml
2. 调整doc/目录结构
3. 为模块实例补齐doc/子目录
4. 建立doc/orchestration/registry.yaml草案
5. 新增agent.md校验脚本

**详见**: `temp/Phase1_最终总结.md`

### Phase 2: 目录结构调整 ✅（已完成）
**目标**: 创建doc/和db/子目录，编写规范文档
**前置条件**: Phase 1完成

**必读文档**（开始前）⭐:
- `temp/Phase1_最终总结.md` - 了解Phase 1成果
- `temp/修改方案(正式版).md` - 了解目录结构设计（第8.2节）
- `temp/参考方案和建议/AI-TEMPLATE-Enhancement-Pack/` - 参考文档示例

**子任务**（已完成）:
1. 创建doc/子目录结构
2. 创建db/子目录结构
3. 编写规范文档（routing.md, goals.md, safety.md等）
4. 创建文档模板（6个）
5. 正式化registry.yaml

**详见**: `temp/Phase2_最终总结.md`

### Phase 3: 根agent.md轻量化与目录改名 ✅（已完成）
**目标**: 根agent.md轻量化，docs/和flows/目录整合
**前置条件**: Phase 2完成

**必读文档**（开始前）⭐:
- `temp/Phase2_最终总结.md` - 了解Phase 2成果
- `agent.md` - 了解当前agent.md内容（2434行）
- `temp/修改方案(正式版).md` - 了解轻量化方案（第8.3节）

**子任务**（已完成）:
1. 建立内容迁移映射表
2. 迁移内容到doc/下的各个文档
3. 精简agent.md到256行
4. 添加完整YAML Front Matter
5. docs/和doc/目录合并
6. flows/移动到doc/flows/

**详见**: `temp/Phase3_最终总结.md`, `temp/Phase3_agent优化记录.md`

### Phase 4: 模块实例标准化 ✅（已完成）
**目标**: 为模块实例补齐agent.md和文档结构，优化模块类型体系
**前置条件**: Phase 3完成

**必读文档**（开始前）⭐:
- `temp/Phase3_最终总结.md` - 了解Phase 3成果
- `doc/modules/MODULE_TYPES.md` - 了解当前模块类型（477行）
- `temp/修改方案(正式版).md` - 了解模块标准化方案（第8.4节）

**子任务**（已完成）:
1. 为example模块补齐agent.md
2. 创建example/doc/子目录，迁移6个文档
3. example移至doc/modules/（参考文档定位）
4. 创建MODULE_TYPE_CONTRACTS.yaml
5. 精简MODULE_TYPES.md（477→274行）
6. 实现type_contract_check.py
7. 实现doc_script_sync_check.py

**详见**: `temp/Phase4_完整总结.md`

### Phase 5: 数据库治理实施 ✅（已完成）
**目标**: 建立db/目录结构，实现半自动化
**前置条件**: Phase 4完成

**必读文档**（开始前）⭐:
- `temp/Phase4_完整总结.md` - 了解Phase 4成果
- `db/engines/README.md` - 了解数据库目录规范（Phase 3创建）
- `doc/db/DB_SPEC.yaml` - 了解当前数据库规范
- `migrations/` - 了解当前迁移脚本

**子任务**（已完成）:
1. 创建db/engines/postgres/目录结构
2. 迁移migrations/到db/engines/postgres/migrations/
3. 迁移docs/db/到db/engines/postgres/docs/
4. 为核心表创建tables/*.yaml
5. 新增数据库相关脚本
6. Makefile新增db相关命令
7. 测试半自动化流程
8. 更新相关文档和脚本的路径引用

### Phase 6: 初始化规范完善
**目标**: 完善PROJECT_INIT_GUIDE.md和MODULE_INIT_GUIDE.md，增加测试数据管理
**前置条件**: Phase 5完成

**必读文档**（开始前）⭐:
- `temp/Phase5_最终总结.md` - 了解Phase 5成果
- `temp/Phase5_数据库治理扩展方案.md` - 了解测试数据管理方案（第5-7节）
- `doc/modules/MODULE_INIT_GUIDE.md` - 查看当前的引导内容
- `schemas/agent.schema.yaml` - 了解当前Schema结构

**子任务**:
1. 更新PROJECT_INIT_GUIDE.md（增加对话范式）
2. 更新MODULE_INIT_GUIDE.md（增加DB变更引导）
3. **增加MODULE_INIT_GUIDE.md第7步：定义测试数据需求**（Phase 5扩展）⭐
   - AI引导对话示例
   - Fixtures和Mock的选择逻辑
   - 数据分布定义方法
4. **Schema扩展：agent.schema.yaml添加test_data字段**（Phase 5扩展）⭐
5. **创建TEST_DATA.md.template模板**（Phase 5扩展）⭐
6. **更新example模块：添加测试数据示例**（Phase 5扩展）⭐
   - doc/modules/example/doc/TEST_DATA.md
   - doc/modules/example/fixtures/目录结构
7. 更新scripts/agent_lint.py支持test_data字段
8. 更新scripts/module_doc_gen.py支持生成Mock规则
9. 更新scripts/ai_begin.sh以支持新结构
10. 测试模块初始化流程

**验收**:
- [ ] MODULE_INIT_GUIDE.md包含"第7步：定义测试数据需求"
- [ ] agent.schema.yaml包含test_data字段定义
- [ ] TEST_DATA.md.template模板已创建
- [ ] example模块有完整的测试数据示例
- [ ] agent_lint支持test_data字段校验
- [ ] 按指南可完成初始化，生成的结构通过校验

### Phase 7: CI集成与测试数据工具实施
**目标**: 将所有校验集成到dev_check和CI，实施测试数据管理工具
**前置条件**: Phase 6 + 6.5完成

**必读文档**（开始前）⭐:
- `temp/Phase6_完整总结.md` - 了解Phase 6+6.5完整成果 ⭐
- `temp/Phase6_遗留任务清单.md` - 了解Phase 6/6.5的遗留任务 ⭐⭐
- `temp/Phase5_数据库治理扩展方案.md` - 了解Fixtures管理和环境管理方案（第4节、第7.2节）
- `doc/modules/example/doc/TEST_DATA.md` - 参考示例（Phase 6创建）
- `db/engines/postgres/schemas/tables/runs.yaml` - 了解表YAML结构

**Phase 6/6.5遗留任务**（本Phase必须处理）:
1. 🔴 **必须实施**: 
   - fixture_loader.py（Fixtures加载工具）← Phase 6遗留
   - dev_check集成（统一质量检查）← Phase 6遗留
2. 🟡 **建议实施**: 
   - db_env.py（环境管理工具）← Phase 6.5遗留
   - CI配置更新 ← Phase 6遗留

**子任务**:
1. 🔴 **Makefile: dev_check集成**（Phase 6遗留，必须）
   - 整合agent_lint, registry_check, doc_route_check, db_lint等
   - 统一输出格式
   - 错误汇总

2. 🔴 **实现Fixtures管理工具**（Phase 6遗留，必须）⭐
   - scripts/fixture_loader.py（模块感知的加载器）
   - 读取TEST_DATA.md定义
   - 支持场景选择（minimal/standard/full）
   - Makefile添加load_fixture命令
   - 清理功能

3. 🟡 **实现环境管理工具**（Phase 6.5遗留，建议）
   - scripts/db_env.py（环境切换和识别）
   - 创建db/engines/postgres/config/目录
   - 创建dev.yaml、test.yaml配置示例
   - Makefile添加db_env命令

4. 🟡 **更新CI配置**（Phase 6遗留，建议）
   - 更新.github/workflows/ci.yml（如有）
   - 集成所有校验命令

5. 全面测试dev_check
6. 修复发现的问题

**验收**:
- [ ] `make dev_check`包含所有校验（含db_lint）✅
- [ ] `make load_fixture MODULE=example FIXTURE=minimal`可运行 ✅（Phase 6遗留）
- [ ] fixture_loader.py可正常工作 ✅（Phase 6遗留）
- [ ] db_env.py可正常工作（如已实现）
- [ ] CI配置已更新

### Phase 8: 文档更新与高级功能实施
**目标**: 更新所有相关文档，实施高级数据库功能（可选）
**前置条件**: Phase 7完成

**必读文档**（开始前）⭐:
- `temp/Phase7_最终总结.md` - 了解Phase 7成果
- `temp/Phase6_遗留任务清单.md` - 了解Phase 6/6.5的可选遗留任务
- `temp/Phase5_数据库治理扩展方案.md` - 了解Mock生成器和实例注册表方案（第4.3-4.4节、第7.3节）
- `doc/modules/example/doc/TEST_DATA.md` - 参考Mock规则示例（Phase 6创建）

**Phase 6/6.5遗留任务**（本Phase可选处理）:
1. 🟢 **可选实施**（根据实际需求决定）:
   - mock_generator.py（Mock数据生成器）← Phase 6遗留
   - mock_lifecycle.py（Mock生命周期管理）← Phase 6遗留
   - project_migrate.py（项目迁移工具）← Phase 6.5遗留
   - doc_parser.py（文档解析器）← Phase 6.5遗留

**子任务**:
1. 更新README.md, QUICK_START.md, TEMPLATE_USAGE.md
2. 更新agent.md中的路径引用
3. 更新其他文档中的路径引用
4. 生成路径迁移映射表

5. 🟢 **实现Mock数据生成器**（Phase 6遗留，可选）⭐
   - scripts/mock_generator.py（模块感知，读取TEST_DATA.md的Mock规则）
   - scripts/mock_lifecycle.py（生命周期管理）
   - 创建db/engines/postgres/fixtures/mock/目录
   - Makefile添加generate_mock、cleanup_mock命令
   
6. 🟢 **实现项目迁移工具**（Phase 6.5遗留，可选）
   - scripts/project_migrate.py（自动化架构映射和import调整）
   - 生成迁移报告
   
7. 🟢 **实现文档解析器**（Phase 6.5遗留，可选）
   - scripts/doc_parser.py（解析PRD/需求文档）
   - 提取结构化信息（模块、表、技术栈）
   
8. 🟢 **实现数据库实例注册表**（Phase 5扩展，可选）⭐
   - 创建db/engines/registry.yaml
   - 实现实例识别和验证机制

9. 清理旧文件（migrations/和doc/db/的重定向文件）
10. 运行完整检验

**验收**:
- [ ] 所有路径引用正确
- [ ] 路径迁移映射表完整
- [ ] mock_generator.py可正常工作（如已实施）
- [ ] `make generate_mock MODULE=example COUNT=1000`可运行（如已实施）
- [ ] project_migrate.py可正常工作（如已实施）
- [ ] 旧文件已清理
- [ ] `make dev_check`全部通过

### Phase 9: 文档审查与清理
**目标**: 全面审查文档质量，清理无效文档，确保格式正确
**前置条件**: Phase 8完成

**必读文档**（开始前）⭐:
- `temp/Phase8_最终总结.md` - 了解Phase 8成果
- `temp/执行计划.md` - 查看§5"验收标准"（30项）
- `doc/process/CONVENTIONS.md` - 了解文档规范
- `doc/process/DoR_DoD.md` - 了解质量标准

**子任务**:
1. **文档完整性审查**
   - 检查所有必需文档是否齐全
   - 验证文档间引用的有效性
   - 确认文档路由正确

2. **文档格式审查**
   - 运行`make doc_style_check`检查格式
   - 检查颜文字使用（应无）
   - 检查语言一致性（中英文混用）
   - 检查代码块语言标记
   - 检查数学公式格式（LaTeX）
   - 检查标题层级（无跳级）

3. **文档内容审查**
   - 检查目标和上下文说明是否清晰
   - 检查是否有模糊表达
   - 检查逻辑流程是否使用分步结构
   - 检查是否包含验证步骤和回滚逻辑

4. **无效文档清理**
   - 识别并删除过时文档
   - 清理临时文档（运行`make cleanup_tmp`）
   - 删除.draft后缀的草案文件（如已正式化）
   - 删除重复或冗余文档

5. **路径引用验证**
   - 运行`make doc_route_check`验证所有路由
   - 检查文档内部链接的有效性
   - 验证所有路径引用可访问
   - 生成断链报告

6. **脚本双向同步检查**（新增）⭐
   - 运行`make doc_script_sync_check`进行双向检查
   - 检查文档提及但脚本不存在（缺失实现）
   - 检查脚本存在但文档未提及（孤儿脚本）
   - 验证Makefile命令与实际脚本的映射关系
   - 更新scripts/README.md确保所有脚本都有说明

7. **自动化链路测试**
   - 运行完整`make dev_check`
   - 验证所有校验脚本通过
   - 测试半自动化流程（registry_gen, module_doc_gen, db相关）
   - 确认CI流程正常

8. **按标准评估Repo质量**（新增）⭐
   - 对照§5"验收标准"逐项检查
   - Repo级验收（11项）
   - 模块级验收（7项）
   - 文档级验收（6项）
   - 自动化级验收（6项）
   - 生成评估报告，标注未达标项

9. **生成最终报告**
   - 文档审查报告
   - 脚本同步检查报告
   - Repo质量评估报告
   - 变更清单
   - 路径映射表
   - 验收报告

**验收标准**:
- [ ] `make doc_style_check`全部通过
- [ ] `make doc_route_check`全部通过
- [ ] `make doc_script_sync_check`全部通过（新增）
- [ ] 无临时文件残留
- [ ] 所有文档格式符合规范
- [ ] 所有链接和路径有效
- [ ] `make dev_check`全部通过
- [ ] Repo质量评估完成（新增）
- [ ] 最终审查报告生成

---

## 3. 关键改进点(草案)

### 3.1 目录结构调整
```text
添加/调整:
.
├── schemas/
│   └── agent.schema.yaml        # 新增
├── doc/
│   ├── orchestration/           # 新增目录
│   │   ├── registry.yaml       # 新增
│   │   └── routing.md          # 新增
│   ├── policies/                # 新增目录
│   │   ├── goals.md            # 新增
│   │   └── safety.md           # 新增
│   ├── indexes/                 # 新增目录
│   │   └── context-rules.md    # 新增
│   ├── init/                    # 新增目录
│   │   └── PROJECT_INIT_GUIDE.md  # 新增
│   └── modules/                 # 新增目录
│       └── MODULE_INIT_GUIDE.md   # 新增
└── modules/
    └── <module-entity>/
        ├── agent.md             # 新增(模块实例级)
        ├── README.md            # 已有
        ├── plan.md              # 已有
        └── doc/                 # 新增目录
            ├── CHANGELOG.md     # 从上级移入
            ├── CONTRACT.md      # 从上级移入
            ├── PROGRESS.md      # 从上级移入
            ├── BUGS.md          # 从上级移入
            ├── RUNBOOK.md       # 从上级移入
            └── TEST_PLAN.md     # 从上级移入
```

### 3.2 agent.md v2 规范(草案)
**结构**: YAML Front Matter + Markdown正文

**YAML最小必需字段**:
```yaml
---
spec_version: "1.0"
agent_id: "repo" 或 "modules.<entity>.<instance>"
role: "角色描述"
level: 1|2|3|4  # 模块层级
module_type: "类型路径"  # 如 "1_Assign/2_Select"
ownership:
  code_paths:
    include: ["可改动路径"]
    exclude: ["只读路径"]
io:
  inputs: [...]
  outputs: [...]
contracts:
  apis: [...]
dependencies:
  upstream: [...]
  downstream: [...]
constraints: [...]
tools_allowed:
  calls: [...]
quality_gates:
  required_tests: [...]
  coverage_min: 0.75
orchestration_hints:
  triggers: [...]
  routing_tags: [...]
context_routes:
  always_read: [...]
  on_demand: [...]
---
```

### 3.3 新增脚本（已实施）
**Phase 1-4完成**:
1. `scripts/agent_lint.py` - 校验agent.md YAML前言
2. `scripts/registry_check.py` - 校验registry.yaml
3. `scripts/doc_route_check.py` - 校验context_routes路径
4. `scripts/registry_gen.py` - 生成registry.yaml草案
5. `scripts/module_doc_gen.py` - 生成MODULE_INSTANCES.md
6. `scripts/type_contract_check.py` - 校验模块类型契约
7. `scripts/doc_script_sync_check.py` - 文档脚本双向检查
8. `scripts/validate.sh` - 聚合验证

**Phase 5完成**:
9. `scripts/db_lint.py` - 数据库文件校验

**Phase 6+计划**:
10. `scripts/fixture_loader.py` - Fixtures加载器（模块感知）
11. `scripts/mock_generator.py` - Mock数据生成器（可选）
12. `scripts/mock_lifecycle.py` - Mock生命周期管理（可选）
13. `scripts/db_env.py` - 数据库环境管理（可选）

### 3.4 Makefile新增命令（已实施+计划）
```makefile
# 已实施（Phase 1-5）
agent_lint:                # agent.md校验
registry_check:            # registry.yaml校验
doc_route_check:           # 文档路由校验
type_contract_check:       # 类型契约校验
doc_script_sync_check:     # 脚本同步检查
registry_gen:              # 生成registry.yaml草案
module_doc_gen:            # 生成MODULE_INSTANCES.md
validate:                  # 聚合验证（7个检查）
db_lint:                   # 数据库文件校验

# 计划（Phase 6-8）
load_fixture:              # 加载模块Fixtures
generate_mock:             # 生成Mock数据（可选）
cleanup_mock:              # 清理Mock数据（可选）
db_env:                    # 切换数据库环境（可选）
```

---

## 4. 风险与缓解

### 4.1 风险
1. **根agent.md拆分**可能导致引用缺失
2. **registry.yaml不完整**可能导致编排断链
3. **模块文档迁移**可能影响现有脚本
4. **首次改造工作量大**,可能影响项目进度

### 4.2 缓解措施
1. 保留根agent.md副本,可随时回滚
2. registry.yaml增量维护,先覆盖核心模块
3. 路径适配时保留兼容别名
4. 分阶段推进,每个阶段都可独立验证

---

## 5. 验收标准(草案)

### 5.1 Repo级
- [x] 根agent.md轻量(≤500行) - 256行 ✅
- [x] 根agent.md包含§1.3"应用层与模块层职责边界" - 已删除，迁移到roles.md ✅
- [x] 根README.md顶部有"编排系统请读agent.md"声明 ✅
- [x] schemas/agent.schema.yaml存在且字段完整 ✅
- [x] doc/orchestration/registry.yaml列举所有模块 ✅
- [x] doc/modules/MODULE_TYPES.md存在 ✅
- [x] doc/modules/MODULE_INSTANCES.md可生成 ✅
- [x] docs/已改名为doc/ ✅
- [x] flows/已移动到doc/flows/ ✅
- [x] db/目录结构建立 ✅（Phase 5完成）
- [x] **db/engines/postgres/migrations/已迁移** ✅（Phase 5完成）
- [x] **db/engines/postgres/docs/已迁移** ✅（Phase 5完成）
- [x] **db/engines/postgres/schemas/tables/有示例YAML** ✅（Phase 5完成）
- [ ] CI成功跑通所有校验
- [x] 路由指向的文档均存在 ✅

### 5.2 模块级
- [x] 示例模块存在agent.md/README.md/plan.md/doc/* ✅（Phase 4完成，移至doc/modules/example/）
- [x] 示例模块有core/子目录（必需） ✅
- [x] 示例模块的api/frontend/根据需要创建 ✅
- [x] README.md有"目录结构"章节说明 ✅
- [x] doc/CONTRACT.md区分API和前端组件说明 ✅
- [x] agent.md的ownership.code_paths和tools_allowed合理 ✅
- [x] 模块在registry.yaml中注册 ✅（作为reference_modules）
- [x] **模块包含测试数据定义（test_data路由）** ✅（Phase 6完成，example已配置）
- [x] **模块有TEST_DATA.md规格文档** ✅（Phase 6完成，example有完整示例）
- [x] **模块有fixtures/目录结构** ✅（Phase 6完成，example有完整示例）

### 5.3 文档级
- [ ] 所有文档格式符合规范(无颜文字、语言一致、结构化)
- [ ] 所有代码块正确标记语言
- [ ] 所有路径索引和路由正确
- [ ] 无临时文件残留
- [ ] 无无效或过时文档
- [ ] 所有文档内部链接有效

### 5.4 自动化级
- [x] `make agent_lint`通过 ✅
- [x] `make registry_check`通过 ✅
- [x] `make doc_route_check`通过 ✅
- [x] `make type_contract_check`通过 ✅（Phase 4完成）
- [x] `make doc_script_sync_check`通过 ✅（Phase 4完成）
- [x] `make module_doc_gen`可运行 ✅
- [x] `make db_lint`通过 ✅（Phase 5完成）
- [x] `make validate`可运行 ✅（Phase 4完成）
- [ ] `make load_fixture MODULE=example FIXTURE=minimal`可运行 （Phase 6-7计划）
- [ ] `make generate_mock MODULE=example TABLE=users COUNT=100`可运行 （Phase 7-8计划，可选）
- [ ] `make dev_check`全部通过

---

## 6. 当前状态更新(2025-11-07)

### 已完成
- [x] Phase 0: 调研与方案确认
- [x] Phase 1: Schema与基础设施
- [x] Phase 2: 目录结构调整
- [x] Phase 3: 根agent.md轻量化
- [x] Phase 4: 模块实例标准化
- [x] Phase 5: 数据库治理实施
- [x] Phase 6: 初始化规范完善（含Phase 6.5）
- [x] Phase 7: CI集成与测试数据工具

### Phase 5完成情况 ✅
1. ✅ 迁移migrations/到db/engines/postgres/migrations/
2. ✅ 迁移doc/db/到db/engines/postgres/docs/
3. ✅ 创建表结构YAML示例（runs.yaml）
4. ✅ 编写数据库校验脚本（db_lint.py）
5. ✅ Makefile新增db_lint命令
6. ✅ 测试半自动化流程
7. ✅ 更新所有路径引用
8. ✅ 创建完成报告和最终总结

### 用户已确认的决策
1. ✅ 模块文档迁移到doc/子目录
2. ✅ 根agent.md轻量化到≤500行
3. ✅ registry.yaml半自动化(自动生成+手动确认)
4. ✅ 初始化流程重点是大模型交互
5. ✅ YAML Schema以智能体编排需求为准,尽可能填写
6. ✅ **数据库半自动化操作**(类似registry.yaml方式)

### Phase 6完成情况 ✅
1. ✅ 更新PROJECT_INIT_GUIDE.md（增加AI对话范式，5组问题）
2. ✅ 更新MODULE_INIT_GUIDE.md（新增Phase 6和7）
3. ✅ Schema扩展：agent.schema.yaml添加test_data字段
4. ✅ 创建TEST_DATA.md.template模板（428行）
5. ✅ 更新example模块：添加测试数据示例
6. ✅ 更新scripts/agent_lint.py支持test_data字段
7. ✅ 更新scripts/module_doc_gen.py支持生成Mock规则
8. ✅ 更新scripts/ai_begin.sh以支持新结构
9. ✅ 测试模块初始化流程
10. ✅ 创建Phase 6报告和总结

### Phase 6.5完成情况 ✅（用户反馈优化）
1. ✅ 创建doc/process/DB_CHANGE_GUIDE.md（数据库变更流程，630行）
2. ✅ 修改MODULE_INIT_GUIDE.md Phase 6（标记可选，引导到独立流程）
3. ✅ 补充PROJECT_INIT_GUIDE.md（4种初始化方式）
   - 方式1: 有开发文档（文档驱动）
   - 方式2: 从零开始（AI对话式）
   - 方式3: 手动初始化（操作清单）
   - 方式4: 导入现有项目（项目迁移）
4. ✅ 更新plan.md模板（添加数据库/测试数据影响评估）
5. ✅ 更新agent.md（添加数据库变更路由）
6. ✅ 创建doc/init/MANUAL_INIT_CHECKLIST.md（手动初始化，470行）
7. ✅ 创建doc/init/PROJECT_MIGRATION_GUIDE.md（项目迁移，1063行）
8. ✅ 测试完整流程

### 待办
- [x] 用户审阅Phase 6 + 6.5成果 ✅
- [x] Phase 6/6.5遗留任务已梳理 ✅（见temp/Phase6_遗留任务清单.md）
- [x] Phase 7执行完成 ✅
- [x] Phase 8执行完成 ✅
- [x] Phase 8.5执行完成 ✅
- [ ] 开始Phase 9执行

### Phase 7完成情况 ✅
1. ✅ dev_check集成（整合15个检查命令）
2. ✅ 实现fixture_loader.py（480行，模块感知）
3. ✅ Makefile新增5个测试数据管理命令
4. ✅ 更新scripts/README.md（Phase 5和Phase 7章节）
5. ✅ 全面测试所有新增命令
6. ✅ 创建完成报告和最终总结

**Phase 6/6.5遗留任务处理结果**:
- ✅ **必须任务（已完成）**: fixture_loader.py、dev_check集成
- ⏸️ **建议任务（留待Phase 8.5）**: db_env.py、CI配置更新
- ⏸️ **可选任务（留待未来）**: mock_generator.py、mock_lifecycle.py、project_migrate.py、doc_parser.py

**详见**: `temp/Phase7_完成报告.md`, `temp/Phase7_最终总结.md`

---

### Phase 8完成情况 ✅
1. ✅ 文档路径全面更新（70+处）
2. ✅ 核心文档更新（README, QUICK_START, TEMPLATE_USAGE）
3. ✅ doc/目录文档更新（12+个）
4. ✅ scripts/脚本路径更新（4个）
5. ✅ 旧文件清理（docs_old_backup/, agent_new.md）
6. ✅ 文档结构修复（doc/flows/dag.yaml）
7. ✅ 完整性检查（make validate 7/7通过）
8. ✅ 创建完成报告和最终总结

**详见**: `temp/Phase8_完成报告.md`, `temp/Phase8_最终总结.md`

---

### Phase 8.5完成情况 ✅（中优先级遗留任务实施）
1. ✅ CI配置更新（.github/workflows/ci.yml, +15行，集成15+个检查）
2. ✅ fixture_loader数据库连接（+140行，支持实际SQL执行）
   - 添加psycopg2支持（可选依赖）
   - 实现get_db_config和connect_to_db函数
   - 3种配置方式、事务管理、智能降级
3. ✅ db_env.py环境管理工具（285行）
   - 环境识别显示、连接测试、多环境查看
4. ✅ .context/上下文恢复机制（规范+实施）
   - doc/process/CONTEXT_GUIDE.md（约600行）
   - example/.context/示例（完整）
   - MODULE_INIT_GUIDE.md新增Phase 8
   - ai_begin.sh自动创建.context/
   - .gitignore排除规则

**详见**: `temp/Phase8.5_完成报告.md`, `temp/Phase8.5_最终总结.md`

**遗留任务处理完成度**:
- ✅ 必须任务：全部完成（Phase 7）
- ✅ 建议任务：全部完成（Phase 8.5）
- ⏸️ 可选任务：留待未来按需实施

---

## 7. Phase 9详细说明：文档审查与清理流程

### 7.1 目标
确保升级完成后：
- 所有文档质量达标
- 无无效或过时文档
- 格式规范统一
- 路径引用正确
- 自动化链路通畅

### 7.2 审查清单

#### A. 文档完整性审查
```bash
# 1. 检查必需文档
- 根目录: agent.md, README.md, QUICK_START.md, TEMPLATE_USAGE.md, CONTRIBUTING.md
- doc/: orchestration/, policies/, indexes/, init/, modules/等子目录及文档
- modules/<entity>/: agent.md, README.md, plan.md, doc/（6个文档）

# 2. 检查文档间引用
- agent.md中的context_routes指向的文档存在
- README.md中链接的文档存在
- 各模块文档间的交叉引用有效

# 3. 验证命令
make consistency_check
make doc_route_check
```

#### B. 文档格式审查
```bash
# 1. 自动格式检查
make doc_style_check

# 检查项：
- [ ] 无颜文字（除代码示例外）
- [ ] 语言一致性（无中英文混用）
- [ ] 代码块标记语言
- [ ] 数学公式使用LaTeX格式
- [ ] 标题层级正确（无跳级）
- [ ] 无模糊表达
- [ ] 使用逻辑连接词和编号

# 2. 人工抽查
随机抽查3-5个文档，验证：
- 目标和上下文说明清晰
- 操作步骤使用分步结构
- 包含验证步骤（如适用）
- 包含回滚逻辑（如适用）
```

#### C. 无效文档识别与清理
```bash
# 1. 识别无效文档
过时文档标准：
- 指向不存在的路径或文件
- 描述已废弃的功能
- 与当前架构不符
- 标记为"待删除"或"已废弃"

# 2. 临时文件清理
make cleanup_tmp

# 3. 草案文件检查
查找所有.draft文件，确认是否已正式化：
find . -name "*.draft" -type f

# 4. 删除或归档
- 删除：确认无用的文档
- 归档：移动到docs/archived/（如需保留历史）
```

#### D. 路径引用全面验证
```bash
# 1. 运行路由检查
make doc_route_check

# 2. 检查Markdown链接
使用工具检查所有.md文件的内部链接：
- 相对路径链接
- 绝对路径链接
- 锚点链接

# 3. 检查代码中的路径引用
grep -r "docs/" --include="*.py" --include="*.md"
grep -r "flows/" --include="*.py" --include="*.md"
grep -r "migrations/" --include="*.py" --include="*.md"

# 4. 验证修复
确保所有路径引用已更新为新路径
```

#### E. 脚本双向同步检查（新增）⭐
```bash
# 1. 运行脚本同步检查
make doc_script_sync_check

# 或直接运行脚本：
python scripts/doc_script_sync_check.py

# 检查内容：
- [ ] 文档提及但脚本/命令不存在（缺失实现）
- [ ] 脚本存在但文档未提及（孤儿脚本）
- [ ] Makefile命令与实际脚本的映射关系
- [ ] 所有脚本在scripts/README.md中有说明

# 2. 处理发现的问题
对于缺失实现：
- 实现对应的脚本
- 或更新文档移除无效引用

对于孤儿脚本：
- 在文档中补充说明
- 或删除不再需要的脚本
- 确保scripts/README.md包含所有脚本

# 3. 再次验证
确保所有脚本与文档完全同步
```

#### F. 自动化链路测试
```bash
# 1. 运行完整dev_check
make dev_check

# 包含的检查：
- docgen（文档索引生成）
- doc_style_check（文档风格）
- dag_check（DAG校验）
- contract_compat_check（契约兼容性）
- deps_check（依赖检查）
- runtime_config_check（配置校验）
- migrate_check（迁移检查）
- consistency_check（一致性）
- frontend_types_check（前端类型）
- agent_lint（agent.md校验）
- registry_check（注册表校验）
- doc_route_check（文档路由）
- doc_script_sync_check（脚本同步）← 新增
- db_lint（数据库校验，如Phase 5完成）

# 2. 测试半自动化工具
make registry_gen          # 生成registry草案
make module_doc_gen        # 生成模块文档

# 如Phase 5完成：
make db_plan TARGET=dev    # 数据库迁移预览
make db_docgen             # 生成数据库文档

# 3. 验证生成的文档
检查自动生成的文档格式正确、内容完整
```

#### F. 文档内容质量审查
```bash
# 1. README.md审查
每个README.md应包含：
- [ ] 目标/概述
- [ ] 适用场景
- [ ] 前置条件（如适用）
- [ ] 快速开始/使用说明
- [ ] 目录结构说明（模块README）
- [ ] 相关文档链接

# 2. agent.md审查
每个agent.md应包含：
- [ ] YAML Front Matter（通过agent_lint校验）
- [ ] Summary章节
- [ ] Responsibilities章节
- [ ] Limitations章节
- [ ] I/O Examples
- [ ] context_routes路径正确

# 3. CONTRACT.md审查
每个CONTRACT.md应包含：
- [ ] API接口定义（如有）
- [ ] 前端组件说明（如有）
- [ ] 请求/响应格式
- [ ] 调用示例
- [ ] 错误码说明

# 4. 初始化文档审查
- [ ] PROJECT_INIT_GUIDE.md包含对话范式
- [ ] MODULE_INIT_GUIDE.md包含子目录创建规范
- [ ] MODULE_TYPES.md内容完整
- [ ] 模板文件（TEMPLATES/）齐全
```

#### G. 按标准评估Repo质量（新增）⭐
```bash
# 对照执行计划.md §5"验收标准(草案)"逐项检查

# 1. Repo级验收（11项）
- [ ] 根agent.md轻量(≤500行)
- [ ] 根agent.md包含§1.3"应用层与模块层职责边界"
- [ ] 根README.md顶部有"编排系统请读agent.md"声明
- [ ] schemas/agent.schema.yaml存在且字段完整
- [ ] doc/orchestration/registry.yaml列举所有模块
- [ ] doc/modules/MODULE_TYPES.md存在
- [ ] doc/modules/MODULE_INSTANCES.md可生成
- [ ] docs/已改名为doc/
- [ ] flows/已移动到doc/flows/
- [ ] db/目录结构建立
- [ ] CI成功跑通所有校验
- [ ] 路由指向的文档均存在

# 2. 模块级验收（7项）
- [ ] 示例模块存在agent.md/README.md/plan.md/doc/*
- [ ] 示例模块有core/子目录（必需）
- [ ] 示例模块的api/frontend/根据需要创建
- [ ] README.md有"目录结构"章节说明
- [ ] doc/CONTRACT.md区分API和前端组件说明
- [ ] agent.md的ownership.code_paths和tools_allowed合理
- [ ] 模块在registry.yaml中注册

# 3. 文档级验收（6项）
- [ ] 所有文档格式符合规范(无颜文字、语言一致、结构化)
- [ ] 所有代码块正确标记语言
- [ ] 所有路径索引和路由正确
- [ ] 无临时文件残留
- [ ] 无无效或过时文档
- [ ] 所有文档内部链接有效

# 4. 自动化级验收（6项）
- [ ] `make agent_lint`通过
- [ ] `make registry_check`通过
- [ ] `make doc_route_check`通过
- [ ] `make module_doc_gen`可运行
- [ ] `make db_lint`通过（如Phase 5完成）
- [ ] `make dev_check`全部通过

# 5. 生成评估报告
创建文件：temp/Phase9_Repo质量评估报告.md
内容包括：
- 各级验收结果（通过/未通过/部分通过）
- 未达标项详细说明
- 需要修复的问题清单
- 优化建议
```

#### H. 生成最终报告
```bash
# 1. 变更清单
记录所有Phase的变更：
- 新增文件列表
- 修改文件列表
- 删除文件列表
- 重命名/移动文件映射表

# 2. 路径映射表
生成完整的旧路径→新路径映射表：
docs/ → doc/
flows/ → doc/flows/
migrations/ → db/engines/postgres/migrations/
docs/db/ → db/engines/postgres/docs/
modules/<entity>/CONTRACT.md → modules/<entity>/doc/CONTRACT.md

# 3. 验收报告
- Repo级验收结果
- 模块级验收结果
- 文档级验收结果
- 自动化级验收结果

# 4. 问题汇总（如有）
- 待解决问题
- 遗留优化项
- 建议改进点
```

### 7.3 清理脚本（可选）

可以创建一个专门的清理检查脚本：

```python
# scripts/final_cleanup_check.py
功能：
1. 扫描所有文档文件
2. 检查格式规范
3. 识别无效引用
4. 生成清理建议报告
```

### 7.4 Phase 9执行时间
预计：2-3天

**子任务时间分配**:
- 文档完整性和格式审查: 0.5天
- 无效文档识别和清理: 0.5天
- 路径引用全面验证: 0.5天
- 自动化链路测试: 0.5天
- 文档内容质量审查: 0.5天
- 生成最终报告: 0.5天

### 7.5 Phase 9验收标准
- [ ] `make doc_style_check`通过
- [ ] `make doc_route_check`通过
- [ ] `make doc_script_sync_check`通过（新增）
- [ ] `make consistency_check`通过
- [ ] `make dev_check`全部通过
- [ ] 无临时文件（`make cleanup_tmp`清理后）
- [ ] 无.draft文件残留
- [ ] 路径映射表完整
- [ ] Repo质量评估报告生成（新增）
- [ ] 脚本同步检查报告生成（新增）
- [ ] 最终验收报告生成
- [ ] 所有文档质量达标
- [ ] 所有验收标准（§5）达标或有改进计划

---

## 8. 总体时间预估（更新）

| Phase | 任务 | 预估时间 | 状态 |
|-------|------|---------|------|
| Phase 0 | 调研与方案确认 | - | ✅ 完成 |
| Phase 1 | Schema与基础设施 | 4-6天 | ✅ 完成 |
| Phase 2 | 目录结构调整 | 6-8天 | ✅ 完成 |
| Phase 3 | 根agent.md轻量化与目录改名 | 4-6天 | ✅ 完成 |
| Phase 4 | 模块实例标准化 | 4-6天 | ✅ 完成 |
| Phase 5 | 数据库治理实施 | 5-7天 | ✅ 完成 |
| Phase 6 | 初始化规范完善 | 2-3天 | ✅ 完成 |
| Phase 6.5 | 触发机制与迁移完善（用户反馈） | 2天 | ✅ 完成 |
| Phase 7 | CI集成与测试数据工具 | 2-3天 | ✅ 完成 |
| Phase 8 | 文档更新与高级功能 | 2-3天 | ✅ 完成 |
| Phase 8.5 | 中优先级遗留任务实施 | 1-2天 | ✅ 完成 |
| Phase 9 | 文档审查与清理 | 2-3天 | 待执行 |

**总计**: 35-51天
**实际已用**: 约1-2天（实际执行非常快）
**总体进度**: 95%（9.5/10 Phase完成）

---

## 9. 变更历史
- 2025-11-07: 创建执行计划草案
- 2025-11-07: Phase 1执行完成
- 2025-11-07: 新增Phase 9"文档审查与清理流程"
- 2025-11-07: Phase 9增加两个环节：脚本双向同步检查、按标准评估Repo质量
- 2025-11-07: Phase 5执行完成（数据库治理实施）
- 2025-11-07: Phase 5扩展讨论后更新Phase 6-8子任务
  - Phase 6增加测试数据管理基础（4个子任务）
  - Phase 7增加Fixtures管理工具实施
  - Phase 8增加Mock生成器实施（可选）
  - 更新验收标准，标记已完成项
- 2025-11-07: 为所有Phase添加"必读文档"说明
  - Phase 1-9均添加"必读文档（开始前）"章节
  - 明确每个Phase开始前应该阅读的文档
  - 确保上下文连续性和方案理解
- 2025-11-07: Phase 6执行完成（初始化规范完善）
  - 10个子任务全部完成
  - 新增8个文件，修改6个文件，约1200行
  - AI对话式引导体系、测试数据管理基础、工具链完善
- 2025-11-07: Phase 6.5执行完成（用户反馈优化）
  - 8个子任务全部完成
  - 新增5个文件，修改4个文件，约3300行
  - 数据库变更动态触发机制、4种初始化方式完整实现
  - 解决用户反馈的两个关键问题
- 2025-11-07: Phase 7执行完成（CI集成与测试数据工具）
  - 必须任务5/5全部完成（dev_check集成、fixture_loader.py）
  - 新增3个文件，修改2个文件，约1200行
  - dev_check从9个检查扩展到15个检查
  - 实现fixture_loader.py（480行，模块感知的Fixtures加载工具）
  - Makefile新增5个测试数据管理命令
  - 完成Phase 6/6.5的2个必须遗留任务
  - 总体进度达到80%（8/10 Phase完成）

- 2025-11-08: Phase 8执行完成（文档更新与高级功能实施）
  - 文档路径全面更新（70+处）：docs/→doc/, flows/→doc/flows/, migrations/→db/engines/postgres/migrations/
  - 核心文档更新（README.md, QUICK_START.md, TEMPLATE_USAGE.md）
  - doc/目录文档更新（12+个）
  - scripts/脚本更新（4个）
  - 旧文件清理（docs_old_backup/, agent_new.md）
  - 文档结构修复（doc/flows/dag.yaml）
  - make validate 7/7检查全部通过
  - 修改文件20+个，新增3个，删除2个
  - 总体进度达到90%（9/10 Phase完成）

- 2025-11-08: Phase 8.5执行完成（中优先级遗留任务实施+.context/机制）
  - CI配置更新：.github/workflows/ci.yml集成15+个检查
  - fixture_loader数据库连接：支持实际SQL执行（+140行）
  - db_env.py环境管理工具：完整实现（285行）
  - .context/上下文恢复机制：规范和实施
    - doc/process/CONTEXT_GUIDE.md（约600行）
    - example/.context/示例（完整）
    - MODULE_INIT_GUIDE.md新增Phase 8（上下文恢复）
    - ai_begin.sh自动创建.context/目录
    - .gitignore排除规则
  - 新增文件约1200行，修改文件11个
  - 完成所有建议任务
  - 总体进度达到95%（9.5/10 Phase完成）


