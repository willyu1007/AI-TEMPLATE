# AI-TEMPLATE Repo 最终方案整合

> **状态**: 最终整合版，包含所有5个问题的调整
> **创建日期**: 2025-11-07
> **版本**: v2.0

---

## 0. 整合说明

本文档整合了用户提出的5个问题的解决方案，是对`修改方案(正式版).md`的补充和完善。

---

## 1. 五个问题与解决方案汇总

### 问题1: 模块类型和实例的文档维护 ✅
**解决方案**: 新增两个文档
- `doc/modules/MODULE_TYPES.md` - 模块类型说明（手动维护）
  - 模块分级概念（1-4级）
  - 各类型定义、职责、I/O标准
  - 类型间包含关系（树状结构）
  - 同类型模块可替换性
  
- `doc/modules/MODULE_INSTANCES.md` - 模块实例目录（自动生成）
  - 所有实例索引和简介
  - 从registry.yaml自动生成
  - 命令：`make module_doc_gen`

**新增脚本**: `scripts/module_doc_gen.py`

### 问题2: 根目录整洁方案 ✅
**解决方案**: 目录整合
```
docs/ → doc/          (统一命名)
flows/ → doc/flows/   (流程图归入文档)
migrations/ → db/engines/postgres/migrations/  (Phase 5)

最终根目录：9个文件 + 12个目录
文件: agent.md, README.md, QUICK_START.md, TEMPLATE_USAGE.md, 
      CONTRIBUTING.md, LICENSE, Makefile, requirements.txt, docker-compose.yml

目录: ai/, common/, config/, doc/, db/, evals/, modules/,
      observability/, schemas/, scripts/, tests/, tools/
```

### 问题3: 模块实例内部结构 ✅
**解决方案**: 标准结构+文档记录
```
modules/<entity>/
├── agent.md, README.md, plan.md
├── doc/              (6个文档)
├── core/             (必需-核心业务逻辑)
├── api/              (可选-如提供HTTP接口)
├── frontend/         (可选-如有UI页面/组件)
├── models/           (可选-如有数据模型)
└── utils/            (可选-模块工具函数)
```

**文档记录**:
- README.md: 必须有"目录结构"章节，说明各子目录职责
- doc/CONTRACT.md: API接口定义 + 前端组件说明

### 问题4: schemas与scripts关系 ✅
**解决方案**: 不重复，互补
- `schemas/` = Schema定义（规范）
- `scripts/` = 校验脚本（实现，使用schemas/）
- `tools/` = 工具契约（保持不变）
- **不直接复制Enhancement-Pack，参考后自行实现**

### 问题5: app/frontend与modules的职责划分 ✅
**解决方案**: 明确边界
```
根目录app/frontend/ = 应用层
    - 入口、路由分发、全局中间件、通用组件
    - 不含业务逻辑

modules/<entity>/api/frontend/ = 模块层
    - 模块特定的业务实现
    - 包含该模块的具体功能

调用关系:
app/ → modules/<entity>/api/ → modules/<entity>/core/
frontend/ → modules/<entity>/frontend/ → API调用
```

**判断标准**:
- 模块需要api/？→ 对外提供HTTP接口？→ 是→创建，否→不创建
- 模块需要frontend/？→ 有特定UI页面/组件？→ 是→创建，否→不创建

---

## 2. 新增文档清单

### 2.1 doc/modules/下新增
1. `MODULE_TYPES.md` - 模块类型说明文档（新增）
2. `MODULE_INSTANCES.md` - 模块实例目录（自动生成）
3. `MODULE_INIT_GUIDE.md` - 模块初始化规范（已规划，需补充内容）

### 2.2 doc/init/下新增
1. `PROJECT_INIT_GUIDE.md` - 项目初始化规范（已规划，需补充内容）

### 2.3 temp/下已创建
1. `阅读笔记.md` - 对repo和需求的理解
2. `用户反馈记录.md` - 用户决策记录
3. `修改方案(初稿).md` - 初步方案
4. `修改方案(正式版).md` - 完整方案（已更新）
5. `执行计划.md` - 分阶段执行计划
6. `方案调整说明.md` - 4个问题的调整方案（已更新为5个）
7. `app_frontend_职责划分说明.md` - app/frontend职责详解

---

## 3. 新增脚本清单

### 3.1 agent.md相关（Phase 1）
1. `scripts/agent_lint.py` - 校验agent.md YAML前言
2. `scripts/registry_check.py` - 校验registry.yaml
3. `scripts/doc_route_check.py` - 校验context_routes路径
4. `scripts/registry_gen.py` - 半自动生成registry.yaml草案
5. `scripts/module_doc_gen.py` - 从registry.yaml生成MODULE_INSTANCES.md

### 3.2 数据库相关（Phase 5）
1. `scripts/db_spec_align_check.py` - 迁移与文档同步检查
2. `scripts/docgen_db.py` - 汇总表YAML生成SCHEMA_CATALOG.md
3. `scripts/db_plan.py` - 生成迁移计划（可选）
4. `scripts/db_apply.py` - 执行迁移并同步文档（可选）

---

## 4. 新增Makefile命令清单

### 4.1 agent.md相关
```makefile
agent_lint:           # 校验agent.md YAML前言
registry_check:       # 校验registry.yaml
doc_route_check:      # 校验文档路由
registry_gen:         # 半自动生成registry.yaml草案
module_doc_gen:       # 从registry.yaml生成MODULE_INSTANCES.md
```

### 4.2 数据库相关
```makefile
db_plan:              # 预览迁移计划
db_apply:             # 执行迁移（半自动）
db_docgen:            # 生成SCHEMA_CATALOG.md
db_lint:              # 聚合migrate_check + db_spec_align_check
```

### 4.3 更新dev_check
```makefile
dev_check: docgen doc_style_check dag_check contract_compat_check \
           deps_check runtime_config_check migrate_check consistency_check \
           frontend_types_check agent_lint registry_check doc_route_check \
           db_lint
```

---

## 5. Phase详细调整

### Phase 1: Schema与基础设施（4-6天）
**新增任务**:
- 编写5个脚本（agent_lint, registry_check, doc_route_check, registry_gen, module_doc_gen）
- 参考Enhancement-Pack，但不直接复制，根据当前repo调整
- Makefile新增5个命令

### Phase 2: 目录结构调整（6-8天）
**新增任务**:
- 创建MODULE_TYPES.md（模块类型说明）
- 在PROJECT_INIT_GUIDE.md中增加应用层结构选择章节
- 在MODULE_INIT_GUIDE.md中增加模块子目录创建规范、职责边界检查章节
- 参考Enhancement-Pack创建文档，但需调整内容以匹配当前repo

### Phase 3: 根agent.md轻量化与目录改名（4-6天）
**新增任务**:
- 在根agent.md §1中增加§1.3"应用层与模块层的职责边界"
- 改名docs/ → doc/（更新所有引用）
- 移动flows/ → doc/flows/（更新所有引用）

### Phase 4: 模块实例标准化（4-6天）
**新增任务**:
- 创建modules/example/core/子目录（必需）
- 根据example特性决定是否创建api/和frontend/
- 在modules/example/README.md中增加"目录结构"章节
- 在modules/example/doc/CONTRACT.md中区分API接口和前端组件说明

### Phase 5-8: 保持原计划

---

## 6. 根agent.md内容调整

### 6.1 需要增加的章节
**§1.3 应用层与模块层的职责边界**（新增）
```markdown
### 1.3 应用层与模块层的职责边界

#### 职责划分总则
- 根目录app/或frontend/: 应用入口、路由分发、全局中间件、通用组件
- modules/<entity>/api/或frontend/: 模块特定的业务实现、业务组件
- 调用关系: app/ → modules/<entity>/api/ → modules/<entity>/core/

#### 代码放置决策
（详见temp/app_frontend_职责划分说明.md第3节）

#### 典型目录对照
| 根目录 | 模块目录 | 职责区别 |
|--------|---------|---------|
| app/routes/ | modules/<entity>/api/routes.py | 分发 vs 实现 |
| frontend/components/ | modules/<entity>/frontend/components/ | 通用 vs 业务 |
| app/middleware/ | modules/<entity>/api/middleware/ | 全局 vs 模块 |
```

### 6.2 轻量化后的根agent.md结构（≤500行）
```markdown
# agent.md

> YAML Front Matter（50-100行）
---
spec_version: "1.0"
agent_id: "repo"
...
---

## 重要提醒（20行）
必读规范和链接

## 0. 快速开始（50行）
S0-S6工作流程摘要

## 1. 目录规范（80行）
核心目录树 + 路由指引
§1.1 后端应用层规则（保留）
§1.2 前端应用层规则（保留）
§1.3 应用层与模块层职责边界（新增）

## 2. 角色与门禁（20行）
简要说明+链接到doc/policies/goals.md

## 3-9. 各专项章节（100行）
保留摘要和路由，详细内容链接到doc/下

## 12. 命令与脚本（80行）
核心命令列表（保留）

## 13. 临时文件管理规范（80行）
重要规范（保留）

## 13.1 文档编写规范（30行）
核心要点+链接到doc/policies/safety.md

## 14. AI自动维护（30行）
自动化说明（保留）

## 15. 参考与链接（30行）
路由索引（保留）

总计约500行
```

---

## 7. 更新后的Phase计划

### Phase 0: 调研与方案确认（已完成）
- [x] 所有调研和方案准备工作
- [x] 用户反馈收集和5个问题解决
- [ ] 最终确认

### Phase 1: Schema与基础设施（4-6天）
**关键变更**:
- 编写5个脚本（不直接复制）
- schemas/agent.schema.yaml
- Makefile新增5个命令

### Phase 2: 目录结构调整（6-8天）
**关键变更**:
- 创建doc/子目录
- 创建MODULE_TYPES.md和MODULE_INSTANCES.md
- 在初始化规范中增加app/frontend和模块子目录的说明
- 创建db/目录结构

### Phase 3: 根agent.md轻量化与目录改名（4-6天）
**关键变更**:
- 迁移根agent.md内容到≤500行
- 增加§1.3职责边界章节
- docs/ → doc/
- flows/ → doc/flows/
- 根README.md顶部声明

### Phase 4: 模块实例标准化（4-6天）
**关键变更**:
- modules/example/补齐agent.md和doc/
- 创建core/子目录（必需）
- 根据需要创建api/和frontend/
- README.md增加"目录结构"章节

### Phase 5: 数据库治理实施（5-7天）
- 数据库半自动化
- db/目录结构和迁移

### Phase 6: 初始化规范完善（2-3天）
- 完善初始化文档

### Phase 7: CI集成与测试（2-3天）
- CI集成三校验

### Phase 8: 文档更新与收尾（2-3天）
- 路径引用更新

**总工作量**: 27-39天（原15-25天，增加了更多细化内容）

---

## 8. 关键文件修改清单

### 8.1 根agent.md修改点
1. 补齐YAML Front Matter
2. §1增加§1.3"应用层与模块层的职责边界"
3. 迁移详细内容到doc/，保留摘要和路由
4. 更新所有路径引用（docs/→doc/, flows/→doc/flows/）
5. 轻量化到≤500行

### 8.2 根README.md修改点
1. 顶部增加声明"编排系统请读agent.md"
2. 更新目录结构图（新增schemas/, doc/, db/）
3. 更新路径引用

### 8.3 modules/example/修改点
1. 新增agent.md（YAML+MD）
2. 创建doc/子目录，迁移6个文档
3. 创建core/子目录
4. 根据需要创建api/和frontend/
5. README.md增加"目录结构"章节
6. doc/CONTRACT.md区分API和前端组件

### 8.4 doc/新增文档
1. orchestration/registry.yaml, routing.md
2. policies/goals.md, safety.md
3. indexes/context-rules.md
4. init/PROJECT_INIT_GUIDE.md（含应用层结构选择）
5. modules/MODULE_INIT_GUIDE.md（含模块子目录创建规范）
6. modules/MODULE_TYPES.md
7. modules/TEMPLATES/（各种模板）

---

## 9. 大模型行为规范更新

### 9.1 项目初始化时
大模型应该询问：
1. "您的项目是单一应用入口还是多入口？"
   - 单一 → 创建app/和frontend/
   - 多入口 → 创建apps/和frontends/
   - 无需应用层 → 不创建

2. 说明app/或frontend/的职责：
   - 应用入口、路由分发、全局中间件
   - 不包含业务逻辑（在modules/中）

### 9.2 模块初始化时
大模型应该询问：
1. "该模块属于哪个类型？"（参考MODULE_TYPES.md）
2. "该模块是否对外提供HTTP接口？" → 决定是否创建api/
3. "该模块是否有特定的前端页面或组件？" → 决定是否创建frontend/
4. "该模块是否有数据模型？" → 决定是否创建models/

然后：
1. 创建modules/<entity>/基本结构（agent.md, README.md, plan.md, doc/）
2. 创建core/（必需）
3. 根据回答创建api/, frontend/, models/（可选）
4. 在README.md中增加"目录结构"章节
5. 在doc/CONTRACT.md中区分API和前端组件说明
6. 更新registry.yaml

### 9.3 模块开发时
大模型应该检查：
1. app/routes/中不应有业务逻辑 → 应在modules/<entity>/core/
2. frontend/components/中不应有业务逻辑 → 应在modules/<entity>/frontend/
3. modules/<entity>/api/应调用core/，不直接操作数据库

---

## 10. 验收标准（完整版）

### 10.1 Repo级
- [ ] 根agent.md≤500行
- [ ] 根agent.md §1.3"应用层与模块层职责边界"章节存在
- [ ] 根README.md顶部有"编排系统请读agent.md"声明
- [ ] schemas/agent.schema.yaml存在
- [ ] doc/orchestration/registry.yaml列举所有模块
- [ ] doc/modules/MODULE_TYPES.md存在
- [ ] doc/modules/MODULE_INSTANCES.md可生成
- [ ] docs/已改名为doc/
- [ ] flows/已移动到doc/flows/
- [ ] db/目录结构建立
- [ ] `make agent_lint`通过
- [ ] `make registry_check`通过
- [ ] `make doc_route_check`通过
- [ ] `make module_doc_gen`可运行
- [ ] `make db_lint`通过
- [ ] `make dev_check`全部通过

### 10.2 模块级（以example为例）
- [ ] modules/example/agent.md存在（YAML+MD）
- [ ] modules/example/README.md包含"目录结构"章节，说明各子目录职责
- [ ] modules/example/plan.md存在
- [ ] modules/example/doc/下6个文档齐全
- [ ] modules/example/core/存在（必需）
- [ ] modules/example/api/和frontend/根据实际需要创建
- [ ] modules/example/doc/CONTRACT.md区分API接口和前端组件说明（如有）
- [ ] agent.md的ownership.code_paths合理
- [ ] agent.md的context_routes路径存在
- [ ] 在registry.yaml中注册

### 10.3 数据库级
- [ ] db/engines/postgres/migrations/下有迁移脚本
- [ ] db/engines/postgres/schemas/tables/下有核心表YAML
- [ ] db/engines/postgres/docs/SCHEMA_CATALOG.md可生成
- [ ] `make db_plan`可预览
- [ ] `make db_apply DRY_RUN=1`可运行
- [ ] `make db_docgen`可生成文档
- [ ] `make db_lint`通过

### 10.4 文档级
- [ ] 所有文档格式符合规范
- [ ] 所有代码块正确标记语言
- [ ] 所有路径引用正确
- [ ] 无临时文件残留
- [ ] 路径迁移映射表完整

---

## 11. 实施顺序确认

```
Phase 0: 调研与方案确认 ✅（已完成，待最终确认）
    ↓
Phase 1: Schema与基础设施（4-6天）
    - 创建schemas/agent.schema.yaml
    - 编写5个脚本
    - Makefile新增命令
    ↓
Phase 2: 目录结构调整（6-8天）
    - 创建doc/和db/子目录
    - 创建MODULE_TYPES.md等文档
    - 完善初始化规范
    ↓
Phase 3: 根agent.md轻量化与目录改名（4-6天）
    - 迁移根agent.md内容
    - 增加§1.3职责边界
    - docs/→doc/, flows/→doc/flows/
    ↓
Phase 4: 模块实例标准化（4-6天）
    - example模块补齐结构
    - 创建core/和可选的api/frontend/
    - 完善文档
    ↓
Phase 5: 数据库治理实施（5-7天）
    - db/目录和半自动化
    ↓
Phase 6: 初始化规范完善（2-3天）
    ↓
Phase 7: CI集成与测试（2-3天）
    ↓
Phase 8: 文档更新与收尾（2-3天）

总计：27-39天
```

---

## 12. 待用户确认事项

请确认以下内容：

### 12.1 整体方案
- [ ] 5个问题的解决方案是否满意？
- [ ] Phase划分是否合理？
- [ ] 工作量预估（27-39天）是否可接受？

### 12.2 关键设计
- [ ] 模块实例标准结构（core/必需，api/frontend/可选）
- [ ] app/frontend职责划分（应用层vs模块层）
- [ ] 根目录整洁方案（docs/→doc/, flows/→doc/flows/）
- [ ] MODULE_TYPES.md手动维护，MODULE_INSTANCES.md自动生成

### 12.3 实施策略
- [ ] 不直接复制Enhancement-Pack，参考后自行实现
- [ ] 半自动化策略（registry.yaml, db操作）
- [ ] 分阶段推进，每阶段可独立验证

### 12.4 其他
- [ ] 是否还有其他需要补充或调整的地方？
- [ ] 是否可以开始Phase 1执行？

---

## 附录：文档引用索引

| 文档 | 内容 | 行数 |
|------|------|------|
| 阅读笔记.md | repo和需求分析 | 369 |
| 用户反馈记录.md | 6个决策记录 | ~100 |
| 修改方案(正式版).md | 完整方案 | 870+ |
| 执行计划.md | Phase划分 | 270 |
| 方案调整说明.md | 5个问题解决方案 | 505 |
| app_frontend_职责划分说明.md | app/frontend职责详解 | 753 |
| 最终方案整合.md | 本文档，整合版 | - |

---

**准备就绪，等待用户最终确认！**


